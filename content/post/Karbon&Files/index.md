---
title: Nutanix Karbon&Files
description: Nutanix Karbon & Files
slug: Karbon&Files
date: 2023-09-23T02:46:09+08:00
categories:
    - Lab Category
tags:
    - Nutanix
    - Karbon
    - Kubernetes
weight: 1       # You can add weight to some posts to override the default sorting (date descending)
---
# Karbon、Files

測試安裝Nutanix 內建的Kubernetes，並使用內建的Storage儲存空間(NFS、Volume)

## Linux主機安裝設定(測試用)

(測試功能又不佔用ip才需要此Linux主機)

### 安裝一台CentOS-Stream9

IP: 172.16.90.205 , 192.168.1.1
Host: bastion.netfos.ken.lab

此VM作用為 Router, NAT, DHCP, DNS,Web等等

PE Network設定,新增192.168.1.1的subnet並綁到vSwitch上 (啟動IPAM)

![image-20230111135752295](https://kenkenny.synology.me:5543/images/2023/09/image-20230111135752295.png)

1. upload iso to Prism Element

2. on Prism Central import iso

3. create VM on Prism Central
   ![image-20230111114303181](https://kenkenny.synology.me:5543/images/2023/09/image-20230111114303181.png)

   

4. 安裝OS

### 設定Router & NAT

https://linux.vbird.org/linux_server/centos6/0230router.php

1. 啟動Linux Kernal 的 ip_forwarder功能

   ```
   [ken@bastion ~]$ sudo vim /etc/sysctl.conf 
   
   net.ipv4.ip_forward = 1
   
   [ken@bastion ~]$ sudo sysctl -p
   net.ipv4.ip_forward = 1     
   [ken@bastion ~]$ sudo cat /proc/sys/net/ipv4/ip_forward
   1
   ```

2. NAT設定

   ```
   [ken@bastion ~]$ sudo iptables -A INPUT -i ens4 -j ACCEPT
   [ken@bastion ~]$ sudo iptables -A INPUT -i lo -j ACCEPT
   
   [ken@bastion ~]$ sudo iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -j MASQUERADE
   
   
   [ken@bastion ~]$ sudo iptables -L
   Chain INPUT (policy ACCEPT)
   target     prot opt source               destination         
   ACCEPT     all  --  anywhere             anywhere            
   
   Chain FORWARD (policy ACCEPT)
   target     prot opt source               destination         
   
   Chain OUTPUT (policy ACCEPT)
   target     prot opt source               destination 
   
   [ken@bastion ~]$ sudo iptables-save
   # Generated by iptables-save v1.8.8 (nf_tables) on Wed Jan 11 12:06:10 2023
   *filter
   :INPUT ACCEPT [0:0]
   :FORWARD ACCEPT [0:0]
   :OUTPUT ACCEPT [0:0]
   -A INPUT -i ens4 -j ACCEPT
   COMMIT
   # Completed on Wed Jan 11 12:06:10 2023
   # Generated by iptables-save v1.8.8 (nf_tables) on Wed Jan 11 12:06:10 2023
   *nat
   :PREROUTING ACCEPT [0:0]
   :INPUT ACCEPT [0:0]
   :OUTPUT ACCEPT [0:0]
   :POSTROUTING ACCEPT [0:0]
   -A POSTROUTING -s 192.168.1.0/24 -j MASQUERADE
   COMMIT
   # Completed on Wed Jan 11 12:06:10 2023
   
   關閉防火牆
   sudo systemctl disable firewalld --now
   ```

2. DNAT設定
   https://portal.nutanix.com/page/documents/details?targetId=Port-Reference:NKE_Airgap_port_auto_r.html
   https://portal.nutanix.com/page/documents/details?targetId=Port-Reference:Nutanix_Kubernetes_Engine_port_auto_r.html
   
   ```
   ## For NKE Registry
   sudo iptables -t nat -A PREROUTING -i ens3 -p tcp --dport 22 \
        -j DNAT --to-destination 192.168.1.5:22
        
   sudo iptables -t nat -A PREROUTING -i ens3 -p tcp --dport 5000 \
        -j DNAT --to-destination 192.168.1.5:5000
        
   sudo iptables-save
        
   ## For NKE Loadbalnacer
   sudo iptables -t nat -A PREROUTING -i ens3 -p tcp --dport 443 \
        -j DNAT --to-destination 192.168.1.10:22
   sudo iptables -t nat -A PREROUTING -i ens3 -p tcp --dport 2379 \
        -j DNAT --to-destination 192.168.1.10:2379
   sudo iptables -t nat -A PREROUTING -i ens3 -p tcp --dport 30001 \
        -j DNAT --to-destination 192.168.1.10:30001
   sudo iptables -t nat -A PREROUTING -i ens3 -p tcp --dport 30000:32767 \
        -j DNAT --to-destination 192.168.1.10:30000-32767
   sudo iptables-save
   ```
   
   
   
3. 拿一台測試VM確認可ping 通
   ![image-20230111135706837](https://kenkenny.synology.me:5543/images/2023/09/image-20230111135706837.png)



### 安裝DNS Server (named)

1. 安裝named 

   ```
   [ken@bastion ~]$ sudo yum install bind bind-libs bind-chroot bind-utils
   [sudo] password for ken: 
   ```

2. 修改named 設定檔 /etc/named.conf

   ```
   [root@bastion data]# cat /etc/named.conf 
   //
   // named.conf
   //
   // Provided by Red Hat bind package to configure the ISC BIND named(8) DNS
   // server as a caching only nameserver (as a localhost DNS resolver only).
   //
   // See /usr/share/doc/bind*/sample/ for example named configuration files.
   //
   
   options {
   	listen-on port 53 { 192.168.1.1; };
   	//listen-on-v6 port 53 { ::1; };
   	directory 	"/var/named";
   	dump-file 	"/var/named/data/cache_dump.db";
   	statistics-file "/var/named/data/named_stats.txt";
   	memstatistics-file "/var/named/data/named_mem_stats.txt";
   	secroots-file	"/var/named/data/named.secroots";
   	recursing-file	"/var/named/data/named.recursing";
   	allow-query     { any; };
   	## 設定轉寄站
   	forwarders {
           192.168.102.1;
           192.168.102.2;
      };
   
   	/* 
   	 - If you are building an AUTHORITATIVE DNS server, do NOT enable recursion.
   	 - If you are building a RECURSIVE (caching) DNS server, you need to enable 
   	   recursion. 
   	 - If your recursive DNS server has a public IP address, you MUST enable access 
   	   control to limit queries to your legitimate users. Failing to do so will
   	   cause your server to become part of large scale DNS amplification 
   	   attacks. Implementing BCP38 within your network would greatly
   	   reduce such attack surface 
   	*/
   	recursion yes;
   
   	dnssec-validation no;
           dnssec-enable yes;
   
   	managed-keys-directory "/var/named/dynamic";
   	geoip-directory "/usr/share/GeoIP";
   
   	pid-file "/run/named/named.pid";
   	session-keyfile "/run/named/session.key";
   
   	/* https://fedoraproject.org/wiki/Changes/CryptoPolicy */
   	include "/etc/crypto-policies/back-ends/bind.config";
   };
   
   logging {
           channel default_debug {
                   file "data/named.run";
                   severity dynamic;
           };
   };
   
   zone "." IN {
   	type hint;
   	file "named.ca";
   };
   
   include "/etc/named.rfc1912.zones";
   include "/etc/named.root.key";
   zone "netfos.ken.lab" IN {
           type master;
           file "ken.zone";
           allow-update { none; };
           allow-query { any; };
           allow-transfer { none; };
   };
   zone "1.168.192.in-addr.arpa" IN {
                   type master;
                   file "ken.reverse";
                   allow-update { none; };
                   allow-query { any; };
                   allow-transfer { none; };
   };
   ```

3. 修改正向解析 /var/named/ken.zone

   ```
   [root@bastion named]# cat ken.zone 
   $TTL 1W
   @	IN	SOA	bastion.netfos.ken.lab.	root (
   			2019070700	; serial
   			3H		; refresh (3 hours)
   			30M		; retry (30 minutes)
   			2W		; expiry (2 weeks)
   			1W )		; minimum (1 week)
   	IN	NS	bastion.netfos.ken.lab.
   ;
   bastion.netfos.ken.lab.	IN	A	192.168.1.1
   ;
   ;EOF
   ```

4. 修改反解析 /var/named/ken.reverse

   ```
   [root@bastion named]# cat ken.reverse 
   $TTL 10
   @	IN	SOA	bastion.netfos.ken.lab.	root (
   			2019070700	; serial
   			3H		; refresh (3 hours)
   			30M		; retry (30 minutes)
   			2W		; expiry (2 weeks)
   			1W )		; minimum (1 week)
   	IN	NS	bastion.netfos.ken.lab.
   ;
   ;EOF
   ```

5. 調整防火牆

   ```
   [root@bastion ~]# firewall-cmd --add-service=dns --permanent
   [root@bastion ~]# firewall-cmd --reload
   ```

6. 啟動服務

   ```
   [root@bastion ~]# systemctl enable named --now
   ```

7. 驗證DNS

   ```
   [ken@bastion ~]$ dig +noall +answer @192.168.1.1 bastion.netfos.ken.lab
   bastion.netfos.ken.lab.	604800	IN	A	192.168.1.1
   
   [ken@bastion ~]$ nslookup 168.95.1.1
   1.1.95.168.in-addr.arpa	name = dns.hinet.net.
   
   Authoritative answers can be found from:
   
   ```

### 安裝NFS Server

1. install

   ```
   [ken@bastion ~]$ sudo yum install nfs-utils
   ```

2. setting

   ```
   [ken@bastion ~]$ sudo mkdir /nfs01
   [ken@bastion ~]$ sudo chmod 777 /nfs01/
   [ken@bastion ~]$ sudo vim /etc/exports
   /nfs01 192.168.1.0/24(rw,no_root_squash)
   [ken@bastion ~]$ sudo systemctl enable --now rpcbind nfs-server
   Created symlink /etc/systemd/system/multi-user.target.wants/nfs-server.service → /usr/lib/systemd/system/nfs-server.service.
   [ken@bastion ~]$ 
   防火牆關閉或是開nfs service
   ```

---

## Karbon (Airgap)

https://portal.nutanix.com/page/documents/details?targetId=Nutanix-Kubernetes-Engine-v2_6:top-airgap-deploy-t.html
https://next.nutanix.com/nutanix-kubernetes-engine-30/karbon-install-40404
https://portal.nutanix.com/page/documents/details?targetId=Nutanix-Kubernetes-Engine-v2_6:Nutanix-Kubernetes-Engine-v2_6

![img](https://kenkenny.synology.me:5543/images/2023/09/airgap-architecture-diagram.png)

#### 安裝httpd

1. 安裝httpd

   ```
   [ken@bastion ~]$ sudo yum install httpd
   ```

2. 新增資料夾並複製Karbon檔案&解壓縮

   ```
   [ken@bastion ~]$ sudo mkdir /var/www/html/ntnx-2.6.0
   [sudo] password for ken: 
   
   scp airgap-* root@172.16.90.205:/var/www/html/ntnx-2.6.0
   airgap-ntnx-2.6.0.tar.gz
   airgap-manifest.json
   
   [ken@bastion ~]$ sudo tar xvzf /var/www/html/ntnx-2.6.0/airgap-ntnx-2.6.0.tar.gz 
   ```

3. 啟動httpd,確認可以瀏覽至該目錄

   ```
   [ken@bastion ~]$ sudo systemctl enable httpd --now
   Created symlink /etc/systemd/system/multi-user.target.wants/httpd.service → /usr/lib/systemd/system/httpd.service.
   ```

   <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230111164809319.png" alt="image-20230111164809319" style="zoom:33%;" />

   

#### 安裝Karbon

https://portal.nutanix.com/page/documents/details?targetId=Nutanix-Kubernetes-Engine-v2_6:Nutanix-Kubernetes-Engine-v2_6
https://portal.nutanix.com/page/documents/details?targetId=Nutanix-Kubernetes-Engine-v2_6:top-airgap-c.html

- PC Enable Karbon

- LCM確認Karbon版本為最新 (2.6.0)

- PC 加一張網卡(連192.168.1.0的網段)

  ```
  nutanix@NTNX-172-16-90-219-A-PCVM:~/karbon$ sudo ifconfig eth1 192.168.1.2 netmask 255.255.255.0
  nutanix@NTNX-172-16-90-219-A-PCVM:~/karbon$ sudo ip link set eth1 down
  nutanix@NTNX-172-16-90-219-A-PCVM:~/karbon$ sudo ip link set eth1 up
  nutanix@NTNX-172-16-90-219-A-PCVM:~/karbon$ route -n
  Kernel IP routing table
  Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
  0.0.0.0         172.16.90.254   0.0.0.0         UG    0      0        0 eth0
  169.254.0.0     0.0.0.0         255.255.0.0     U     1002   0        0 eth0
  172.16.90.0     0.0.0.0         255.255.255.0   U     0      0        0 eth0
  192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 eth1
  ```


1. 用nutanix登入進prism central, cd 進/home/nutanix/karbon

   ```
   wangken@wangken-MAC % ssh -m hmac-sha2-256 nutanix@172.16.90.219
   Prism Central VM
   nutanix@172.16.90.219's password: nutanix/4u
   
   nutanix@NTNX-172-16-90-219-A-PCVM:~/karbon$ pwd
   /home/nutanix/karbon
   nutanix@NTNX-172-16-90-219-A-PCVM:~/karbon$ ls
   karbonctl
   
   登入prism central
   nutanix@NTNX-172-16-90-219-A-PCVM:~/karbon$ ./karbonctl login --pc-ip 172.16.90.219 \
   --pc-username admin \
   --pc-password Nutanix@20230109
   Login successful
   ```

2. 填入資訊並執行

   ```
   nutanix@pcvm$ /home/nutanix/karbon/karbonctl airgap enable \
   --webserver-url http://webserver_url/ntnx-version-number/ \
   --vlan-name network_name --static-ip static ip-address \
   --storage-container storage_container_name \
   --pe-cluster-name PE_cluster_name \
   –-pe-username user
   
   ---- 執行安裝指令 (若出現pe-username的error可以把它調到最前面)
   nutanix@pcvm$ ./karbonctl airgap enable \
   –-pe-username admin \
   --webserver-url http://172.16.90.205/ntnx-2.6.0 \
   --vlan-name 192.168.1.0 --static-ip 192.168.1.5 \
   --storage-container VM \
   --pe-cluster-name NX3360NG8-Cluster
   
   
   nutanix@NTNX-172-16-90-219-A-PCVM:~/karbon$ /home/nutanix/karbon/karbonctl airgap enable --pe-username admin --webserver-url http://172.16.90.205/ntnx-2.6.0/ --vlan-name 192.168.1.0 --static-ip 192.168.1.5 --storage-container VM --pe-cluster-name NX3360NG8-Cluster
   Please enter the password for the PE user: admin
   Successfully submitted request to enable airgap: [POST /airgap][202] postAirgapAccepted  &{TaskUUID:0xc000370140}
   
   
   ---- 確認執行進度
   nutanix@NTNX-172-16-90-219-A-PCVM:~/karbon$ ./karbonctl airgap list
   Airgap UUID                             VM IP    URL    Status                      Package Upload Status    Registry Status    Status Message
   33844fb8-a677-4412-5440-b099f4a5289d             :0     Deploying host OS images                             Not running  
   ```
   
   ![image-20230111173203221](https://kenkenny.synology.me:5543/images/2023/09/image-20230111173203221.png)
   
   ![image-20230112092547218](https://kenkenny.synology.me:5543/images/2023/09/image-20230112092547218.png)
   
3. check ok

   ```
   nutanix@NTNX-172-16-90-219-A-PCVM:~/karbon$ ./karbonctl airgap list
   Airgap UUID                             VM IP          URL              Status                        Package Upload Status    Registry Status    Status Message
   00e01072-b5a6-4055-4cfd-f55d78a8d57b    192.168.1.5    airgap-0:5000    Airgap registry is running                             Healthy 
   ```

4. 在Web UI新增Production Cluster
   連線方式用External Loadbalancer: 192.168.1.10  --> 要額外設定LoadBalancer
   control plane: 192.168.1.6-8
   
   改用Active-Passive Mode --> VIP 192.168.1.9

   ![image-20230112164205242](https://kenkenny.synology.me:5543/images/2023/09/image-20230112164205242.png)
   ![image-20230112164222735](https://kenkenny.synology.me:5543/images/2023/09/image-20230112164222735.png)
   
   ![image-20230112164247610](https://kenkenny.synology.me:5543/images/2023/09/image-20230112164247610.png)
   
   ![image-20230112164318768](https://kenkenny.synology.me:5543/images/2023/09/image-20230112164318768.png)
   
   
   抽換為 Active-Passive Mode
   
   ![image-20230112170725765](https://kenkenny.synology.me:5543/images/2023/09/image-20230112170725765.png)
   
   ![image-20230112164346300](https://kenkenny.synology.me:5543/images/2023/09/image-20230112164346300.png)
   ![image-20230112164407434](https://kenkenny.synology.me:5543/images/2023/09/image-20230112164407434.png)
   ![image-20230112164422938](https://kenkenny.synology.me:5543/images/2023/09/image-20230112164422938.png)
   
5. 安裝完畢
![image-20230112173209983](https://kenkenny.synology.me:5543/images/2023/09/image-20230112173209983.png)

#### 連線測試NKE

1. 下載kubeconfig
   <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230112173233274.png" alt="image-20230112173233274" style="zoom:50%;" />

2. linux 安裝kubectl

   ```
   [ken@bastion ~]$ curl -LO https://dl.k8s.io/release/v1.23.0/bin/linux/amd64/kubectl
     % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                    Dload  Upload   Total   Spent    Left  Speed
   100   138  100   138    0     0    380      0 --:--:-- --:--:-- --:--:--   379
   100 44.4M  100 44.4M    0     0  8858k      0  0:00:05  0:00:05 --:--:-- 10.6M
   
   [ken@bastion ~]$ sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
   [ken@bastion ~]$ kubectl version --client
   Client Version: version.Info{Major:"1", Minor:"23", GitVersion:"v1.23.0", GitCommit:"ab69524f795c42094a6630298ff53f3c3ebab7f4", GitTreeState:"clean", BuildDate:"2021-12-07T18:16:20Z", GoVersion:"go1.17.3", Compiler:"gc", Platform:"linux/amd64"}
   
   ###將kubeconfig放到.kube/config 
   [ken@bastion ~]$ cp nke-kubectl.cfg .kube/config
   [ken@bastion ~]$ rm .kube/kubeconfig.cfg
   [ken@bastion ~]$ kubectl get nodes
   NAME                  STATUS   ROLES    AGE   VERSION
   nke-34f192-master-0   Ready    master   25m   v1.23.11
   nke-34f192-master-1   Ready    master   25m   v1.23.11
   nke-34f192-worker-0   Ready    node     23m   v1.23.11
   nke-34f192-worker-1   Ready    node     23m   v1.23.11
   nke-34f192-worker-2   Ready    node     23m   v1.23.11
   
   [ken@bastion redmine]$ kubectl get node -o wide
   NAME                  STATUS   ROLES    AGE   VERSION    INTERNAL-IP    EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION                CONTAINER-RUNTIME
   nke-34f192-master-0   Ready    master   17h   v1.23.11   192.168.1.27   <none>        CentOS Linux 7 (Core)   3.10.0-1160.71.1.el7.x86_64   containerd://1.6.6
   nke-34f192-master-1   Ready    master   17h   v1.23.11   192.168.1.13   <none>        CentOS Linux 7 (Core)   3.10.0-1160.71.1.el7.x86_64   containerd://1.6.6
   nke-34f192-worker-0   Ready    node     17h   v1.23.11   192.168.1.84   <none>        CentOS Linux 7 (Core)   3.10.0-1160.71.1.el7.x86_64   containerd://1.6.6
   nke-34f192-worker-1   Ready    node     17h   v1.23.11   192.168.1.15   <none>        CentOS Linux 7 (Core)   3.10.0-1160.71.1.el7.x86_64   containerd://1.6.6
   nke-34f192-worker-2   Ready    node     17h   v1.23.11   192.168.1.82   <none>        CentOS Linux 7 (Core)   3.10.0-1160.71.1.el7.x86_64   containerd://1.6.6
   
   
   ### 新增測試pod
   [ken@bastion ~]$ kubectl run -i -t busybox --image=radial/busyboxplus:curl --restart=Never
   ```

#### 新增測試服務-redmine

1. postgresql的yaml檔-pvc

   ```
   kind: PersistentVolumeClaim
   apiVersion: v1
   metadata:
     namespace: redmine
     name: redmine-postgres-pv-claim
     labels:
       app: postgres
   spec:
     storageClassName: default-storageclass
     accessModes:
       - ReadWriteOnce
     resources:
       requests:
         storage: 20Gi
   ```

2. postgresql的yaml檔-configmap

   ```
   [ken@bastion redmine]$ cat pgsql-config.yaml 
   apiVersion: v1
   kind: ConfigMap
   metadata:
     name: redmine-postgres-config
     labels:
       app: postgres
     namespace: redmine
   data:
     POSTGRES_USER: postgres
     POSTGRES_PASSWORD: P@55w.rd
     PGDATA: /var/lib/postgresql/pgdata
     POSTGRES_DB: redmine
   ```

3. postgresql的yaml檔-deployment

   ```
   [ken@bastion redmine]$ cat pgsql-deploy.yaml 
   apiVersion: apps/v1
   kind: Deployment
   metadata:
     name: redmine-postgres-deployment
     namespace: redmine
   spec:
     strategy:
       type: Recreate
     selector:
       matchLabels:
         app: postgres
     replicas: 1
     template:
       metadata:
         labels:
           app: postgres
       spec:
         containers:
           - name: postgres
             image: postgres:12
             imagePullPolicy: "IfNotPresent"
             ports:
               - containerPort: 5432
             envFrom:
               - configMapRef:
                   name: redmine-postgres-config
             volumeMounts:
               - mountPath: /var/lib/postgresql/data
                 name: redmine-postgredb
                 subPath: redmine-pgsql/data
               - mountPath: /etc/postgresql/pg_hba.conf
                 name: redmine-postgredb
                 subPath: redmine-pgsql/pghba.conf
               - mountPath: /etc/postgresql/postgresql.conf
                 name: redmine-postgredb
                 subPath: redmine-pgsql/postgresql.conf
         volumes:
           - name: redmine-postgredb
             persistentVolumeClaim:
               claimName: redmine-postgres-pv-claim
   ```

4. postgresql的yaml檔-svc

   ```
   [ken@bastion redmine]$ cat pgsql-svc.yaml 
   apiVersion: v1
   kind: Service
   metadata:
     name: redmine-postgres-service
     namespace: redmine
     labels:
       app: postgres
   spec:
     type: NodePort
     ports:
       - port: 5432
         nodePort: 31432
     selector:
       app: postgres
   ```

5. deploy pgsql

   ```
   [ken@bastion redmine]$ kubectl apply -f pgsql-pvc.yaml -n redmine
   persistentvolumeclaim/redmine-postgres-pv-claim created
   [ken@bastion redmine]$ kubectl apply -f pgsql-config.yaml -f pgsql-deploy.yaml -f pgsql-svc.yaml -n redmine
   configmap/redmine-postgres-config created
   deployment.apps/redmine-postgres-deployment created
   service/redmine-postgres-service created
   
   ### 確認PV,PVC
   [ken@bastion redmine]$ kubectl get pv,pvc
   NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                            STORAGECLASS           REASON   AGE
   persistentvolume/pvc-6e4760a1-6884-492f-8ecb-b2dc89ddfdde   30Gi       RWO            Delete           Bound    ntnx-system/prometheus-k8s-db-prometheus-k8s-0   default-storageclass            17h
   persistentvolume/pvc-7875f29e-0b6e-409f-bcc2-d03b315ff2ac   20Gi       RWO            Delete           Bound    redmine/redmine-postgres-pv-claim                default-storageclass            4s
   persistentvolume/pvc-d5e769a0-3c74-4e99-b401-2deb620f90c0   30Gi       RWO            Delete           Bound    ntnx-system/prometheus-k8s-db-prometheus-k8s-1   default-storageclass            17h
   
   NAME                                              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS           AGE
   persistentvolumeclaim/redmine-postgres-pv-claim   Bound    pvc-7875f29e-0b6e-409f-bcc2-d03b315ff2ac   20Gi       RWO            default-storageclass   7s
   
   ### 確認pgsql status
   [ken@bastion redmine]$ kubectl get all -n redmine
   NAME                                               READY   STATUS    RESTARTS   AGE
   pod/redmine-postgres-deployment-6f6f66f9cd-4ph9q   1/1     Running   0          6m4s
   
   NAME                               TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
   service/redmine-postgres-service   NodePort   172.19.202.4   <none>        5432:31432/TCP   6m4s
   
   NAME                                          READY   UP-TO-DATE   AVAILABLE   AGE
   deployment.apps/redmine-postgres-deployment   1/1     1            1           6m4s
   
   NAME                                                     DESIRED   CURRENT   READY   AGE
   replicaset.apps/redmine-postgres-deployment-6f6f66f9cd   1         1         1       6m4s
   
   ### Test node port 31432
   [ken@bastion redmine]$ telnet 192.168.1.84 31432
   Trying 192.168.1.84...
   Connected to 192.168.1.84.
   Escape character is '^]'.
   ^CConnection closed by foreign host.
   ```

6. redmine的yaml檔-config

   ```
   apiVersion: v1
   data:
     configuration.yml: |
       # = Redmine configuration file
       #
       # Each environment has its own configuration options.  If you are only
       # running in production, only the production block needs to be configured.
       # Environment specific configuration options override the default ones.
       #
       # Note that this file needs to be a valid YAML file.
       # DO NOT USE TABS! Use 2 spaces instead of tabs for indentation.
   
       # default configuration options for all environments
       default:
         email_delivery:
         autologin_cookie_name:
         autologin_cookie_path:
         scm_mercurial_command:
         scm_git_command:
         scm_cvs_command:
         scm_bazaar_command:
         scm_subversion_path_regexp:
         scm_mercurial_path_regexp:
         scm_git_path_regexp:
         scm_cvs_path_regexp:
         scm_bazaar_path_regexp:
         scm_filesystem_path_regexp:
         scm_stderr_log_file:
         database_cipher_key:
         minimagick_font_path:
       production:
   
       development:
   kind: ConfigMap
   metadata:
     name: redmine-config
     namespace: redmine
   ```

7. redmine的yaml檔-deploy

   ```
   [ken@bastion ~]$ cat redmine-deploy.yaml 
   apiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2
   kind: Deployment
   metadata:
     name: redmine
     namespace: redmine
   spec:
     replicas: 1
     selector:
       matchLabels:
         app: redmine
     template:
       metadata:
         labels:
           app: redmine
       spec:
         initContainers:
         # 修正configmap所需的讀寫權限
         - name: fix-permission-for-configfile
           image: busybox:1.33.1
           imagePullPolicy: IfNotPresent
           command: ['sh', '-c', 'cat /tmp/configuration.yml && cp /tmp/configuration.yml /config-tmp-dir/configuration.yml && chmod -R 777 /config-tmp-dir']
           # 同時掛載兩個空間(一個有redmine要得檔案, 另外一個有可自由讀寫的空間)
           volumeMounts:
           - name: redmine-config-vol
             mountPath: /tmp/configuration.yml
             subPath: configuration.yml
           - name: redmine-config-tmp-dir
             mountPath: /config-tmp-dir
         containers:
         - name: redmine
           image: redmine:4.1.5
           env:
           - name: REDMINE_DB_POSTGRES
             value: redmine-postgres-service
           - name: REDMINE_DB_USER
             value: postgres
           - name: REDMINE_DB_PASSWORD
             value: P@55w.rd
           - name: REDMINE_DB_DATABASE
             value: redmine
        #  default password admin/admin
           volumeMounts:
           - name: redmine-config-tmp-dir
             mountPath: /usr/src/redmine/config/configuration.yml
             subPath: configuration.yml
           - name: redmine-files-dir
             mountPath: /usr/src/redmine/files
           - name: redmine-plugins
             mountPath: /usr/src/redmine/plugins
           - name: redmine-themes
             mountPath: /usr/src/redmine/public/themes        
           ports:
           - containerPort: 3000
             name: ui
         # 向k8s取得redmine的yaml檔案
         volumes:
         - name: redmine-config-vol
           configMap:
             name: redmine-config
             items:
             - key: configuration.yml
               path: configuration.yml
         # 暫存給redmine與初始化需要的儲存空間(會隨刪除消失)
         - name: redmine-config-tmp-dir
           emptyDir: {}
         - name: redmine-files-dir
           nfs:
             path: /nfs01/redmine/
             server: 192.168.1.1
         - name: redmine-themes
           nfs:
             path: /nfs01/redmine/
             server: 192.168.1.1 
         - name: redmine-plugins
           nfs:
             path: /nfs01/redmine/
             server: 192.168.1.1  
   ```

8. redmine的yaml檔-service (NodePort)

   ```
   [ken@bastion ~]$ cat redmine-svc.yaml 
   apiVersion: v1
   kind: Service
   metadata:
     name: redmine-service
     labels: 
       app: redmine
   spec:
     type: NodePort
     selector:
       app: redmine
     ports:
       - name: ui
         protocol: TCP
         port: 3000
         nodePort: 32748
         
         
    ----------------- ClusterIP
    apiVersion: v1
   kind: Service
   metadata:
     name: redmine-service
     labels: 
       app: redmine
   spec:
     type: ClusterIP
     selector:
       app: redmine
     externalIPs:
     - 172.16.90.213
     ports:
       - name: ui
         protocol: TCP
         port: 80
         targetPort: 3000
   ```

9. 部署redmine

   ```
   [ken@bastion redmine]$ kubectl apply -f redmine-config.yaml -f redmine-deploy.yaml -f redmine-svc.yaml 
   configmap/redmine-config created
   deployment.apps/redmine created
   service/redmine-service created
   
   [ken@bastion redmine]$ kubectl get all -n redmine
   NAME                                               READY   STATUS    RESTARTS   AGE
   pod/redmine-54b45b447c-89rm4                       1/1     Running   0          51s
   pod/redmine-postgres-deployment-6f6f66f9cd-6ngtz   1/1     Running   0          86s
   
   NAME                               TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
   service/redmine-postgres-service   NodePort   172.19.202.4     <none>        5432:31432/TCP   172m
   service/redmine-service            NodePort   172.19.220.153   <none>        3000:32748/TCP   51s
   
   NAME                                          READY   UP-TO-DATE   AVAILABLE   AGE
   deployment.apps/redmine                       1/1     1            1           52s
   deployment.apps/redmine-postgres-deployment   1/1     1            1           172m
   
   NAME                                                     DESIRED   CURRENT   READY   AGE
   replicaset.apps/redmine-54b45b447c                       1         1         1       52s
   replicaset.apps/redmine-postgres-deployment-6f6f66f9cd   1         1         1       172m
   ```

10. 預設帳密 admin/admin , 服務皆走node port , 確認連線OK
    <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230113132436022.png" alt="image-20230113132436022" style="zoom:50%;" />

    
    

#### Enable Advance k8s

https://portal.nutanix.com/page/documents/details?targetId=Nutanix-Kubernetes-Engine-v2_5:top-install-advanced-t.html

1. 登入Prism Central的VM

   ```
   wangken@wangken-MAC ~ % ssh nutanix@172.16.90.219
   Prism Central VM
   nutanix@172.16.90.219's password: 
   ```

2. karbonctl 登入PC

   ```
   nutanix@NTNX-172-16-90-219-A-PCVM:~$ cd karbon/
   nutanix@NTNX-172-16-90-219-A-PCVM:~/karbon$ ll
   total 66020
   -rwxr-x---. 1 nutanix nutanix 53464168 Oct 14 11:04 karbonctl
   -rw-------. 1 nutanix nutanix 14136153 Jan 11 00:56 kps-cloud-deployer-pc.tar.gz
   
   nutanix@NTNX-172-16-90-219-A-PCVM:~/karbon$ ./karbonctl login --pc-username admin
   Please enter the password for the PC user: admin
   Login successful
   ```

3. Enable Advance K8s Management -- airgap mode 不能啟用

   ```
   nutanix@NTNX-172-16-90-219-A-PCVM:~/karbon$ ./karbonctl karbon-management enable --cluster-name nke
   Advanced Kubernetes Managment can not be enabled in airgap mode.
   panic: runtime error: invalid memory address or nil pointer dereference
   [signal SIGSEGV: segmentation violation code=0x1 addr=0x68 pc=0x155813e]
   
   goroutine 1 [running]:
   github.com/nutanix-core/acs-karbonctl/cmd.executeK8sRESTAPI({0x1b93ae8, 0xc00013f1c0}, {0x0, 0x0}, {0x190b901, 0x5}, {0xc000148200, 0xc000523510, 0xc000356880}, {0x28bff08, ...}, ...)
   	/home/circleci/go/src/github.com/nutanix-core/acs-karbonctl/cmd/karbonmgmt_enable.go:140 +0x5e
   github.com/nutanix-core/acs-karbonctl/cmd.actionKarbonMgmtYaml({0x1b93ae8, 0xc00013f1c0}, {0x0, 0x0}, {0xc0003ec0c0, 0x7, 0x0}, {0x28bff08, 0x0, 0x0}, ...)
   	/home/circleci/go/src/github.com/nutanix-core/acs-karbonctl/cmd/karbonmgmt.go:213 +0x191
   github.com/nutanix-core/acs-karbonctl/cmd.processKarbonMgmtYaml({0x1b93ae8, 0xc00013f1c0}, {0x190e83e, 0x16eeb40}, 0x1b29ac0, {0x0, 0x32}, {0x0, 0x2b}, {0xc0004dcea0, ...}, ...)
   	/home/circleci/go/src/github.com/nutanix-core/acs-karbonctl/cmd/karbonmgmt_enable.go:483 +0x165
   github.com/nutanix-core/acs-karbonctl/cmd.glob..func64(0x286ba80, {0xc00013d060, 0x2, 0x2})
   	/home/circleci/go/src/github.com/nutanix-core/acs-karbonctl/cmd/karbonmgmt_enable.go:426 +0x1c5
   github.com/spf13/cobra.(*Command).execute(0x286ba80, {0xc00013d040, 0x2, 0x2})
   	/home/circleci/go/src/github.com/nutanix-core/acs-karbonctl/vendor/github.com/spf13/cobra/command.go:860 +0x5f8
   github.com/spf13/cobra.(*Command).ExecuteC(0x2870580)
   	/home/circleci/go/src/github.com/nutanix-core/acs-karbonctl/vendor/github.com/spf13/cobra/command.go:974 +0x3bc
   github.com/spf13/cobra.(*Command).Execute(...)
   	/home/circleci/go/src/github.com/nutanix-core/acs-karbonctl/vendor/github.com/spf13/cobra/command.go:902
   github.com/nutanix-core/acs-karbonctl/cmd.Execute()
   	/home/circleci/go/src/github.com/nutanix-core/acs-karbonctl/cmd/root.go:44 +0x25
   main.main()
   	/home/circleci/go/src/github.com/nutanix-core/acs-karbonctl/main.go:19 +0x17
   
   ```

#### Rancher install

1. 下載安裝cert-manager

   ```
   [ken@bastion rancher]$ wget https://github.com/jetstack/cert-manager/releases/download/v1.0.4/cert-manager.yaml
   [ken@bastion rancher]$ kubectl create ns cert-manager
   [ken@bastion rancher]$ kubectl apply -f cert-manager.yaml
   [ken@bastion rancher]$ kubectl get pods -n cert-manager
   NAME                                       READY   STATUS    RESTARTS      AGE
   cert-manager-7455bdc9bd-jxjrs              1/1     Running   0             109s
   cert-manager-cainjector-5bcbb87487-j27cl   0/1     Error     4 (60s ago)   109s
   cert-manager-webhook-55b97fbb44-5xbsd      1/1     Running   0             109s
   
   複製檔案過來
   [ken@bastion rancher]$ ll
   total 3324
   -rw-r--r--. 1 ken ken 1679688 Jan 16 09:44 cert-manager.crds.yaml
   -rw-r--r--. 1 ken ken 1701573 Dec  8  2021 cert-manager.yaml
   -rw-r--r--. 1 ken ken     262 Jan 16 09:44 rancher-service.yaml
   
   [ken@bastion rancher]$ kubectl apply --validate=false -f cert-manager.crds.yaml
   customresourcedefinition.apiextensions.k8s.io/certificaterequests.cert-manager.io configured
   customresourcedefinition.apiextensions.k8s.io/certificates.cert-manager.io configured
   customresourcedefinition.apiextensions.k8s.io/challenges.acme.cert-manager.io configured
   customresourcedefinition.apiextensions.k8s.io/clusterissuers.cert-manager.io configured
   customresourcedefinition.apiextensions.k8s.io/issuers.cert-manager.io configured
   customresourcedefinition.apiextensions.k8s.io/orders.acme.cert-manager.io configured
   ```

2. 安裝rancher

   ```
   [ken@bastion rancher]$ kubectl create namespace cattle-system
   namespace/cattle-system created
   [ken@bastion rancher]$ kubectl apply -f rancher-service.yaml 
   service/rancher-service created
   
   ### helm install
   [ken@bastion rancher]$ wget https://get.helm.sh/helm-v3.11.0-rc.2-linux-amd64.tar.gz
   [ken@bastion rancher]$ tar xvf helm-v3.10.3-linux-amd64.tar.gz 
   linux-amd64/
   linux-amd64/helm
   linux-amd64/LICENSE
   linux-amd64/README.md
   [ken@bastion linux-amd64]$ sudo cp helm /usr/local/bin/
   [sudo] password for ken:
   [ken@bastion linux-amd64]$ helm version
   WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /home/ken/nke.cfg
   WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /home/ken/nke.cfg
   version.BuildInfo{Version:"v3.10.3", GitCommit:"835b7334cfe2e5e27870ab3ed4135f136eecc704", GitTreeState:"clean", GoVersion:"go1.18.9"}
   
   ##rancher install
   [ken@bastion rancher]$ helm repo add rancher-stable https://releases.rancher.com/server-charts/stable
   [ken@bastion rancher]$ helm install rancher rancher-stable/rancher --namespace cattle-system --set hostname=rancher.netfos.ken.lab --set replicas=1
   [ken@bastion rancher]$ kubectl get all -n cattle-system
   NAME                           READY   STATUS      RESTARTS   AGE
   pod/helm-operation-9bhx6       0/2     Completed   0          72s
   pod/helm-operation-h7rnz       0/2     Completed   0          25s
   pod/helm-operation-j8wx2       0/2     Completed   0          6s
   pod/rancher-687bc6596d-xf4pw   1/1     Running     0          2m38s
   
   NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
   service/rancher           ClusterIP   172.19.196.248   <none>        80/TCP,443/TCP   2m39s
   service/rancher-service   NodePort    172.19.29.29     <none>        443:31443/TCP    36m
   
   NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
   deployment.apps/rancher   1/1     1            1           2m39s
   
   NAME                                 DESIRED   CURRENT   READY   AGE
   replicaset.apps/rancher-687bc6596d   1         1         1       2m39s
   
   ```

3. browser to https://192.168.1.15:31443
   ![image-20230116102459000](https://kenkenny.synology.me:5543/images/2023/09/image-20230116102459000.png)

4. 改密碼
   <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230116102741258.png" alt="image-20230116102741258" style="zoom:50%;" />

5. 即可透過Rancher來查看叢集Status
   ![image-20230116102900002](https://kenkenny.synology.me:5543/images/2023/09/image-20230116102900002.png)
   ![image-20230116103502845](https://kenkenny.synology.me:5543/images/2023/09/image-20230116103502845.png)

## FIles

https://portal.nutanix.com/page/documents/details?targetId=Files-v4_2:fil-file-server-create-wc-t.html#ntask_dgl_l3j_j5
https://portal.nutanix.com/page/documents/details?targetId=Files-v4_2:Files-v4_2

- 安裝設定AD (optional 如要使用SMB就需有AD)

- Domain: netfos.ken.lab
- 分為Storage Network (172.16.90.0)、Client Network (192.168.1.0)
- Client Network不能與CVM同網段
- Virtual IP用在Storage Network, Client 的IP, FSVM會自動HA
- 先用LCM將File升級到最新
- 網路Port圖
  https://portal.nutanix.com/page/documents/details?targetId=Port-Reference:Files_port_auto_r.html

#### 架構

<img src="https://kenkenny.synology.me:5543/images/2023/09/fs-file-server-network-relationship.png" alt="img" style="zoom:50%;" />

#### 安裝AD

<img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230112103131877.png" alt="image-20230112103131877" style="zoom:50%;" />

#### 安裝File Server on PE

https://portal.nutanix.com/page/documents/details?targetId=Files-v4_2:fil-file-server-create-wc-t.html#ntask_dgl_l3j_j5

1. 在PE的 File Server ADD,先確認有達到最低需求
   <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230112104219863.png" alt="image-20230112104219863" style="zoom:50%;" />

2. 設定FQDN、大小

   ![image-20230112104042391](https://kenkenny.synology.me:5543/images/2023/09/image-20230112104042391.png)

   

3. 設定Client Network (192.168.1.0 要與CVM的網段不同) 
   <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230112105256290.png" alt="image-20230112105256290" style="zoom:50%;" />

4. 設定DNS&NTP 

   <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230112105434906.png" alt="image-20230112105434906" style="zoom:50%;" /> 

5. 設定Storage Network (172.16.90.206-209)
   <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230112105545032.png" alt="image-20230112105545032" style="zoom:50%;" />

6. 設定目錄服務 SMB、NFS  (SMB要AD)
   <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230112104942496.png" alt="image-20230112104942496" style="zoom:50%;" />

7. Summary & Protection Domain (Snapshot)
   <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230112105055627.png" alt="image-20230112105055627" style="zoom:50%;" />

8. 去PE的Setting查看fs被分配到什麼IP (192.168.1.26,81,97)

   並在DNS上註記 -- 使用auto update

   ![image-20230113151039168](https://kenkenny.synology.me:5543/images/2023/09/image-20230113151039168.png)

   

   <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230112105750255.png" alt="image-20230112105750255" style="zoom:50%;" />

9. 查看Takss
   ![image-20230112110132893](https://kenkenny.synology.me:5543/images/2023/09/image-20230112110132893.png)

10. 安裝完畢
    ![image-20230112111921165](https://kenkenny.synology.me:5543/images/2023/09/image-20230112111921165.png)

11. 可以點選console來查看File Server的狀態
    ![image-20230112112012184](https://kenkenny.synology.me:5543/images/2023/09/image-20230112112012184.png)

12. 有出現無法連到AD 需查找問題-- 將兩台DNS Server的註記都設定上去後即正常
    ![image-20230112112151953](https://kenkenny.synology.me:5543/images/2023/09/image-20230112112151953.png)

13. 新增Share資料夾 (SMB)
    <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230112112521953.png" alt="image-20230112112521953" style="zoom:50%;" />

    <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230112112613066.png" alt="image-20230112112613066" style="zoom:50%;" />

    ![image-20230112112657224](https://kenkenny.synology.me:5543/images/2023/09/image-20230112112657224.png)

    

14. 測試連線,點進去file-test即可看到mount path
    ![image-20230112112723327](https://kenkenny.synology.me:5543/images/2023/09/image-20230112112723327.png)

15. 在一台Windows上連線測試 ( 走的是192.168.1.0網段 )

    測試資料夾有出現，但要開權限

    https://portal.nutanix.com/page/documents/details?targetId=Files-v4_2:fil-fs-rbac-workflow-c.html![image-20230112112909758](https://kenkenny.synology.me:5543/images/2023/09/image-20230112112909758.png)

16. 查詢
    https://portal.nutanix.com/page/documents/kbs/details?targetId=kA032000000TWZMCA4

    ```
    nutanix@NTNX-22SH6M380125-C-CVM:172.16.90.213:~$ ncli fs ls
    
        Uuid                      : dcb7f7d3-1beb-423e-92d8-0004978542c8
        Name                      : fs01
        DNS Domain Name           : netfos.ken.lab
        Version                   : 4.2.1
        Container ID              : 0005f1d0-ce0d-147b-16c3-7cc25505da5a::169299
        Container Uuid            : 5d3fd980-8192-4a8c-ab18-5fb605f58bae
        Virtual IP address        : 172.16.90.206
        DNS Server IP Addresses   : 192.168.1.1, 192.168.1.100
        NTP Servers               : clock.stdtime.gov.tw, tick.stdtime.gov.tw, time.stdtime.gov.tw, tock.stdtime.gov.tw, watch.stdtime.gov.tw
        File server PD name       : NTNX-fs01
        File server PD status     : Active
        File server status        : Active
        AD Domain Name            : netfos.ken.lab
        AD Username               : administrator
        Preferred Domain Contr... : true
        Overwrite User Account    : false
        AD Protocol Type          : SMB
        Local Protocol Type       : NFS
        Nfs version               : NFSV3
        Total Snapshot Space Used : 0 bytes
        Total Space Used          : 808 KiB (827,392 bytes)
        Total Space Available     : 1024 GiB (1,099,510,800,384 bytes)
        Total SMB Connections     : 1
        Storage User Capacity     : 23.31 TiB (25,633,686,087,723 bytes)
        Size                      : 1 TiB (1,099,511,627,776 bytes)
        Data savings              : 0 bytes
        Data reduction ratio      : 1:1
        Controller Num IOPs       : 100
        Controller IO Bandwidth   : 751
        Controller Avg IO Latency : 867
    
            Network UUID              : c5b9824f-4fba-4c01-9fb2-d02a88daf933
            Default Gateway           : 172.16.90.254
            Subnet Mask               : 255.255.255.0
            Network Type              : Internal
            IP Pool                   : 172.16.90.206 - 172.16.90.209
    
            Network UUID              : ac09299f-322e-4750-9183-6d106be2a0df
            Default Gateway           : 192.168.1.1
            Subnet Mask               : 255.255.255.0
            Network Type              : External
    
            Nvm UUID                  : 5a7aef2d-2052-4a6b-935a-bfa46b493b98
            Nvm ID                    : 0005f1d0-ce0d-147b-16c3-7cc25505da5a::0749859d-c8d7-4199-876f-92ee9215ba26
            Nvm Name                  : NTNX-fs01-3
            Memory In GiB             : 12
            Virtual CPUs              : 4
            Nvm IP Addresses          : 192.168.1.26, 172.16.90.209
    
            Nvm UUID                  : 275adefc-0e3f-4f26-8680-9dd7ff7223b4
            Nvm ID                    : 0005f1d0-ce0d-147b-16c3-7cc25505da5a::a0a930a7-cafd-4dd3-b4f9-559a48a6db00
            Nvm Name                  : NTNX-fs01-1
            Memory In GiB             : 12
            Virtual CPUs              : 4
            Nvm IP Addresses          : 192.168.1.97, 172.16.90.207
    
            Nvm UUID                  : 3eec8305-8d7c-41ec-804d-9f217b41669c
            Nvm ID                    : 0005f1d0-ce0d-147b-16c3-7cc25505da5a::d3b41d19-1bf1-4c4b-8ece-e09d2b9dac2d
            Nvm Name                  : NTNX-fs01-2
            Memory In GiB             : 12
            Virtual CPUs              : 4
            Nvm IP Addresses          : 192.168.1.81, 172.16.90.208
    
    ```

17. 最後問題點是FQDN帶了多個IP出來，直接用IP就可以連線

    並且資料會同步到其他FSVM上
    ![image-20230112145143605](https://kenkenny.synology.me:5543/images/2023/09/image-20230112145143605.png)
    ![image-20230112153035796](https://kenkenny.synology.me:5543/images/2023/09/image-20230112153035796.png)

18. 可以針對檔案副檔名封鎖存取

    <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230112145238291.png" alt="image-20230112145238291" style="zoom:50%;" />

19. Dashboard查看目前Share Folder的狀態

    ![image-20230112145309865](https://kenkenny.synology.me:5543/images/2023/09/image-20230112145309865.png)
    
20. 測試NFS,新增NFS Share

    ![image-20230112150448407](https://kenkenny.synology.me:5543/images/2023/09/image-20230112150448407.png)

21. 在Linux上安裝nfs-utils後mount測試

    ```
    [ken@bastion ~]$ sudo yum install nfs-utils
    
    [ken@bastion ~]$ sudo mount -t nfs 192.168.1.26:/nfs01 /var/nfs
    Created symlink /run/systemd/system/remote-fs.target.wants/rpc-statd.service → /usr/lib/systemd/system/rpc-statd.service.
    mount.nfs: access denied by server while mounting 192.168.1.26:/nfs01
    ```

22. 出現 Access Denied 需要調整權限,Authentication調整為none,mount時要加sec=none
    <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230112150700831.png" alt="image-20230112150700831" style="zoom:50%;" />

23. 測試連線

    ```
    [ken@bastion ~]$ sudo mount -t nfs 192.168.1.26:/nfs01 /var/nfs -o sec=none
    [ken@bastion ~]$ cd /var/nfs/
    [ken@bastion nfs]$ mkdir test
    [ken@bastion nfs]$ touch 123
    [ken@bastion nfs]$ touch 321.txt
    [ken@bastion nfs]$ ll
    total 2
    -rw-r--r--. 1 4294967294 4294967294 0 Jan 12  2023 123
    -rw-r--r--. 1 4294967294 4294967294 0 Jan 12  2023 321.txt
    drwxr-xr-x. 2 4294967294 4294967294 2 Jan 12 15:10 test
    ```

24. 測試阻擋副檔名*.txt
    <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230112151230300.png" alt="image-20230112151230300" style="zoom:50%;" />

    ```
    [ken@bastion nfs]$ touch 333.txt
    touch: cannot touch '333.txt': Permission denied
    [ken@bastion nfs]$ rm 321.txt 
    rm: cannot remove '321.txt': Operation not permitted
    [ken@bastion nfs]$ rm 123
    rm: cannot remove '123': Operation not permitted
    ```

25. 若新增時選擇的是Use "Distributed" share type instead of "Standard" 

    提示要安裝MMC Plugin

    <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230112152924185.png" alt="image-20230112152924185" style="zoom:50%;" />

26. 可以連線至該資料夾，但無法新增檔案
    <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230112153247015.png" alt="image-20230112153247015" style="zoom:50%;" />

27. 可以新增資料夾並在子資料夾內可新增檔案

    <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230113141034500.png" alt="image-20230113141034500" style="zoom:50%;" />

28. Standard vs Distributed

    ```
    Standard: 一般的Share Folder,實測資料都會同步到其他FSVM上,第一層資料夾即可開始使用。
    Distributed: 多用來當作家目錄資料夾底下會放多個使用者的資料夾，可以有比較好的效能跟分流作用。
    ```

    ![](https://kenkenny.synology.me:5543/images/2023/09/image-20230113140218786.png)
    

    ##### Distributed

    ![Shares, in this example \profile, distributed across FSVMs.](https://kenkenny.synology.me:5543/images/2023/09/share-export-distributed.png)
    ##### Standard

    ![Shares, in this example \finance, \hr, and \eng, are not distributed across FSVMs.](https://kenkenny.synology.me:5543/images/2023/09/share-export-standard.png)
    

#### File HA

1. ```
   Fail over for file server VMs (FSVMs).
   
   High Availability (HA) for Files insures that during a disruption of service a file server VM (FSVM), on clusters of two or more FSVMs, can fail over to another FSVM. High Availability is enabled by default on all clusters of two or more FSVMs.
   
   When an FSVM experiences an issue, Files reassigns the IP address of the FSVM to another FSVM in the cluster. The IP address of the out-of-service FSVM remains available. However, the shares and exports on the impacted FSVM are unavailable for several minutes during a failover.
   
   Affinity rules do not affect HA; multiple FSVMs can share a single host during a HA event.
   ```

2. 情境模擬,目前DNS設定
   <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230113152719949.png" alt="image-20230113152719949" style="zoom:50%;" />

3. 資料夾連線狀態,兩邊都可以新增檔案
   ![image-20230113152849603](https://kenkenny.synology.me:5543/images/2023/09/image-20230113152849603.png)

4. 將ntnx-fs01-1關機
   ![image-20230113153317896](https://kenkenny.synology.me:5543/images/2023/09/image-20230113153317896.png)

5. 同樣路徑下還是可以進行檔案編輯、新增
   192.168.1.97 還是ping得通。

   ![image-20230113153249886](https://kenkenny.synology.me:5543/images/2023/09/image-20230113153249886.png)

   <img src="https://kenkenny.synology.me:5543/images/2023/09/image-20230113153717326.png" alt="image-20230113153717326" style="zoom:50%;" />

#### CSI 

https://github.com/nutanix/csi-plugin/blob/master/README.md

分為Volume 跟Files
Files 分為專用的Share以及Dynamic NFS
先確認worker node 有啟動nfs-server服務

```
[nutanix@anthos-lab01-anthos-workerVm-0 ~]$ sudo systemctl enable nfs-server --now
Created symlink /etc/systemd/system/multi-user.target.wants/nfs-server.service → /usr/lib/systemd/system/nfs-server.service.
[nutanix@anthos-lab01-anthos-workerVm-0 ~]$ sudo systemctl status nfs-server
● nfs-server.service - NFS server and services
   Loaded: loaded (/usr/lib/systemd/system/nfs-server.service; enabled; vendor preset: disabled)
   Active: active (exited) since Fri 2023-07-14 09:00:10 UTC; 12s ago
  Process: 46413 ExecStart=/bin/sh -c if systemctl -q is-active gssproxy; then systemctl reload gssproxy ; fi (code=exited, status=0/SUCCESS)
  Process: 46400 ExecStart=/usr/sbin/rpc.nfsd (code=exited, status=0/SUCCESS)
  Process: 46398 ExecStartPre=/usr/sbin/exportfs -r (code=exited, status=0/SUCCESS)
 Main PID: 46413 (code=exited, status=0/SUCCESS)

 7月 14 09:00:10 anthos-lab01-anthos-workerVm-0 systemd[1]: Starting NFS server and services...
 7月 14 09:00:10 anthos-lab01-anthos-workerVm-0 systemd[1]: Started NFS server and services.
```

##### Files Dynamic

Prism 上有建立Files Server即可使用，不用新增Share

1. 建立Secret

   ```
   [nutanix@anthos-lab01-anthos-adminVm-0 ~]$ cat ntnx-secret74.yaml 
   apiVersion: v1
   kind: Secret
   metadata:
     name: ntnx-secret74
     namespace: ntnx-system
   data:
     # base64 encoded prism-ip:prism-port:admin:password. 
     # E.g.: echo -n "172.16.90.74:9440:admin:mypassword" | base64
     key: MTcyLjE2LjkwLjc0Ojk0NDA6YWRtaW46TnV0YW5peC9MYWIxMjM=
   ```

2. 建立Dynamic NFS Storageclass

   ```
   [nutanix@anthos-lab01-anthos-adminVm-0 ~]$ cat ntnx-secret74.yaml 
   apiVersion: v1
   kind: Secret
   metadata:
     name: ntnx-secret74
     namespace: ntnx-system
   data:
     # base64 encoded prism-ip:prism-port:admin:password. 
     # E.g.: echo -n "10.6.47.155:9440:admin:mypassword" | base64
     key: MTcyLjE2LjkwLjc0Ojk0NDA6YWRtaW46TnV0YW5peC9MYWIxMjM=
   [nutanix@anthos-lab01-anthos-adminVm-0 ~]$ cat dyn-files.yaml 
   kind: StorageClass
   apiVersion: storage.k8s.io/v1
   metadata:
       name: ntnx-files
   provisioner: csi.nutanix.com
   parameters:
       dynamicProv: ENABLED
       nfsServerName: Files
       csi.storage.k8s.io/provisioner-secret-name: ntnx-secret74
       csi.storage.k8s.io/provisioner-secret-namespace: ntnx-system
       storageType: NutanixFiles
   ```

3. 建立測試pvc

   ```
   [nutanix@anthos-lab01-anthos-adminVm-0 ~]$ cat test-claim.yaml 
   kind: PersistentVolumeClaim
   apiVersion: v1
   metadata:
      name: claim2
   spec:
      accessModes:
         - ReadWriteMany
      resources:
         requests:
            storage: 10Gi
      storageClassName: ntnx-files
   ```

4. 驗證OK

   ```
   [nutanix@anthos-lab01-anthos-adminVm-0 ~]$ kubectl get pvc
   NAME     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
   claim2   Bound    pvc-a338991c-13f8-4c2f-811b-10911f543e97   10Gi       RWX            ntnx-files     93m
   ```

5. 實際Prism 畫面
   ![image-20230714135126573](https://kenkenny.synology.me:5543/images/2023/09/dyn-files.png)

6. Anthos 畫面
   ![image-20230714135206479](https://kenkenny.synology.me:5543/images/2023/09/image-20230714135206479.png)

##### Files Share

1. Prism 建立Files Share
   ![image-20230714140331520](https://kenkenny.synology.me:5543/images/2023/09/image-20230714140331520.png)

   ![image-20230714140358134](https://kenkenny.synology.me:5543/images/2023/09/image-20230714140358134.png)

   ![image-20230714140415066](https://kenkenny.synology.me:5543/images/2023/09/image-20230714140415066.png)

   ![image-20230714140434787](https://kenkenny.synology.me:5543/images/2023/09/image-20230714140434787.png)
   ![image-20230714140451932](https://kenkenny.synology.me:5543/images/2023/09/image-20230714140451932.png)

2. 建立Storageclass 針對anthos 這個share

   ```
   [nutanix@anthos-lab01-anthos-adminVm-0 ~]$ cat ntnx-files.yaml 
   kind: StorageClass
   apiVersion: storage.k8s.io/v1
   metadata:
       name: ntnx-files-anthos
       annotations:
           storageclass.kubernetes.io/is-default-class: "false"
   provisioner: csi.nutanix.com
   parameters:
       nfsServer: Files.nutanixlab.local
       nfsPath: anthos
       storageType: NutanixFiles
   reclaimPolicy: Delete
   ```

3. 確認Storageclass "ntnx-files-anthos"

   ```
   [nutanix@anthos-lab01-anthos-adminVm-0 ~]$ kubectl get storageclass
   NAME                       PROVISIONER                    RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
   anthos-system              kubernetes.io/no-provisioner   Delete          WaitForFirstConsumer   false                  29d
   local-disks                kubernetes.io/no-provisioner   Delete          WaitForFirstConsumer   false                  29d
   local-shared               kubernetes.io/no-provisioner   Delete          WaitForFirstConsumer   false                  29d
   ntnx-files                 csi.nutanix.com                Delete          Immediate              false                  108m
   ntnx-files-anthos          csi.nutanix.com                Delete          Immediate              false                  6s
   nutanix-volume (default)   csi.nutanix.com                Delete          Immediate              true                   29d
   
   [nutanix@anthos-lab01-anthos-adminVm-0 ~]$ kubectl describe storageclass ntnx-files-anthos
   Name:                  ntnx-files-anthos
   IsDefaultClass:        No
   Annotations:           storageclass.kubernetes.io/is-default-class=false
   Provisioner:           csi.nutanix.com
   Parameters:            nfsPath=anthos,nfsServer=Files.nutanixlab.local,storageType=NutanixFiles
   AllowVolumeExpansion:  <unset>
   MountOptions:          <none>
   ReclaimPolicy:         Delete
   VolumeBindingMode:     Immediate
   Events:                <none>
   ```

