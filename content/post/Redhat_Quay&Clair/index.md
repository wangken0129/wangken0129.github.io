---
title: Redhat_Quay&Clair
description: Redhat_Quay&Clair
slug: Redhat_Quay&Clair
date: 2023-09-23T08:18:17+08:00
categories:
    - Lab Category
tags:
    - Redhat
    - Quay
    - Clair
    - Kubernetes
weight: 1       # You can add weight to some posts to override the default sorting (date descending)
---
# Install Redhat Quay & Clair 

安裝單節點的Quay跟Clair在同一台VM上面執行，需先裝好Clair再安裝Quay。

# 參考文件

1.原廠文件：https://access.redhat.com/documentation/en-us/red_hat_quay/2.9/html/manage_red_hat_quay/clair-initial-setup

2.原廠文件：https://access.redhat.com/documentation/zh-tw/red_hat_quay/3.7/html/manage_red_hat_quay/clair-intro2

3.quay&clair: https://examples.openshift.pub/quay/
https://www.modb.pro/db/109809 --> 本篇參考
https://docs.projectquay.io/deploy_quay.html

# 架構 (單節點)

| Clair      | 說明                                   |
| :--------- | -------------------------------------- |
| OS_User    | root、devop / redhat                   |
| OS         | RHEL8.6                                |
| OS_IP      | 192.168.33.34                          |
| CPU、RAM   | 4vCPU、16GB Ram、100GB Disk            |
| HostName   | quay.ocp.ken.lab                       |
| WorkDir    | /home/devop/clair                      |
| Postgresdb | clairuser / welcome1 / clairdb         |
| Clair      | v3.5.0                                 |
| Quay       | v3.7.3                                 |
| clairpod   | -p 5433:5432 -p 8081:8081 -p 8089:8089 |



| Quay           | 說明                          |
| :------------- | ----------------------------- |
| OS_User        | devop                         |
| OS             | RHEL8.5                       |
| OS_IP          | 192.168.3.28                  |
| WorkDir        | /home/devop                   |
| Postgresdb     | quayuser / welcome1           |
| quay admin     | quayadmin / welcome1          |
| redis password | welcome1                      |
| quay-pod port  | 80:8080、3306:3306、5432:5432 |
| Quay Version   | v3.7.3                        |
| Wordpresspod   | 8989:80、3307:3306            |



# 安裝步驟



## OS 設定

### Users

```
[root@quay ~]# useradd devop
[root@quay ~]# passwd devop
```

### Disk

```
[root@quay ~]# df -h
Filesystem             Size  Used Avail Use% Mounted on
devtmpfs               7.8G     0  7.8G   0% /dev
tmpfs                  7.8G     0  7.8G   0% /dev/shm
tmpfs                  7.8G  8.7M  7.8G   1% /run
tmpfs                  7.8G     0  7.8G   0% /sys/fs/cgroup
/dev/mapper/rhel-root   61G  2.8G   59G   5% /
/dev/sda2             1014M  207M  808M  21% /boot
/dev/mapper/rhel-home   30G  245M   30G   1% /home
/dev/sda1              599M  5.9M  594M   1% /boot/efi
tmpfs                  1.6G     0  1.6G   0% /run/user/0
tmpfs                  1.6G     0  1.6G   0% /run/user/1000
```

### NetWork

```
[root@quay ~]# nmcli c s
NAME    UUID                                  TYPE      DEVICE 
ens192  7e9a88db-859f-4580-bfc9-9fbe9c5985c6  ethernet  ens192 
[root@quay ~]# nmcli c mod ens192 ipv4.method manual ipv4.address 192.168.33.34/24 ipv4.gateway 192.168.33.251 ipv4.dns 168.95.1.1
[root@quay ~]# nmcli c u ens192 
[root@quay ~]# cat /etc/resolv.conf 
# Generated by NetworkManager
search ocp.ken.lab
nameserver 192.168.33.21
nameserver 168.95.1.1
```

### sudo 

```
[root@quay ~]# cat /etc/sudoers.d/devop 
devop ALL=(ALL) NOPASSWD: ALL
```

### subsciption

```
root@quay ~]# subscription-manager register
Registering to: subscription.rhsm.redhat.com:443/subscription
Username: ken.wang@infotech.com.tw
Password: 
The system has been registered with ID: 77693b7f-9bbe-412d-9e15-210c55e799ef
The registered system name is: quay.ocp.ken.lab
```

### yum

```
[root@quay ~]# yum repolist
Updating Subscription Management repositories.
repo id                                        repo name
rhel-8-for-x86_64-appstream-rpms               Red Hat Enterprise Linux 8 for x86_64 - AppStream (RPMs)
rhel-8-for-x86_64-baseos-rpms                  Red Hat Enterprise Linux 8 for x86_64 - BaseOS (RPMs)
```

### Install Podman

```
[root@quay ~]# yum install podman -y
[root@quay ~]# podman -v
podman version 4.1.1
```

## 環境設定

1. 建立 Clair_pod

   ```
   [devop@uat-quay ~]$ cat create_clairpod.sh 
   podman pod create --name=clairpod -p 5433:5432 -p 8081:8081 -p 8089:8089
   [devop@uat-quay ~]$ ./create_clairpod.sh 
   ```

2. 建立 Quay_pod

   ```
   [devop@quay quay]$ cat createpod.sh 
   podman pod create --name=quaypod -p 80:8080 -p 443:8443 -p 6379:6379 -p 5432:5432
   [devop@quay quay]$ ./createpod.sh 
   f3fcbd51ffa7454c4e8825806a07252a9072ed7d26ad092e6bd21eb992033948
   ```

3. 設定防火牆、SELinux

   ```
   [devop@quay quay]$ sudo systemctl disable firewalld --now
   [devop@quay quay]$ sudo su -
   [root@quay ~]# setenforce 0
   [root@quay ~]# vim /etc/selinux/config 
   [root@quay ~]# cat /etc/selinux/config 
   # This file controls the state of SELinux on the system.
   # SELINUX= can take one of these three values:
   #     enforcing - SELinux security policy is enforced.
   #     permissive - SELinux prints warnings instead of enforcing.
   #     disabled - No SELinux policy is loaded.
   SELINUX=disabled
   # SELINUXTYPE= can take one of these three values:
   #     targeted - Targeted processes are protected,
   #     minimum - Modification of targeted policy. Only selected processes are protected. 
   #     mls - Multi Level Security protection.
   SELINUXTYPE=targeted
   ```

4. 調整podman port binding權限

   ```
   sudo su -
   echo "net.ipv4.ip_unprivileged_port_start = 80" >> /etc/sysctl.conf
   [root@quay ~]# reboot
   ```

5. podman 登入 registry.redhat.io

   ```
   [devop@quay clair]$ podman login registry.redhat.io
   Username: ken.wang@infotech.com.tw
   Password: 
   Login Succeeded!
   ```

6. podman 登入 安裝quay時使用

   ```
   [devop@quay ~]$ cat podmanlogin.sh 
   #!/bin/bash
   podman login -u="redhat+quay" -p="O81WSHRSJR14UAZBK54GQHJS0P1V4CLWAJV1X2C4SD7KO59CQ9N3RE12612XU1HR" quay.io
   ```

7. 產生CA

   ```
   [devop@quay certs]$ cat gencert.sh 
   #!/bin/bash
   # Create certificate given a specific url name
   if [ $# -ne 1 ]
     then
       echo "No arguments supplied or too many arguments" 
       echo "Usage: $0 domain_name"
       exit 1
   fi
   
   MYNAME=$1
   
   echo "Generating a private key...for $MYNAME"
   openssl genrsa -out $MYNAME.key 4096
   
   echo "Generating a CSR...for $MYNAME"
   openssl req -new -key $MYNAME.key \
   -out $MYNAME.csr \
   -subj "/C=TW/ST=TW/L=Taipei/O=KEN/OU=LAB/CN=$MYNAME"
   
   echo "Generating a certificate...for $MYNAME"
   openssl x509 -req -days 366 -in \
   $MYNAME.csr -signkey \
   $MYNAME.key \
   -out $MYNAME.crt -extensions v3_req -extfile quay.cnf
   
   ---
   [devop@quay certs]$ cat quay.cnf 
   [req]
   req_extensions = v3_req
   distinguished_name = req_distinguished_name
   
   [req_distinguished_name]
   [ v3_req ]
   basicConstraints = CA:FALSE
   keyUsage = nonRepudiation, digitalSignature, keyEncipherment
   subjectAltName = @alt_names
   
   [alt_names]
   DNS.1 = quay.ocp.ken.lab
   DNS.2 = quay
   
   ---
   [devop@quay ~]$ ./gencert.sh quay.ocp.ken.lab
   Generating a private key...for quay.ocp.ken.lab
   Generating RSA private key, 2048 bit long modulus (2 primes)
   .....+++++
   .................................+++++
   e is 65537 (0x010001)
   Generating a CSR...for quay.ocp.ken.lab
   Generating a certificate...for quay.ocp.ken.lab
   Signature ok
   subject=C = TW, ST = TW, L = Taipei, O = KEN, OU = LAB, CN = quay.ocp.ken.lab
   Getting Private key
   ---
   [devop@quay certs]$ ll
   total 20
   -rwxrwxr-x 1 devop devop  600 Oct 17 17:13 gencert.sh
   -rw-rw-r-- 1 devop devop  279 Oct 17 17:12 quay.cnf
   -rw-rw-r-- 1 devop devop 1988 Oct 17 17:14 quay.ocp.ken.lab.crt
   -rw-rw-r-- 1 devop devop 1691 Oct 17 17:14 quay.ocp.ken.lab.csr
   -rw------- 1 devop devop 3243 Oct 17 17:14 quay.ocp.ken.lab.key
   ---
   [devop@quay certs]$ sudo cp quay.ocp.ken.lab.crt /etc/pki/ca-trust/source/anchors/
   [devop@quay certs]$ sudo update-ca-trust 
   [devop@quay certs]$ 
   
   ```

## 安裝DB Postgresql

1. 建立Clair_pgsql目錄

   ```
   [devop@uat-quay ~]$ mkdir -p /home/devop/var/lib/pgsql_clair/
   [devop@uat-quay ~]$ chmod 777 /home/devop/var/lib/pgsql_clair/
   ```

2. 建立Quay_pgsql目錄

   ```
   [devop@uat-quay ~]$ mkdir -p /home/devop/var/lib/pgsql
   [devop@uat-quay ~]$ chmod 777 /home/devop/var/lib/pgsql
   ```

2. 啟動Clair_pgsql

   ```
   [devop@uat-quay clair]$ cat start_pgsql_clair.sh 
   #!/bin/bash
   podman run -d --pod=clairpod --name=clair-pgsql \
   	   -e POSTGRESQL_ADMIN_PASSWORD=welcome1 \
   	   -e POSTGRESQL_USER=clairuser \
   	   -e POSTGRESQL_PASSWORD=welcome1 \
   	   -e POSTGRESQL_DATABASE=clairdb \
   	   -v /home/devop/var/lib/pgsql_clair:/var/lib/pgsql/data:Z \
   	   registry.redhat.io/rhel8/postgresql-10:1
   [devop@uat-quay clair]$ ./start_pgsql_clair.sh 
   ```

3. 建立Clairdb Extension

   ```
   [devop@uat-quay clair]$ cat test_pgsql_clair.sh 
   #!/bin/bash
   podman exec -it clair-pgsql /bin/bash -c 'echo "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\"" | psql -d clairdb -U postgres'
   [devop@uat-quay clair]$ ./test_pgsql_clair.sh 
   CREATE EXTENSION
   ```
   
3. 啟動Quay_pgsql

   ```
   [devop@quay quay]$ cat start_pgsql.sh 
   #!/bin/bash
   podman run -d --pod=quaypod --name=quay-pgsql \
   	   -e POSTGRESQL_ADMIN_PASSWORD=welcome1 \
   	   -e POSTGRESQL_USER=quayuser \
   	   -e POSTGRESQL_PASSWORD=welcome1 \
   	   -e POSTGRESQL_DATABASE=quaydb \
   	   -v /home/devop/var/lib/pgsql:/var/lib/pgsql/data:Z \
   	   registry.redhat.io/rhel8/postgresql-10:1
   ```
   
3. 建立 quaydb Extension

   ```
   [devop@quay quay]$ podman exec -it quay-pgsql /bin/bash -c 'echo "CREATE EXTENSION IF NOT EXISTS pg_trgm" | psql -d quaydb -U postgres'
   ```
   

## 安裝Redis

1. 建立redis資料夾

   ```
   mkdir -p /home/devop/var/lib/redis
   chmod 777 /home/devop/var/lib/redis
   ```


2. 安裝redis

   ```
   [devop@uat-quay ~]$ cat start_redis.sh
   #!/bin/bash
   podman run -d --pod=quaypod --name=quay-redis \
              -v /home/devop/var/lib/redis:/var/lib/redis/data:Z \
              -e REDIS_PASSWORD=welcome1 \
           registry.redhat.io/rhel8/redis-5:1
    
   [devop@quay quay]$ ./start_redis.sh 
   Trying to pull registry.redhat.io/rhel8/redis-5:1...
   Getting image source signatures
   Checking if image destination supports signatures
   Copying blob 8b33c6fa797f done  
   Copying blob f70d60810c69 done  
   Copying blob 545277d80005 done  
   Copying blob 399eb2b7226e done  
   Copying config c9df129d49 done  
   Writing manifest to image destination
   Storing signatures
   c2576cc7542ec7637d0fa044c53adc1d2123ffdc99f851901f891084301d579c
   ```

3. 確認container 狀態

   ```
   podman ps
   ```

## 配置Quay Config

1. podman 登入quay.io

   ```
   [devop@quay ~]$ cat podmanlogin.sh 
   #!/bin/bash
   podman login -u="redhat+quay" -p="O81WSHRSJR14UAZBK54GQHJS0P1V4CLWAJV1X2C4SD7KO59CQ9N3RE12612XU1HR" quay.io
   ---
   [devop@quay ~]$ ./podmanlogin.sh 
   Login Succeeded!
   ```

   安裝quay-config

   ```
   [devop@uat-quay ~]$ cat start_quay_config.sh
   #!/bin/bash
   podman run --rm -it --pod=quaypod --name=quay-config \
           registry.redhat.io/quay/quay-rhel8:v3.7.3 config welcome1
   
   ```

   ![image-20220831115811189](https://kenkenny.synology.me:5543/images/2023/09/image-20220831115811189.png)

2. 連線網頁 http://quay.ocp.ken.lab  quayconfig welcome1

3. 左下角共有五項需設定 Hostname、DB、Redis，上傳憑證

   ![image-20220831115921288](https://kenkenny.synology.me:5543/images/2023/09/image-20220831115921288.png)

4. 設定Server Hostname & TLS : quay.ocp.ken.lab
   ![image-20221014145935943](https://kenkenny.synology.me:5543/images/2023/09/image-20221014145935943.png)

5. 設定DB 資訊

   ```
   Database Server: quay.ocp.ken.lab:5432
   Username:		quayuser
   Password:		welcome1
   Database Name: 	 quaydb
   ```

   ![image-20221014145956804](https://kenkenny.synology.me:5543/images/2023/09/image-20221014145956804.png)

   

6. 設定redis Hostname

   ```
   Redis Hostname: quay.ocp.ken.lab
   Redis Port: 6379
   Redis password: welcome1
   ```

   ![image-20221014150016457](https://kenkenny.synology.me:5543/images/2023/09/image-20221014150016457.png)



#### Enable Security Scanner

	##### Enable Security Scanner & Generate PSK
	PSK: MTg4MDJnaTQ3OWRjYw==

![image-20221014150103834](https://kenkenny.synology.me:5543/images/2023/09/image-20221014150103834.png)

9. 保存設定並下載設定檔，並關閉quay-config 

   ![image-20220831120853324](https://kenkenny.synology.me:5543/images/2023/09/image-20220831120853324.png)


   ![image-20220830154235463](https://kenkenny.synology.me:5543/images/2023/09/image-20220830154235463.png)

   

## 解壓縮Config

1. 下載後解壓縮

   ```
   [devop@quay quay]$ tar xvf quay-config.tar.gz 
   extra_ca_certs/
   config.yaml
   ssl.cert
   ssl.key
   
   ```

## 設定 Clair並啟動

1. 建立Clair目錄

   ```
   [devop@uat-quay ~]$ mkdir -p /home/devop/mnt/clair/config
   [devop@uat-quay ~]$ chmod 777 /home/devop/mnt/clair/config
   ```

2. 配置clair的config.yaml  >> 要在quay_config階段時Enable Security Scanner 並Generate PSK

   ```
   [devop@uat-quay ~]$ cat prekey.txt 
   MTg4MDJnaTQ3OWRjYw==
   [devop@uat-quay clair]$ vim config.yaml
   http_listen_addr: :8081
   introspection_addr: :8089
   log_level: info
   indexer:
     connstring: host=quay.ocp.ken.lab port=5433 dbname=clairdb user=clairuser password=welcome1 sslmode=disable
     scanlock_retry: 10
     layer_scan_concurrency: 5
     migrations: true
   matcher:
     connstring: host=quay.ocp.ken.lab port=5433 dbname=clairdb user=clairuser password=welcome1 sslmode=disable
     max_conn_pool: 100
     run: ""
     migrations: true
     indexer_addr: clair-indexer
   notifier:
     connstring: host=quay.ocp.ken.lab port=5433 dbname=clairdb user=clairuser password=welcome1 sslmode=disable
     delivery_interval: 1m
     poll_interval: 5m
     migrations: true
   auth:
     psk:
       key: "MTg4MDJnaTQ3OWRjYw=="
       iss: ["quay"]
       
   ---
   [devop@uat-quay clair]$ cp config /home/devop/mnt/clair/config/config.yaml
   ```

3. 啟動Clair ( 先停止Quay )

   ```
   [devop@uat-quay clair]$ podman login registry.redhat.io
   Username: ken.wang@infotech.com.tw
   Password: 
   Login Succeeded!
   
   [devop@quay clair]$ cat start_clair.sh 
   #!/bin/bash
   podman run -d --pod clairpod --name clair -e CLAIR_CONF=/clair/config.yaml \
   	-e CLAIR_MODE=combo -e SSL_CERT_DIR=/etc/pki/tls/certs \
   	-v /home/devop/mnt/clair/config:/clair:Z \
   	-v /home/devop/mnt/quay/certs/quay.ocp.ken.lab.crt:/etc/pki/tls/certs/quay.ocp.ken.lab:Z \
   	registry.redhat.io/quay/clair-rhel8:v3.5.0
   
   [devop@quay clair]$ ./start_clair.sh 
   Trying to pull registry.redhat.io/quay/clair-rhel8:v3.5.0...
   Getting image source signatures
   Checking if image destination supports signatures
   Copying blob d821702c1e09 done  
   Copying blob 13897c84ca57 done  
   Copying blob 64607cc74f9c done  
   Copying config 10e4c3931b done  
   Writing manifest to image destination
   Storing signatures
   4d428098362e17ae606dad5412756f880ab40420af4f7a376170242064963154
   ```

4. 確認container狀態

   ```
   [devop@quay clair]$ podman ps
   CONTAINER ID  IMAGE                                     COMMAND         CREATED            STATUS                PORTS                                                                                        NAMES
   eb65b55e9875  localhost/podman-pause:4.1.1-1657551413                   About an hour ago  Up About an hour ago  0.0.0.0:5433->5432/tcp, 0.0.0.0:8081->8081/tcp, 0.0.0.0:8089->8089/tcp                       535faabcd216-infra
   4b465bef2476  registry.redhat.io/rhel8/postgresql-10:1  run-postgresql  About an hour ago  Up About an hour ago  0.0.0.0:5433->5432/tcp, 0.0.0.0:8081->8081/tcp, 0.0.0.0:8089->8089/tcp                       clair-pgsql
   154a0b6a0803  localhost/podman-pause:4.1.1-1657551413                   About an hour ago  Up About an hour ago  0.0.0.0:80->8080/tcp, 0.0.0.0:443->8443/tcp, 0.0.0.0:5432->5432/tcp, 0.0.0.0:6379->6379/tcp  da7ca63d2ac6-infra
   518b5db0591a  registry.redhat.io/rhel8/postgresql-10:1  run-postgresql  About an hour ago  Up About an hour ago  0.0.0.0:80->8080/tcp, 0.0.0.0:443->8443/tcp, 0.0.0.0:5432->5432/tcp, 0.0.0.0:6379->6379/tcp  quay-pgsql
   c2576cc7542e  registry.redhat.io/rhel8/redis-5:1        run-redis       46 minutes ago     Up 46 minutes ago     0.0.0.0:80->8080/tcp, 0.0.0.0:443->8443/tcp, 0.0.0.0:5432->5432/tcp, 0.0.0.0:6379->6379/tcp  quay-redis
   ```

5. 確認更新完成即可啟動Quay (約3分鐘)

   ```
   [devop@uat-quay clair]$ podman logs --tail 10 clair
   {"level":"info","component":"libvuln/New","component":"libvuln/updateDriver/RunUpdaters","component":"internal/updater/Executor","run_id":1879968118,"updater":"photon-updater-photon3","component":"photon/Updater.Parse","time":"2022-09-14T05:21:38Z","time":"2022-09-14T05:21:38Z","message":"starting parse"}
   {"level":"info","component":"libvuln/New","component":"libvuln/updateDriver/RunUpdaters","component":"internal/updater/Executor","run_id":1879968118,"updater":"RHEL8-advanced-virtualization","ref":"0f18ac9b-223f-460d-96ed-08ea268e278e","time":"2022-09-14T05:22:38Z","time":"2022-09-14T05:22:38Z","message":"successful update"}
   {"level":"info","component":"libvuln/New","component":"libvuln/updateDriver/RunUpdaters","component":"internal/updater/Executor","run_id":1879968118,"updater":"photon-updater-photon1","ref":"b1ea50fa-b89c-4f94-a182-a65a9284125a","time":"2022-09-14T05:22:48Z","time":"2022-09-14T05:22:48Z","message":"successful update"}
   ```

## 啟動Quay

1. 啟動Quay

   ```
   ##建立quay資料夾 並將config 、 CA 放到
   [devop@quay quay]$ mkdir -p /home/devop/mnt/quay/storage
   [devop@quay quay]$ mkdir -p /home/devop/mnt/quay/storage
   [devop@quay quay]$ mkdir -P /home/devop/mnt/quay/certs/
   [devop@quay quay]$ chmod 777 /home/devop/mnt/quay/storage
   [devop@quay quay]$ chmod 777 /home/devop/mnt/quay/config
   [devop@quay quay]$ chmod 777 /home/devop/mnt/quay/certs
   [devop@quay quay]$ cp config.yaml /home/devop/mnt/quay/config/
   [devop@quay certs]$ cp quay.ocp.ken.lab.* /home/devop/mnt/quay/certs
   [devop@quay config]$ ll
   total 16
   -rwxrwxr-x 1 devop devop 2365 Jan  1  1970 config.yaml
   drwxrwxr-x 2 devop devop    6 Jan  1  1970 extra_ca_certs
   -rw-r--r-- 1 devop devop 3312 Oct 14 16:10 quay-config.tar.gz
   -rwxrwxr-x 1 devop devop 1204 Jan  1  1970 ssl.cert
   -rwxrwxr-x 1 devop devop 1679 Jan  1  1970 ssl.key
   [devop@quay config]$ cd
   
   [devop@uat-quay ~]$ cat start_quay.sh 
   #!/bin/bash
   podman run -d --pod=quaypod --name=quay \
     	-v /home/devop/mnt/quay/config:/conf/stack:Z \
          	-v /home/devop/mnt/quay/storage:/datastorage:Z \
          	registry.redhat.io/quay/quay-rhel8:v3.7.3
   
   [devop@uat-quay ~]$ ./start_quay.sh 
   5f1915f2038f4167fd6e37c4233903dbad7de00acd6e753957ed9ff66b2d8ba2
   [devop@quay quay]$ podman ps
   CONTAINER ID  IMAGE                                       COMMAND         CREATED            STATUS                PORTS                                                                                        NAMES
   eb65b55e9875  localhost/podman-pause:4.1.1-1657551413                     About an hour ago  Up About an hour ago  0.0.0.0:5433->5432/tcp, 0.0.0.0:8081->8081/tcp, 0.0.0.0:8089->8089/tcp                       535faabcd216-infra
   4b465bef2476  registry.redhat.io/rhel8/postgresql-10:1    run-postgresql  About an hour ago  Up About an hour ago  0.0.0.0:5433->5432/tcp, 0.0.0.0:8081->8081/tcp, 0.0.0.0:8089->8089/tcp                       clair-pgsql
   154a0b6a0803  localhost/podman-pause:4.1.1-1657551413                     About an hour ago  Up About an hour ago  0.0.0.0:80->8080/tcp, 0.0.0.0:443->8443/tcp, 0.0.0.0:5432->5432/tcp, 0.0.0.0:6379->6379/tcp  da7ca63d2ac6-infra
   518b5db0591a  registry.redhat.io/rhel8/postgresql-10:1    run-postgresql  About an hour ago  Up About an hour ago  0.0.0.0:80->8080/tcp, 0.0.0.0:443->8443/tcp, 0.0.0.0:5432->5432/tcp, 0.0.0.0:6379->6379/tcp  quay-pgsql
   c2576cc7542e  registry.redhat.io/rhel8/redis-5:1          run-redis       About an hour ago  Up About an hour ago  0.0.0.0:80->8080/tcp, 0.0.0.0:443->8443/tcp, 0.0.0.0:5432->5432/tcp, 0.0.0.0:6379->6379/tcp  quay-redis
   3c9b87b803d3  registry.redhat.io/quay/clair-rhel8:v3.5.0                  12 minutes ago     Up 12 minutes ago     0.0.0.0:5433->5432/tcp, 0.0.0.0:8081->8081/tcp, 0.0.0.0:8089->8089/tcp                       clair
   
   
   ```

2. 開啟瀏覽器連線 https://quay.ocp.ken.lab  quayadmin/welcome1
   ![image-20221017172605042](https://kenkenny.synology.me:5543/images/2023/09/image-20221017172605042.png)

3. 確認憑證
   ![image-20221017172616780](https://kenkenny.synology.me:5543/images/2023/09/image-20221017172616780.png)

4. 建立管理員帳號、密碼，Create Account

   ```
   Username: quayadmin
   E-mail: quayadmin@email.com
   Password: welcome1
   ```

   ![image-20220831122552327](https://kenkenny.synology.me:5543/images/2023/09/image-20220831122552327.png)

5. 登入確認
   ![image-20220831122620702](https://kenkenny.synology.me:5543/images/2023/09/image-20220831122620702.png)

   

# 測試Clair

1. 測試pull & push (憑證可透過 --tls-verify=false解決 or 將憑證放到podman 設定檔路徑)

```
[devop@quay ~]$ openssl x509 -in certs/quay.ocp.ken.lab.crt -out certs/quay.ocp.ken.lab.cert
[devop@quay ~]$ podman login quay.ocp.ken.lab --cert-dir=/home/devop/certs/
Username: quayadmin
Password: 
Login Succeeded!
-----
[devop@quay ~]$ sudo mkdir /etc/containers/certs.d/quay.ocp.ken.lab
[devop@quay ~]$ sudo cp /home/devop/certs/quay.ocp.ken.lab.crt /etc/containers/certs.d/quay.ocp.ken.lab/
＃＃＃重開terminal
-----
[devop@quay ~]$ podman pull docker.io/library/ubuntu:20.04
Trying to pull docker.io/library/ubuntu:20.04...
Getting image source signatures
Copying blob fb0b3276a519 done  
Copying config 817578334b done  
Writing manifest to image destination
Storing signatures
817578334b4dd5e2b0654610e895e08e1bea996c58119bb9c7e3bd9e74dd8936
[devop@quay ~]$ podman tag docker.io/library/ubuntu:20.04 quay.ocp.ken.lab/quayadmin/ubuntu:20.04
[devop@quay ~]$ podman push quay.ocp.ken.lab/quayadmin/ubuntu:20.04 --cert-dir=/home/devop/certs/
Getting image source signatures
Copying blob cdca8156a203 done  
Copying config 817578334b done  
Writing manifest to image destination
Storing signatures
```

![image-20221017174835521](https://kenkenny.synology.me:5543/images/2023/09/image-20221017174835521.png)

2. 查看Security Scan
   
   ![image-20221017174905497](https://kenkenny.synology.me:5543/images/2023/09/image-20221017174905497.png)
   
   

