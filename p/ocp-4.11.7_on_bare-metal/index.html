<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="OCP-4.11.7_on_Bare-metal"><title>OCP-4.11.7_on_Bare-metal</title>
<link rel=canonical href=https://wangken0129.github.io/p/ocp-4.11.7_on_bare-metal/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="OCP-4.11.7_on_Bare-metal"><meta property='og:description' content="OCP-4.11.7_on_Bare-metal"><meta property='og:url' content='https://wangken0129.github.io/p/ocp-4.11.7_on_bare-metal/'><meta property='og:site_name' content="Ken's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Openshift'><meta property='article:tag' content='Redhat'><meta property='article:tag' content='Kubernetes'><meta property='article:published_time' content='2023-09-23T08:18:45+08:00'><meta property='article:modified_time' content='2023-09-23T08:18:45+08:00'><meta name=twitter:title content="OCP-4.11.7_on_Bare-metal"><meta name=twitter:description content="OCP-4.11.7_on_Bare-metal"><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切換選單>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_c68a00bbf16dac8.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🇹🇼</span></figure><div class=site-meta><h1 class=site-name><a href=/>Ken's blog</a></h1><h2 class=site-description>紀錄與分享，當個快樂的工程師</h2></div></header><ol class=menu-social><li><a href=https://github.com/wangken0129/wangken0129.github.io target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/ken-wang-88924b181/ target=_blank title=LinkedIn rel=me><svg class="icon icon-tabler icon-tabler-brand-linkedin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4m0 2a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2z"/><path d="M8 11v5"/><path d="M8 8v.01"/><path d="M12 16v-5"/><path d="M16 16v-3a2 2 0 00-4 0"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>夜晚模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目錄</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#參考連結>參考連結</a></li><li><a href=#架構>架構</a></li><li><a href=#安裝bastion>安裝Bastion</a><ol><li><a href=#安裝rhel-90--on-esxi>安裝RHEL 9.0 on ESXi</a></li><li><a href=#設定-ssh-key>設定 SSH Key</a></li><li><a href=#安裝oc-cli>安裝OC CLI</a></li><li><a href=#安裝dhcp-server-optional>安裝DHCP Server (optional)</a></li><li><a href=#安裝dns-server-named>安裝DNS Server (named)</a></li><li><a href=#安裝ha-proxy>安裝HA Proxy</a></li><li><a href=#下載pull-secret-token>下載Pull Secret Token</a></li><li><a href=#下載安裝openshift-installer>下載安裝openshift installer</a></li><li><a href=#下載-coreos>下載 CoreOS</a></li><li><a href=#準備安裝soruce>準備安裝Soruce</a><ol><li><a href=#創建install-configyaml>創建install-config.yaml</a></li><li><a href=#建立k8s-manifest--files>建立K8S manifest files</a></li><li><a href=#ｍastersschedulablefalse>ＭastersSchedulable:false</a></li><li><a href=#創建ignition-config-file>創建Ignition config file</a></li></ol></li><li><a href=#安裝http-web-server>安裝Http Web Server</a></li></ol></li><li><a href=#安裝bootstrap>安裝BootStrap</a></li><li><a href=#安裝-ｍaster-node>安裝 Ｍaster Node</a></li><li><a href=#安裝-workerinfra-node>安裝 Worker＆Infra Node</a></li><li><a href=#安裝後的設定>安裝後的設定</a><ol><li><ol><li><a href=#設定nfs>設定NFS</a></li><li><a href=#設定外部image-registry>設定外部Image Registry</a></li><li><a href=#設定htpasswd-provider>設定Htpasswd Provider</a></li><li><a href=#註冊openshift-cluster>註冊openshift cluster</a></li><li><a href=#設定oc-cli-ca>設定OC CLI CA</a></li><li><a href=#拆分infra-node>拆分Infra Node</a></li><li><a href=#operator移動到infra-node>Operator移動到Infra Node</a></li></ol></li></ol></li><li><a href=#問題排除>問題排除</a><ol><li><a href=#調整>調整</a><ol><li></li></ol></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/lab-category/ style=background-color:#2a9d8f;color:#fff>Lab Category</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/ocp-4.11.7_on_bare-metal/>OCP-4.11.7_on_Bare-metal</a></h2><h3 class=article-subtitle>OCP-4.11.7_on_Bare-metal</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Sep 23, 2023</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>閱讀時間: 28 分鐘</time></div></footer></div></header><section class=article-content><h1 id=install-openshift-v4117-on-bare-metal>Install Openshift v4.11.7 on Bare-metal</h1><p>Ken Wang 2022/10/03</p><p>Ken Wang 2022/11/23 v4.11.9</p><h2 id=參考連結>參考連結</h2><p><a class=link href=https://docs.openshift.com/container-platform/4.11/welcome/index.html target=_blank rel=noopener>https://docs.openshift.com/container-platform/4.11/welcome/index.html</a></p><p><a class=link href=https://access.redhat.com/documentation/en-us/openshift_container_platform/4.11/html/installing/installing-on-bare-metal#installing-bare-metal target=_blank rel=noopener>https://access.redhat.com/documentation/en-us/openshift_container_platform/4.11/html/installing/installing-on-bare-metal#installing-bare-metal</a></p><p><a class=link href=https://docs.openshift.com/container-platform/4.11/installing/installing_bare_metal/installing-bare-metal.html#installing-bare-metal target=_blank rel=noopener>https://docs.openshift.com/container-platform/4.11/installing/installing_bare_metal/installing-bare-metal.html#installing-bare-metal</a></p><p>CoreOS:
<a class=link href=https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/4.11/4.11.2/ target=_blank rel=noopener>https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/4.11/4.11.2/</a>
<a class=link href=https://mirror.openshift.com/pub/openshift-v4/x86_64/dependencies/rhcos/4.11/4.11.9/rhcos-4.11.9-x86_64-live.x86_64.iso target=_blank rel=noopener>https://mirror.openshift.com/pub/openshift-v4/x86_64/dependencies/rhcos/4.11/4.11.9/rhcos-4.11.9-x86_64-live.x86_64.iso</a></p><p>OC Client:
<a class=link href=https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/4.11.9/openshift-client-linux.tar.gz target=_blank rel=noopener>https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/4.11.9/openshift-client-linux.tar.gz</a></p><p><a class=link href=https://docs.openshift.com/container-platform/4.11/post_installation_configuration/index.html target=_blank rel=noopener>https://docs.openshift.com/container-platform/4.11/post_installation_configuration/index.html</a></p><p><a class=link href=https://github.com/I8C/installing-openshift-on-single-vmware-esxi-host/blob/master/installBastion.sh target=_blank rel=noopener>https://github.com/I8C/installing-openshift-on-single-vmware-esxi-host/blob/master/installBastion.sh</a></p><p>僅供參考 <a class=link href=https://github.com/alanadiprastyo/openshift-4.6 target=_blank rel=noopener>https://github.com/alanadiprastyo/openshift-4.6</a></p><p>automated</p><p><a class=link href=https://cloud.redhat.com/blog/fully-automated-openshift-deployments-with-vmware-vsphere target=_blank rel=noopener>https://cloud.redhat.com/blog/fully-automated-openshift-deployments-with-vmware-vsphere</a></p><h2 id=架構>架構</h2><p>針對各版本的coreOS、Openshift-install 都要更新</p><div class=table-wrapper><table><thead><tr><th style=text-align:left>主機名稱</th><th>IP</th><th>Mac</th><th>版本</th><th>功能</th><th>磁碟空間</th></tr></thead><tbody><tr><td style=text-align:left>bastion.ken.lab</td><td>192.168.33.21</td><td>00:50:56:91:7c:24</td><td>RHEL 9.0</td><td>management</td><td>100G、200G</td></tr><tr><td style=text-align:left>bootstrap.ocp.ken.lab</td><td>192.168.33.22</td><td>00:50:56:91:47:e9</td><td>core 4.11-2</td><td>bootstrap</td><td>100G</td></tr><tr><td style=text-align:left>master1.ocp.ken.lab</td><td>192.168.33.23</td><td>00:50:56:91:88:f4</td><td>core 4.11-2</td><td>master</td><td>100G</td></tr><tr><td style=text-align:left>master2.ocp.ken.lab</td><td>192.168.33.24</td><td>00:50:56:91:27:ed</td><td>core 4.11-2</td><td>master</td><td>100G</td></tr><tr><td style=text-align:left>master3.ocp.ken.lab</td><td>192.168.33.25</td><td>00:50:56:91:08:33</td><td>core 4.11-2</td><td>master</td><td>100G</td></tr><tr><td style=text-align:left>worker1.ocp.ken.lab</td><td>192.168.33.26</td><td>00:50:56:91:c6:29</td><td>core 4.11-2</td><td>worker</td><td>100G</td></tr><tr><td style=text-align:left>worker2.ocp.ken.lab</td><td>192.168.33.27</td><td>00:50:56:91:d7:b4</td><td>core 4.11-2</td><td>worker</td><td>100G</td></tr><tr><td style=text-align:left>infra1.ocp.ken.lab</td><td>192.168.33.31</td><td>00:50:56:91:14:ab</td><td>core 4.11-2</td><td>infra node</td><td>100G</td></tr><tr><td style=text-align:left>infra2.ocp.ken.lab</td><td>192.168.33.32</td><td>00:50:56:91:0a:53</td><td>core 4.11-2</td><td>infra node</td><td>100G</td></tr><tr><td style=text-align:left>infra3.ocp.ken.lab</td><td>192.168.33.33</td><td>00:50:56:91:78:05</td><td>core 4.11-2</td><td>infra node</td><td>100G</td></tr></tbody></table></div><div class=table-wrapper><table><thead><tr><th>主機名稱</th><th>使用者帳密</th><th>安裝目錄</th><th></th></tr></thead><tbody><tr><td>bastion.ken.lab</td><td>devop / redhat</td><td>/home/devop/ocp</td><td></td></tr></tbody></table></div><h2 id=安裝bastion>安裝Bastion</h2><h3 id=安裝rhel-90--on-esxi>安裝RHEL 9.0 on ESXi</h3><p><a class=link href=https://kb.vmware.com/s/article/57122 target=_blank rel=noopener>https://kb.vmware.com/s/article/57122</a></p><ol><li><p>用iso 檔開機進入安裝引導畫面
<img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221003152533576.png loading=lazy alt=image-20221003152533576></p></li><li><p>設定磁碟、註冊、安裝軟體</p><ul><li>磁碟配置
/ &#187; 65GiB
/home &#187; 29GiB
/boot &#187; 500MiB
/boot/efi &#187; 1GiB</li><li>軟體安裝 使用GUI畫面
Server With GUI</li><li>註冊
<a class=link href=mailto:ken.wang@infotech.com.tw>ken.wang@infotech.com.tw</a></li></ul></li><li><p>開始安裝，安裝完畢後進入OS
<img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221003153827189.png loading=lazy alt=image-20221003153827189></p></li><li><p>設定sudo</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@bastion ~]# echo &#34;devop    ALL=(ALL)       ALL&#34; &gt;&gt; /etc/sudoers.d/devop
</span></span></code></pre></td></tr></table></div></div></li></ol><hr><h3 id=設定-ssh-key>設定 SSH Key</h3><ol><li><p>產生ssh keygen &ndash; devop user
用來登入各節點使用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ~]$ ssh-keygen -t ed25519 -N &#39;&#39; -f ~/.ssh/id_ed25519
</span></span><span class=line><span class=cl>Generating public/private ed25519 key pair.
</span></span><span class=line><span class=cl>Created directory &#39;/home/devop/.ssh&#39;.
</span></span><span class=line><span class=cl>Your identification has been saved in /home/devop/.ssh/id_ed25519
</span></span><span class=line><span class=cl>Your public key has been saved in /home/devop/.ssh/id_ed25519.pub
</span></span><span class=line><span class=cl>The key fingerprint is:
</span></span><span class=line><span class=cl>SHA256:G91wVoISB5qA881zCUi71a2hHj2Y+3zPD6RJQW5+edM devop@bastion.ocp.ken.lab
</span></span><span class=line><span class=cl>The key&#39;s randomart image is:
</span></span><span class=line><span class=cl>+--[ED25519 256]--+
</span></span><span class=line><span class=cl>|   oo.  ooo.. .  |
</span></span><span class=line><span class=cl>|  o .o.+.=.  o   |
</span></span><span class=line><span class=cl>|   o.o+.oo* o    |
</span></span><span class=line><span class=cl>|    .o+=o* * . . |
</span></span><span class=line><span class=cl>|    . =oS + = o E|
</span></span><span class=line><span class=cl>|     . o = = . . |
</span></span><span class=line><span class=cl>|      o . o .    |
</span></span><span class=line><span class=cl>|       o  .. .   |
</span></span><span class=line><span class=cl>|        o. .o..  |
</span></span><span class=line><span class=cl>+----[SHA256]-----+
</span></span></code></pre></td></tr></table></div></div></li><li><p>查看public key &#187; 之後會寫入install-config.yaml</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ~]$ cat .ssh/id_ed25519.pub 
</span></span><span class=line><span class=cl>ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIN1Z2jXmGnPWGAVrtltN9A2q5D8QtJlRvhvdB2QXoZG devop@bastion.ocp.ken.lab
</span></span></code></pre></td></tr></table></div></div></li><li><p>加入私密金鑰到ssh agent</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ~]$ ssh-add .ssh/id_ed25519
</span></span><span class=line><span class=cl>Identity added: .ssh/id_ed25519 (devop@bastion.ocp.ken.lab)
</span></span></code></pre></td></tr></table></div></div><hr></li></ol><h3 id=安裝oc-cli>安裝OC CLI</h3><ol><li><p>從此處下載OC Client
<a class=link href="https://access.redhat.com/downloads/content/290/ver=4.11/rhel---8/4.11.7/x86_64/product-software" target=_blank rel=noopener>https://access.redhat.com/downloads/content/290/ver=4.11/rhel---8/4.11.7/x86_64/product-software</a>
<a class=link href=https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/4.11.9/openshift-client-linux.tar.gz target=_blank rel=noopener>https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/4.11.9/openshift-client-linux.tar.gz</a></p></li><li><p>安裝OC Client</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion oc]$ pwd
</span></span><span class=line><span class=cl>/home/devop/oc
</span></span><span class=line><span class=cl>[devop@bastion oc]$ tar xvzf oc-4.11.7-linux.tar.gz 
</span></span><span class=line><span class=cl>README.md
</span></span><span class=line><span class=cl>kubectl
</span></span><span class=line><span class=cl>oc
</span></span><span class=line><span class=cl>[devop@bastion oc]$ sudo cp oc kubectl /usr/local/bin/
</span></span><span class=line><span class=cl>[sudo] password for devop: 
</span></span><span class=line><span class=cl>[devop@bastion oc]$ oc
</span></span><span class=line><span class=cl>OpenShift Client
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>This client helps you develop, build, deploy, and run your applications on any
</span></span><span class=line><span class=cl>OpenShift or Kubernetes cluster. It also includes the administrative
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div><p>啟用 tab 自動完成功能</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ocp]$ oc completion bash &gt; oc_bash_completion
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ sudo cp oc_bash_completion /etc/bash_completion.d/
</span></span><span class=line><span class=cl>[sudo] password for devop: 
</span></span><span class=line><span class=cl>## 重新啟動terminal
</span></span></code></pre></td></tr></table></div></div><hr></li></ol><h3 id=安裝dhcp-server-optional>安裝DHCP Server (optional)</h3><ol><li><p>安裝dhcpd</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@bastion ~]# yum install dhcp-server
</span></span></code></pre></td></tr></table></div></div></li><li><p>修改dhcpd設定檔 /etc/dhcp/dhcpd.conf</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@bastion dhcp]# cat dhcpd.conf 
</span></span><span class=line><span class=cl>#
</span></span><span class=line><span class=cl># DHCP Server Configuration file.
</span></span><span class=line><span class=cl>#   see /usr/share/doc/dhcp-server/dhcpd.conf.example
</span></span><span class=line><span class=cl>#   see dhcpd.conf(5) man page
</span></span><span class=line><span class=cl>#
</span></span><span class=line><span class=cl># dhcpd.conf
</span></span><span class=line><span class=cl># 2022.10.11 ken wang
</span></span><span class=line><span class=cl>default-lease-time 600;
</span></span><span class=line><span class=cl>max-lease-time 7200;
</span></span><span class=line><span class=cl>option broadcast-address 192.168.33.255;
</span></span><span class=line><span class=cl>subnet 192.168.33.0 netmask 255.255.255.0 {}
</span></span><span class=line><span class=cl>## gateway
</span></span><span class=line><span class=cl>option routers 192.168.33.251;
</span></span><span class=line><span class=cl>option domain-name &#34;ocp.ken.lab&#34;;
</span></span><span class=line><span class=cl>option domain-name-servers 192.168.33.21, 168.95.1.1;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Use this to send dhcp log messages to a different log file (you also
</span></span><span class=line><span class=cl># have to hack syslog.conf to complete the redirection).
</span></span><span class=line><span class=cl>log-facility local7;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>#  range 192.168.33.22 192.168.33.40;
</span></span><span class=line><span class=cl>host bootstrap {
</span></span><span class=line><span class=cl>  hardware ethernet 00:50:56:91:47:e9;
</span></span><span class=line><span class=cl>  fixed-address 192.168.33.22;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>host master1 {
</span></span><span class=line><span class=cl>  hardware ethernet 00:50:56:91:88:f4;
</span></span><span class=line><span class=cl>  fixed-address 192.168.33.23;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>host master2 {
</span></span><span class=line><span class=cl>  hardware ethernet 00:50:56:91:27:ed;
</span></span><span class=line><span class=cl>  fixed-address 192.168.33.24;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>host master3 {
</span></span><span class=line><span class=cl>  hardware ethernet 00:50:56:91:08:33;
</span></span><span class=line><span class=cl>  fixed-address 192.168.33.25;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>host worker1 {
</span></span><span class=line><span class=cl>  hardware ethernet 00:50:56:91:c6:29;
</span></span><span class=line><span class=cl>  fixed-address 192.168.33.26;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>host worker2 {
</span></span><span class=line><span class=cl>  hardware ethernet 00:50:56:91:d7:b4;
</span></span><span class=line><span class=cl>  fixed-address 192.168.33.27;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>host infra1 {
</span></span><span class=line><span class=cl>  hardware ethernet 00:50:56:91:14:ab;
</span></span><span class=line><span class=cl>  fixed-address 192.168.33.31;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>host infra2 {
</span></span><span class=line><span class=cl>  hardware ethernet 00:50:56:91:0a:53;
</span></span><span class=line><span class=cl>  fixed-address 192.168.33.32;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>host infra3 {
</span></span><span class=line><span class=cl>  hardware ethernet 00:50:56:91:78:05;
</span></span><span class=line><span class=cl>  fixed-address 192.168.33.33;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div></li><li><p>啟動dhcp-server測試</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=n>dhcp</span><span class=p>]</span><span class=c1># systemctl status dhcpd</span>
</span></span><span class=line><span class=cl><span class=err>●</span> <span class=n>dhcpd</span><span class=o>.</span><span class=n>service</span> <span class=o>-</span> <span class=n>DHCPv4</span> <span class=n>Server</span> <span class=n>Daemon</span>
</span></span><span class=line><span class=cl>     <span class=n>Loaded</span><span class=p>:</span> <span class=n>loaded</span> <span class=p>(</span><span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>lib</span><span class=o>/</span><span class=n>systemd</span><span class=o>/</span><span class=n>system</span><span class=o>/</span><span class=n>dhcpd</span><span class=o>.</span><span class=n>service</span><span class=p>;</span> <span class=n>disabled</span><span class=p>;</span> <span class=n>vendor</span> <span class=n>preset</span><span class=p>:</span> <span class=n>disabled</span><span class=p>)</span>
</span></span><span class=line><span class=cl>     <span class=n>Active</span><span class=p>:</span> <span class=n>active</span> <span class=p>(</span><span class=n>running</span><span class=p>)</span> <span class=n>since</span> <span class=n>Tue</span> <span class=mi>2022</span><span class=o>-</span><span class=mi>10</span><span class=o>-</span><span class=mi>11</span> <span class=mi>11</span><span class=p>:</span><span class=mi>07</span><span class=p>:</span><span class=mi>02</span> <span class=n>CST</span><span class=p>;</span> <span class=mi>10</span><span class=n>s</span> <span class=n>ago</span>
</span></span></code></pre></td></tr></table></div></div></li></ol><hr><h3 id=安裝dns-server-named>安裝DNS Server (named)</h3><ol><li><p>安裝named</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@bastion dhcp]# yum install bind bind-libs bind-chroot bind-utils
</span></span></code></pre></td></tr></table></div></div></li><li><p>修改named 設定檔 /etc/named.conf</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=n>data</span><span class=p>]</span><span class=c1># cat /etc/named.conf </span>
</span></span><span class=line><span class=cl><span class=o>//</span>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=n>named</span><span class=o>.</span><span class=n>conf</span>
</span></span><span class=line><span class=cl><span class=o>//</span>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=n>Provided</span> <span class=n>by</span> <span class=n>Red</span> <span class=n>Hat</span> <span class=n>bind</span> <span class=n>package</span> <span class=n>to</span> <span class=n>configure</span> <span class=n>the</span> <span class=n>ISC</span> <span class=n>BIND</span> <span class=n>named</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span> <span class=n>DNS</span>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=n>server</span> <span class=n>as</span> <span class=n>a</span> <span class=n>caching</span> <span class=n>only</span> <span class=n>nameserver</span> <span class=p>(</span><span class=n>as</span> <span class=n>a</span> <span class=n>localhost</span> <span class=n>DNS</span> <span class=n>resolver</span> <span class=n>only</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=o>//</span>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=n>See</span> <span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>share</span><span class=o>/</span><span class=n>doc</span><span class=o>/</span><span class=n>bind</span><span class=o>*/</span><span class=n>sample</span><span class=o>/</span> <span class=k>for</span> <span class=n>example</span> <span class=n>named</span> <span class=n>configuration</span> <span class=n>files</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=o>//</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>options</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>listen</span><span class=o>-</span><span class=n>on</span> <span class=n>port</span> <span class=mi>53</span> <span class=p>{</span> <span class=mf>192.168</span><span class=o>.</span><span class=mf>33.21</span><span class=p>;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>	<span class=o>//</span><span class=n>listen</span><span class=o>-</span><span class=n>on</span><span class=o>-</span><span class=n>v6</span> <span class=n>port</span> <span class=mi>53</span> <span class=p>{</span> <span class=p>::</span><span class=mi>1</span><span class=p>;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>	<span class=n>directory</span> 	<span class=s2>&#34;/var/named&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>dump</span><span class=o>-</span><span class=n>file</span> 	<span class=s2>&#34;/var/named/data/cache_dump.db&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>statistics</span><span class=o>-</span><span class=n>file</span> <span class=s2>&#34;/var/named/data/named_stats.txt&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>memstatistics</span><span class=o>-</span><span class=n>file</span> <span class=s2>&#34;/var/named/data/named_mem_stats.txt&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>secroots</span><span class=o>-</span><span class=n>file</span>	<span class=s2>&#34;/var/named/data/named.secroots&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>recursing</span><span class=o>-</span><span class=n>file</span>	<span class=s2>&#34;/var/named/data/named.recursing&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>allow</span><span class=o>-</span><span class=n>query</span>     <span class=p>{</span> <span class=n>any</span><span class=p>;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>	<span class=c1>## 設定轉寄站</span>
</span></span><span class=line><span class=cl>	<span class=n>forwarders</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=mf>192.168</span><span class=o>.</span><span class=mf>2.12</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=mf>192.168</span><span class=o>.</span><span class=mf>2.11</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>/*</span> 
</span></span><span class=line><span class=cl>	 <span class=o>-</span> <span class=n>If</span> <span class=n>you</span> <span class=n>are</span> <span class=n>building</span> <span class=n>an</span> <span class=n>AUTHORITATIVE</span> <span class=n>DNS</span> <span class=n>server</span><span class=p>,</span> <span class=k>do</span> <span class=n>NOT</span> <span class=n>enable</span> <span class=n>recursion</span><span class=o>.</span>
</span></span><span class=line><span class=cl>	 <span class=o>-</span> <span class=n>If</span> <span class=n>you</span> <span class=n>are</span> <span class=n>building</span> <span class=n>a</span> <span class=n>RECURSIVE</span> <span class=p>(</span><span class=n>caching</span><span class=p>)</span> <span class=n>DNS</span> <span class=n>server</span><span class=p>,</span> <span class=n>you</span> <span class=n>need</span> <span class=n>to</span> <span class=n>enable</span> 
</span></span><span class=line><span class=cl>	   <span class=n>recursion</span><span class=o>.</span> 
</span></span><span class=line><span class=cl>	 <span class=o>-</span> <span class=n>If</span> <span class=n>your</span> <span class=n>recursive</span> <span class=n>DNS</span> <span class=n>server</span> <span class=n>has</span> <span class=n>a</span> <span class=n>public</span> <span class=ne>IP</span> <span class=n>address</span><span class=p>,</span> <span class=n>you</span> <span class=n>MUST</span> <span class=n>enable</span> <span class=n>access</span> 
</span></span><span class=line><span class=cl>	   <span class=n>control</span> <span class=n>to</span> <span class=n>limit</span> <span class=n>queries</span> <span class=n>to</span> <span class=n>your</span> <span class=n>legitimate</span> <span class=n>users</span><span class=o>.</span> <span class=n>Failing</span> <span class=n>to</span> <span class=k>do</span> <span class=n>so</span> <span class=n>will</span>
</span></span><span class=line><span class=cl>	   <span class=n>cause</span> <span class=n>your</span> <span class=n>server</span> <span class=n>to</span> <span class=n>become</span> <span class=n>part</span> <span class=n>of</span> <span class=n>large</span> <span class=n>scale</span> <span class=n>DNS</span> <span class=n>amplification</span> 
</span></span><span class=line><span class=cl>	   <span class=n>attacks</span><span class=o>.</span> <span class=n>Implementing</span> <span class=n>BCP38</span> <span class=n>within</span> <span class=n>your</span> <span class=n>network</span> <span class=n>would</span> <span class=n>greatly</span>
</span></span><span class=line><span class=cl>	   <span class=n>reduce</span> <span class=n>such</span> <span class=n>attack</span> <span class=n>surface</span> 
</span></span><span class=line><span class=cl>	<span class=o>*/</span>
</span></span><span class=line><span class=cl>	<span class=n>recursion</span> <span class=n>yes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>dnssec</span><span class=o>-</span><span class=n>validation</span> <span class=n>yes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>dnssec</span><span class=o>-</span><span class=n>enable</span> <span class=n>yes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>managed</span><span class=o>-</span><span class=n>keys</span><span class=o>-</span><span class=n>directory</span> <span class=s2>&#34;/var/named/dynamic&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>geoip</span><span class=o>-</span><span class=n>directory</span> <span class=s2>&#34;/usr/share/GeoIP&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>pid</span><span class=o>-</span><span class=n>file</span> <span class=s2>&#34;/run/named/named.pid&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>session</span><span class=o>-</span><span class=n>keyfile</span> <span class=s2>&#34;/run/named/session.key&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>/*</span> <span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>fedoraproject</span><span class=o>.</span><span class=n>org</span><span class=o>/</span><span class=n>wiki</span><span class=o>/</span><span class=n>Changes</span><span class=o>/</span><span class=n>CryptoPolicy</span> <span class=o>*/</span>
</span></span><span class=line><span class=cl>	<span class=n>include</span> <span class=s2>&#34;/etc/crypto-policies/back-ends/bind.config&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logging</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>channel</span> <span class=n>default_debug</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>file</span> <span class=s2>&#34;data/named.run&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>severity</span> <span class=n>dynamic</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>zone</span> <span class=s2>&#34;.&#34;</span> <span class=n>IN</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>type</span> <span class=n>hint</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>file</span> <span class=s2>&#34;named.ca&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>include</span> <span class=s2>&#34;/etc/named.rfc1912.zones&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>include</span> <span class=s2>&#34;/etc/named.root.key&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>zone</span> <span class=s2>&#34;ocp.ken.lab.&#34;</span> <span class=n>IN</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>type</span> <span class=n>master</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>file</span> <span class=s2>&#34;ken.zone&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>allow</span><span class=o>-</span><span class=n>update</span> <span class=p>{</span> <span class=n>none</span><span class=p>;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>		<span class=n>allow</span><span class=o>-</span><span class=n>query</span> <span class=p>{</span> <span class=n>any</span><span class=p>;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>		<span class=n>allow</span><span class=o>-</span><span class=n>transfer</span> <span class=p>{</span> <span class=n>none</span><span class=p>;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=n>zone</span> <span class=s2>&#34;33.168.192.in-addr.arpa&#34;</span> <span class=n>IN</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>type</span> <span class=n>master</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>file</span> <span class=s2>&#34;ken.reverse&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>allow</span><span class=o>-</span><span class=n>update</span> <span class=p>{</span> <span class=n>none</span><span class=p>;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>		<span class=n>allow</span><span class=o>-</span><span class=n>query</span> <span class=p>{</span> <span class=n>any</span><span class=p>;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>		<span class=n>allow</span><span class=o>-</span><span class=n>transfer</span> <span class=p>{</span> <span class=n>none</span><span class=p>;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>修改正向解析 /var/named/ken.zone</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dns data-lang=dns><span class=line><span class=cl><span class=err>[root@bastion</span><span class=w> </span><span class=err>named]#</span><span class=w> </span><span class=err>cat</span><span class=w> </span><span class=nc>ken.zone</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=na>$TTL</span><span class=w> </span><span class=sc>1</span><span class=err>W</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nc>@</span><span class=w>	</span><span class=k>IN</span><span class=w>	</span><span class=k>SOA</span><span class=w>	</span><span class=py>bastion.ken.lab.	</span><span class=err>root</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=sc>2019070700</span><span class=w>	</span><span class=c>; serial</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=sc>3</span><span class=err>H</span><span class=w>		</span><span class=c>; refresh (3 hours)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=sc>30</span><span class=err>M</span><span class=w>		</span><span class=c>; retry (30 minutes)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=sc>2</span><span class=err>W</span><span class=w>		</span><span class=c>; expiry (2 weeks)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=sc>1</span><span class=err>W</span><span class=w> </span><span class=p>)</span><span class=w>		</span><span class=c>; minimum (1 week)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>IN</span><span class=w>	</span><span class=k>NS</span><span class=w>	</span><span class=py>bastion.ken.lab.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=py>bastion.ken.lab.	</span><span class=k>IN</span><span class=w>	</span><span class=k>A</span><span class=w>	</span><span class=mi>192.168.33.21</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=py>helper.ken.lab.	</span><span class=w>	</span><span class=k>IN</span><span class=w>	</span><span class=k>A</span><span class=w>	</span><span class=mi>192.168.33.21</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=py>helper.ocp.ken.lab.	</span><span class=k>IN</span><span class=w>	</span><span class=k>A</span><span class=w>	</span><span class=mi>192.168.33.21</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=py>api.ocp.ken.lab.	</span><span class=k>IN</span><span class=w>	</span><span class=k>A</span><span class=w>	</span><span class=mi>192.168.33.21</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=py>api-int.ocp.ken.lab.	</span><span class=k>IN</span><span class=w>	</span><span class=k>A</span><span class=w>	</span><span class=mi>192.168.33.21</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>*</span><span class=nc>.apps.ocp.ken.lab.</span><span class=w>	</span><span class=k>IN</span><span class=w>	</span><span class=k>A</span><span class=w>	</span><span class=mi>192.168.33.21</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=py>bootstrap.ocp.ken.lab.	</span><span class=k>IN</span><span class=w>	</span><span class=k>A</span><span class=w>	</span><span class=mi>192.168.33.22</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=py>master1.ocp.ken.lab.	</span><span class=k>IN</span><span class=w>	</span><span class=k>A</span><span class=w>	</span><span class=mi>192.168.33.23</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=py>master2.ocp.ken.lab.	</span><span class=k>IN</span><span class=w>	</span><span class=k>A</span><span class=w>	</span><span class=mi>192.168.33.24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=py>master3.ocp.ken.lab.	</span><span class=k>IN</span><span class=w>	</span><span class=k>A</span><span class=w>	</span><span class=mi>192.168.33.25</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=py>worker1.ocp.ken.lab.	</span><span class=k>IN</span><span class=w>	</span><span class=k>A</span><span class=w>	</span><span class=mi>192.168.33.26</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=py>worker2.ocp.ken.lab.	</span><span class=k>IN</span><span class=w>	</span><span class=k>A</span><span class=w>	</span><span class=mi>192.168.33.27</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=py>infra1.ocp.ken.lab.	</span><span class=k>IN</span><span class=w>	</span><span class=k>A</span><span class=w>	</span><span class=mi>192.168.33.31</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=py>infra2.ocp.ken.lab.	</span><span class=k>IN</span><span class=w>	</span><span class=k>A</span><span class=w>	</span><span class=mi>192.168.33.32</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=py>infra3.ocp.ken.lab.	</span><span class=k>IN</span><span class=w>	</span><span class=k>A</span><span class=w>	</span><span class=mi>192.168.33.33</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>;EOF</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>修改反解析 /var/named/ken.reverse</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dns data-lang=dns><span class=line><span class=cl><span class=err>[root@bastion</span><span class=w> </span><span class=err>named]#</span><span class=w> </span><span class=err>cat</span><span class=w> </span><span class=nc>ken.reverse</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=na>$TTL</span><span class=w> </span><span class=sc>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nc>@</span><span class=w>	</span><span class=k>IN</span><span class=w>	</span><span class=k>SOA</span><span class=w>	</span><span class=py>bastion.ken.lab.	</span><span class=err>root</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=sc>2019070700</span><span class=w>	</span><span class=c>; serial</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=sc>3</span><span class=err>H</span><span class=w>		</span><span class=c>; refresh (3 hours)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=sc>30</span><span class=err>M</span><span class=w>		</span><span class=c>; retry (30 minutes)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=sc>2</span><span class=err>W</span><span class=w>		</span><span class=c>; expiry (2 weeks)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=sc>1</span><span class=err>W</span><span class=w> </span><span class=p>)</span><span class=w>		</span><span class=c>; minimum (1 week)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>IN</span><span class=w>	</span><span class=k>NS</span><span class=w>	</span><span class=py>bastion.ken.lab.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>21.33.168.192</span><span class=py>.in-addr.arpa.	</span><span class=k>IN</span><span class=w>	</span><span class=k>PTR</span><span class=w>	</span><span class=py>bastion.ocp.ken.lab. </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>21.33.168.192</span><span class=py>.in-addr.arpa.	</span><span class=k>IN</span><span class=w>	</span><span class=k>PTR</span><span class=w>	</span><span class=py>api.ocp.ken.lab. </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>21.33.168.192</span><span class=py>.in-addr.arpa.	</span><span class=k>IN</span><span class=w>	</span><span class=k>PTR</span><span class=w>	</span><span class=py>api-int.ocp.ken.lab. </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>22.33.168.192</span><span class=py>.in-addr.arpa.	</span><span class=k>IN</span><span class=w>	</span><span class=k>PTR</span><span class=w>	</span><span class=py>bootstrap.ocp.ken.lab. </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>23.33.168.192</span><span class=py>.in-addr.arpa.	</span><span class=k>IN</span><span class=w>	</span><span class=k>PTR</span><span class=w>	</span><span class=py>master1.ocp.ken.lab. </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>24.33.168.192</span><span class=py>.in-addr.arpa.	</span><span class=k>IN</span><span class=w>	</span><span class=k>PTR</span><span class=w>	</span><span class=py>master2.ocp.ken.lab. </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>25.33.168.192</span><span class=py>.in-addr.arpa.	</span><span class=k>IN</span><span class=w>	</span><span class=k>PTR</span><span class=w>	</span><span class=py>master3.ocp.ken.lab. </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>26.33.168.192</span><span class=py>.in-addr.arpa.	</span><span class=k>IN</span><span class=w>	</span><span class=k>PTR</span><span class=w>	</span><span class=py>worker1.ocp.ken.lab. </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>27.33.168.192</span><span class=py>.in-addr.arpa.	</span><span class=k>IN</span><span class=w>	</span><span class=k>PTR</span><span class=w>	</span><span class=py>worker2.ocp.ken.lab. </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>31.33.168.192</span><span class=py>.in-addr.arpa.	</span><span class=k>IN</span><span class=w>	</span><span class=k>PTR</span><span class=w>	</span><span class=py>infra1.ocp.ken.lab. </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>32.33.168.192</span><span class=py>.in-addr.arpa.	</span><span class=k>IN</span><span class=w>	</span><span class=k>PTR</span><span class=w>	</span><span class=py>infra2.ocp.ken.lab.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>33.33.168.192</span><span class=py>.in-addr.arpa.	</span><span class=k>IN</span><span class=w>	</span><span class=k>PTR</span><span class=w>	</span><span class=py>infra3.ocp.ken.lab.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>;EOF</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>調整防火牆</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># firewall-cmd --add-service=dns --permanent</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># firewall-cmd --reload</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>啟動服務</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@bastion ~]# systemctl enable named --now
</span></span></code></pre></td></tr></table></div></div></li><li><p>驗證DNS</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>##測試api
</span></span><span class=line><span class=cl>[root@bastion ~]# dig +noall +answer @192.168.33.21 api.ocp.ken.lab
</span></span><span class=line><span class=cl>api.ocp.ken.lab.	604800	IN	A	192.168.33.21
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[root@bastion ~]# nslookup 192.168.33.21
</span></span><span class=line><span class=cl>21.33.168.192.in-addr.arpa	name = api.ocp.ken.lab.
</span></span><span class=line><span class=cl>21.33.168.192.in-addr.arpa	name = bastion.ocp.ken.lab.
</span></span><span class=line><span class=cl>21.33.168.192.in-addr.arpa	name = api-int.ocp.ken.lab.
</span></span><span class=line><span class=cl>## 測試 wild card
</span></span><span class=line><span class=cl>[root@bastion ~]# dig +noall +answer @192.168.33.21 random.apps.ocp.ken.lab
</span></span><span class=line><span class=cl>random.apps.ocp.ken.lab. 604800	IN	A	192.168.33.21
</span></span><span class=line><span class=cl>##測試反解析
</span></span><span class=line><span class=cl>[root@bastion ~]# dig +noall +answer @192.168.33.21 -x 192.168.33.21
</span></span><span class=line><span class=cl>21.33.168.192.in-addr.arpa. 10	IN	PTR	api.ocp.ken.lab.
</span></span><span class=line><span class=cl>21.33.168.192.in-addr.arpa. 10	IN	PTR	api-int.ocp.ken.lab.
</span></span><span class=line><span class=cl>21.33.168.192.in-addr.arpa. 10	IN	PTR	bastion.ocp.ken.lab.
</span></span></code></pre></td></tr></table></div></div></li></ol><hr><h3 id=安裝ha-proxy>安裝HA Proxy</h3><ol><li><p>安裝haproxy</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@bastion ~]# yum install haproxy -y
</span></span></code></pre></td></tr></table></div></div></li><li><p>設定HAProxy</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>將文件上的設定檔複製貼上，再用</span><span class=n>sed</span> <span class=err>指令修改</span><span class=n>domain</span> <span class=n>name</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=n>haproxy</span><span class=p>]</span><span class=c1># sed -i &#34;s/ocp4.example.com/ocp.ken.lab/g&#34; /etc/haproxy/haproxy.cfg</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># cat /etc/haproxy/haproxy.cfg</span>
</span></span><span class=line><span class=cl><span class=n>global</span>
</span></span><span class=line><span class=cl>  <span class=nb>log</span>         <span class=mf>127.0</span><span class=o>.</span><span class=mf>0.1</span> <span class=n>local2</span>
</span></span><span class=line><span class=cl>  <span class=n>pidfile</span>     <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>run</span><span class=o>/</span><span class=n>haproxy</span><span class=o>.</span><span class=n>pid</span>
</span></span><span class=line><span class=cl>  <span class=n>maxconn</span>     <span class=mi>4000</span>
</span></span><span class=line><span class=cl>  <span class=n>daemon</span>
</span></span><span class=line><span class=cl><span class=n>defaults</span>
</span></span><span class=line><span class=cl>  <span class=n>mode</span>                    <span class=n>http</span>
</span></span><span class=line><span class=cl>  <span class=nb>log</span>                     <span class=n>global</span>
</span></span><span class=line><span class=cl>  <span class=n>option</span>                  <span class=n>dontlognull</span>
</span></span><span class=line><span class=cl>  <span class=n>option</span> <span class=n>http</span><span class=o>-</span><span class=n>server</span><span class=o>-</span><span class=n>close</span>
</span></span><span class=line><span class=cl>  <span class=n>option</span>                  <span class=n>redispatch</span>
</span></span><span class=line><span class=cl>  <span class=n>retries</span>                 <span class=mi>3</span>
</span></span><span class=line><span class=cl>  <span class=n>timeout</span> <span class=n>http</span><span class=o>-</span><span class=n>request</span>    <span class=mi>10</span><span class=n>s</span>
</span></span><span class=line><span class=cl>  <span class=n>timeout</span> <span class=n>queue</span>           <span class=mi>1</span><span class=n>m</span>
</span></span><span class=line><span class=cl>  <span class=n>timeout</span> <span class=n>connect</span>         <span class=mi>10</span><span class=n>s</span>
</span></span><span class=line><span class=cl>  <span class=n>timeout</span> <span class=n>client</span>          <span class=mi>1</span><span class=n>m</span>
</span></span><span class=line><span class=cl>  <span class=n>timeout</span> <span class=n>server</span>          <span class=mi>1</span><span class=n>m</span>
</span></span><span class=line><span class=cl>  <span class=n>timeout</span> <span class=n>http</span><span class=o>-</span><span class=n>keep</span><span class=o>-</span><span class=n>alive</span> <span class=mi>10</span><span class=n>s</span>
</span></span><span class=line><span class=cl>  <span class=n>timeout</span> <span class=n>check</span>           <span class=mi>10</span><span class=n>s</span>
</span></span><span class=line><span class=cl>  <span class=n>maxconn</span>                 <span class=mi>3000</span>
</span></span><span class=line><span class=cl><span class=n>frontend</span> <span class=n>stats</span>
</span></span><span class=line><span class=cl>  <span class=n>bind</span> <span class=o>*</span><span class=p>:</span><span class=mi>1936</span>
</span></span><span class=line><span class=cl>  <span class=n>mode</span>            <span class=n>http</span>
</span></span><span class=line><span class=cl>  <span class=nb>log</span>             <span class=n>global</span>
</span></span><span class=line><span class=cl>  <span class=n>maxconn</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>  <span class=n>stats</span> <span class=n>enable</span>
</span></span><span class=line><span class=cl>  <span class=n>stats</span> <span class=n>hide</span><span class=o>-</span><span class=n>version</span>
</span></span><span class=line><span class=cl>  <span class=n>stats</span> <span class=n>refresh</span> <span class=mi>30</span><span class=n>s</span>
</span></span><span class=line><span class=cl>  <span class=n>stats</span> <span class=n>show</span><span class=o>-</span><span class=n>node</span>
</span></span><span class=line><span class=cl>  <span class=n>stats</span> <span class=n>show</span><span class=o>-</span><span class=n>desc</span> <span class=n>Stats</span> <span class=k>for</span> <span class=n>ocp4</span> <span class=n>cluster</span>
</span></span><span class=line><span class=cl>  <span class=n>stats</span> <span class=n>auth</span> <span class=n>admin</span><span class=p>:</span><span class=n>ocp4</span>
</span></span><span class=line><span class=cl>  <span class=n>stats</span> <span class=n>uri</span> <span class=o>/</span><span class=n>stats</span>
</span></span><span class=line><span class=cl><span class=n>listen</span> <span class=n>api</span><span class=o>-</span><span class=n>server</span><span class=o>-</span><span class=mi>6443</span>
</span></span><span class=line><span class=cl>  <span class=n>bind</span> <span class=o>*</span><span class=p>:</span><span class=mi>6443</span>
</span></span><span class=line><span class=cl>  <span class=n>mode</span> <span class=n>tcp</span>
</span></span><span class=line><span class=cl>  <span class=n>server</span> <span class=n>bootstrap</span> <span class=n>bootstrap</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span><span class=p>:</span><span class=mi>6443</span> <span class=n>check</span> <span class=n>inter</span> <span class=mi>1</span><span class=n>s</span> <span class=n>backup</span>
</span></span><span class=line><span class=cl>  <span class=n>server</span> <span class=n>master1</span> <span class=n>master1</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span><span class=p>:</span><span class=mi>6443</span> <span class=n>check</span> <span class=n>inter</span> <span class=mi>1</span><span class=n>s</span>
</span></span><span class=line><span class=cl>  <span class=n>server</span> <span class=n>master2</span> <span class=n>master3</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span><span class=p>:</span><span class=mi>6443</span> <span class=n>check</span> <span class=n>inter</span> <span class=mi>1</span><span class=n>s</span>
</span></span><span class=line><span class=cl>  <span class=n>server</span> <span class=n>master3</span> <span class=n>master3</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span><span class=p>:</span><span class=mi>6443</span> <span class=n>check</span> <span class=n>inter</span> <span class=mi>1</span><span class=n>s</span>
</span></span><span class=line><span class=cl><span class=n>listen</span> <span class=n>machine</span><span class=o>-</span><span class=n>config</span><span class=o>-</span><span class=n>server</span><span class=o>-</span><span class=mi>22623</span>
</span></span><span class=line><span class=cl>  <span class=n>bind</span> <span class=o>*</span><span class=p>:</span><span class=mi>22623</span>
</span></span><span class=line><span class=cl>  <span class=n>mode</span> <span class=n>tcp</span>
</span></span><span class=line><span class=cl>  <span class=n>server</span> <span class=n>bootstrap</span> <span class=n>bootstrap</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span><span class=p>:</span><span class=mi>22623</span> <span class=n>check</span> <span class=n>inter</span> <span class=mi>1</span><span class=n>s</span> <span class=n>backup</span> 
</span></span><span class=line><span class=cl>  <span class=n>server</span> <span class=n>master1</span> <span class=n>master1</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span><span class=p>:</span><span class=mi>22623</span> <span class=n>check</span> <span class=n>inter</span> <span class=mi>1</span><span class=n>s</span>
</span></span><span class=line><span class=cl>  <span class=n>server</span> <span class=n>master2</span> <span class=n>master2</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span><span class=p>:</span><span class=mi>22623</span> <span class=n>check</span> <span class=n>inter</span> <span class=mi>1</span><span class=n>s</span>
</span></span><span class=line><span class=cl>  <span class=n>server</span> <span class=n>master3</span> <span class=n>master3</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span><span class=p>:</span><span class=mi>22623</span> <span class=n>check</span> <span class=n>inter</span> <span class=mi>1</span><span class=n>s</span>
</span></span><span class=line><span class=cl><span class=n>listen</span> <span class=n>ingress</span><span class=o>-</span><span class=n>router</span><span class=o>-</span><span class=mi>443</span>
</span></span><span class=line><span class=cl>  <span class=n>bind</span> <span class=o>*</span><span class=p>:</span><span class=mi>443</span>
</span></span><span class=line><span class=cl>  <span class=n>mode</span> <span class=n>tcp</span>
</span></span><span class=line><span class=cl>  <span class=n>balance</span> <span class=n>source</span>
</span></span><span class=line><span class=cl>  <span class=n>server</span> <span class=n>worker1</span> <span class=n>worker1</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span><span class=p>:</span><span class=mi>443</span> <span class=n>check</span> <span class=n>inter</span> <span class=mi>1</span><span class=n>s</span>
</span></span><span class=line><span class=cl>  <span class=n>server</span> <span class=n>worker2</span> <span class=n>worker2</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span><span class=p>:</span><span class=mi>443</span> <span class=n>check</span> <span class=n>inter</span> <span class=mi>1</span><span class=n>s</span>
</span></span><span class=line><span class=cl>  <span class=n>server</span> <span class=n>infra1</span> <span class=n>infra1</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span><span class=p>:</span><span class=mi>443</span> <span class=n>check</span> <span class=n>inter</span> <span class=mi>1</span><span class=n>s</span>
</span></span><span class=line><span class=cl>  <span class=n>server</span> <span class=n>infra2</span> <span class=n>infra2</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span><span class=p>:</span><span class=mi>443</span> <span class=n>check</span> <span class=n>inter</span> <span class=mi>1</span><span class=n>s</span>
</span></span><span class=line><span class=cl>  <span class=n>server</span> <span class=n>infra3</span> <span class=n>infra3</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span><span class=p>:</span><span class=mi>443</span> <span class=n>check</span> <span class=n>inter</span> <span class=mi>1</span><span class=n>s</span>
</span></span><span class=line><span class=cl><span class=n>listen</span> <span class=n>ingress</span><span class=o>-</span><span class=n>router</span><span class=o>-</span><span class=mi>80</span>
</span></span><span class=line><span class=cl>  <span class=n>bind</span> <span class=o>*</span><span class=p>:</span><span class=mi>80</span>
</span></span><span class=line><span class=cl>  <span class=n>mode</span> <span class=n>tcp</span>
</span></span><span class=line><span class=cl>  <span class=n>balance</span> <span class=n>source</span>
</span></span><span class=line><span class=cl>  <span class=n>server</span> <span class=n>worker1</span> <span class=n>worker1</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span><span class=p>:</span><span class=mi>80</span> <span class=n>check</span> <span class=n>inter</span> <span class=mi>1</span><span class=n>s</span>
</span></span><span class=line><span class=cl>  <span class=n>server</span> <span class=n>worker2</span> <span class=n>worker2</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span><span class=p>:</span><span class=mi>80</span> <span class=n>check</span> <span class=n>inter</span> <span class=mi>1</span><span class=n>s</span>
</span></span><span class=line><span class=cl>  <span class=n>server</span> <span class=n>infra1</span> <span class=n>infra1</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span><span class=p>:</span><span class=mi>80</span> <span class=n>check</span> <span class=n>inter</span> <span class=mi>1</span><span class=n>s</span>
</span></span><span class=line><span class=cl>  <span class=n>server</span> <span class=n>infra2</span> <span class=n>infra2</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span><span class=p>:</span><span class=mi>80</span> <span class=n>check</span> <span class=n>inter</span> <span class=mi>1</span><span class=n>s</span>
</span></span><span class=line><span class=cl>  <span class=n>server</span> <span class=n>infra3</span> <span class=n>infra3</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span><span class=p>:</span><span class=mi>80</span> <span class=n>check</span> <span class=n>inter</span> <span class=mi>1</span><span class=n>s</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>防火牆開通、SELinux設定</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># firewall-cmd --add-port=80/tcp --permanent </span>
</span></span><span class=line><span class=cl><span class=n>success</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># firewall-cmd --add-port=443/tcp --permanent </span>
</span></span><span class=line><span class=cl><span class=n>success</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># firewall-cmd --add-port=6443/tcp --permanent </span>
</span></span><span class=line><span class=cl><span class=n>success</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># firewall-cmd --add-port=1936/tcp --permanent </span>
</span></span><span class=line><span class=cl><span class=n>success</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># firewall-cmd --add-port=22623/tcp --permanent </span>
</span></span><span class=line><span class=cl><span class=n>success</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># firewall-cmd --add-port=9000-9999/tcp --permanent </span>
</span></span><span class=line><span class=cl><span class=n>success</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># firewall-cmd --add-port=10250-10259/tcp --permanent </span>
</span></span><span class=line><span class=cl><span class=n>success</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># firewall-cmd --add-port=4789/udp --permanent </span>
</span></span><span class=line><span class=cl><span class=n>success</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># firewall-cmd --add-port=6081/udp --permanent </span>
</span></span><span class=line><span class=cl><span class=n>success</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># firewall-cmd --add-port=9000-9999/udp --permanent </span>
</span></span><span class=line><span class=cl><span class=n>success</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># firewall-cmd --add-port=500/udp --permanent </span>
</span></span><span class=line><span class=cl><span class=n>success</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># firewall-cmd --add-port=4500/udp --permanent </span>
</span></span><span class=line><span class=cl><span class=n>success</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># firewall-cmd --add-port=30000-32767/udp --permanent </span>
</span></span><span class=line><span class=cl><span class=n>success</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># firewall-cmd --add-port=30000-32767/tcp --permanent </span>
</span></span><span class=line><span class=cl><span class=n>success</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># firewall-cmd --reload</span>
</span></span><span class=line><span class=cl><span class=n>success</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># firewall-cmd --list-all</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=p>(</span><span class=n>active</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>target</span><span class=p>:</span> <span class=n>default</span>
</span></span><span class=line><span class=cl>  <span class=n>icmp</span><span class=o>-</span><span class=n>block</span><span class=o>-</span><span class=n>inversion</span><span class=p>:</span> <span class=n>no</span>
</span></span><span class=line><span class=cl>  <span class=n>interfaces</span><span class=p>:</span> <span class=n>ens192</span>
</span></span><span class=line><span class=cl>  <span class=n>sources</span><span class=p>:</span> 
</span></span><span class=line><span class=cl>  <span class=n>services</span><span class=p>:</span> <span class=n>cockpit</span> <span class=n>dhcpv6</span><span class=o>-</span><span class=n>client</span> <span class=n>dns</span> <span class=n>ssh</span>
</span></span><span class=line><span class=cl>  <span class=n>ports</span><span class=p>:</span> <span class=mi>53</span><span class=o>/</span><span class=n>udp</span> <span class=mi>53</span><span class=o>/</span><span class=n>tcp</span> <span class=mi>80</span><span class=o>/</span><span class=n>tcp</span> <span class=mi>443</span><span class=o>/</span><span class=n>tcp</span> <span class=mi>6443</span><span class=o>/</span><span class=n>tcp</span> <span class=mi>1936</span><span class=o>/</span><span class=n>tcp</span> <span class=mi>22623</span><span class=o>/</span><span class=n>tcp</span> <span class=mi>9000</span><span class=o>-</span><span class=mi>9999</span><span class=o>/</span><span class=n>tcp</span> <span class=mi>10250</span><span class=o>-</span><span class=mi>10259</span><span class=o>/</span><span class=n>tcp</span> <span class=mi>4789</span><span class=o>/</span><span class=n>udp</span> <span class=mi>6081</span><span class=o>/</span><span class=n>udp</span> <span class=mi>9000</span><span class=o>-</span><span class=mi>9999</span><span class=o>/</span><span class=n>udp</span> <span class=mi>500</span><span class=o>/</span><span class=n>udp</span> <span class=mi>4500</span><span class=o>/</span><span class=n>udp</span> <span class=mi>30000</span><span class=o>-</span><span class=mi>32767</span><span class=o>/</span><span class=n>udp</span> <span class=mi>30000</span><span class=o>-</span><span class=mi>32767</span><span class=o>/</span><span class=n>tcp</span>
</span></span><span class=line><span class=cl>  <span class=n>protocols</span><span class=p>:</span> 
</span></span><span class=line><span class=cl>  <span class=n>forward</span><span class=p>:</span> <span class=n>yes</span>
</span></span><span class=line><span class=cl>  <span class=n>masquerade</span><span class=p>:</span> <span class=n>no</span>
</span></span><span class=line><span class=cl>  <span class=n>forward</span><span class=o>-</span><span class=n>ports</span><span class=p>:</span> 
</span></span><span class=line><span class=cl>  <span class=n>source</span><span class=o>-</span><span class=n>ports</span><span class=p>:</span> 
</span></span><span class=line><span class=cl>  <span class=n>icmp</span><span class=o>-</span><span class=n>blocks</span><span class=p>:</span> 
</span></span><span class=line><span class=cl>  <span class=n>rich</span> <span class=n>rules</span><span class=p>:</span> 
</span></span><span class=line><span class=cl><span class=c1>## SELinux</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=c1># semanage port --add --type http_port_t --proto tcp 1936</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=c1># semanage port --add --type http_port_t --proto tcp 6443</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=c1># semanage port --add --type http_port_t --proto tcp 22623</span>
</span></span><span class=line><span class=cl><span class=ow>or</span> 
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=c1># setsebool -P haproxy_connect_any=on</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>啟動服務</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@bastion ~]# systemctl enable haproxy --now
</span></span></code></pre></td></tr></table></div></div></li></ol><hr><h3 id=下載pull-secret-token>下載Pull Secret Token</h3><ol><li><p>網頁連線至https://console.redhat.com/openshift/downloads</p></li><li><p>下載 Pull Secret Token
<img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221011144551465.png loading=lazy alt=image-20221011144551465></p></li><li><p>將 pull-secret放到安裝目錄下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ocp]$ cp ../pull-secret .
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ ll
</span></span><span class=line><span class=cl>-rw-r--r--. 1 devop devop      2795 Oct 11 15:07 pull-secret
</span></span></code></pre></td></tr></table></div></div><hr></li></ol><h3 id=下載安裝openshift-installer>下載安裝openshift installer</h3><ol><li><p>網頁連線至 <a class=link href=https://console.redhat.com/openshift/downloads#tool-pull-secret target=_blank rel=noopener>https://console.redhat.com/openshift/downloads#tool-pull-secret</a></p></li><li><p>下載 OpenShift for x86_64 Installer
<img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221011145410398.png loading=lazy alt=image-20221011145410398></p></li><li><p>創建目錄並解壓縮</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ~]$ mkdir ocp
</span></span><span class=line><span class=cl>[devop@bastion ~]$ mv openshift-install-linux.tar.gz ocp
</span></span><span class=line><span class=cl>[devop@bastion ~]$ cd ocp
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ ll
</span></span><span class=line><span class=cl>total 336508
</span></span><span class=line><span class=cl>-rw-r--r--. 1 devop devop 344582118 Oct 11 14:59 openshift-install-linux.tar.gz
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ tar xzvf openshift-install-linux.tar.gz 
</span></span><span class=line><span class=cl>README.md
</span></span><span class=line><span class=cl>openshift-install
</span></span></code></pre></td></tr></table></div></div></li><li><p>將openshift installer 放到 /usr/local/bin</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ocp]$ sudo cp openshift-install /usr/local/bin/
</span></span><span class=line><span class=cl>[sudo] password for devop:
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ openshift-install --help
</span></span><span class=line><span class=cl>Creates OpenShift clusters
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Usage:
</span></span><span class=line><span class=cl>  openshift-install [command]
</span></span><span class=line><span class=cl>  ..
</span></span></code></pre></td></tr></table></div></div></li></ol><hr><h3 id=下載-coreos>下載 CoreOS</h3><ol><li>連線至 <a class=link href=https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/4.11/4.11.2/ target=_blank rel=noopener>https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/4.11/4.11.2/</a></li><li>下載 <a class=link href=https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/4.11/4.11.2/rhcos-4.11.2-x86_64-live.x86_64.iso target=_blank rel=noopener>https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/4.11/4.11.2/rhcos-4.11.2-x86_64-live.x86_64.iso</a></li><li>放到ESXi主機上並掛給各虛擬機
<img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221011150628575.png loading=lazy alt=image-20221011150628575></li><li><img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221011151238082.png loading=lazy alt=image-20221011151238082></li></ol><hr><h3 id=準備安裝soruce>準備安裝Soruce</h3><h4 id=創建install-configyaml>創建install-config.yaml</h4><p>在/home/devop/ocp目錄下 新增install-config.yaml
重裝時記得將此目錄清除乾淨</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ocp]$ vim install-config.yaml 
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ cat install-config.yaml 
</span></span><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>baseDomain: ken.lab 
</span></span><span class=line><span class=cl>compute: 
</span></span><span class=line><span class=cl>- hyperthreading: Enabled 
</span></span><span class=line><span class=cl>  name: worker
</span></span><span class=line><span class=cl>  replicas: 0 
</span></span><span class=line><span class=cl>controlPlane: 
</span></span><span class=line><span class=cl>  hyperthreading: Enabled 
</span></span><span class=line><span class=cl>  name: master
</span></span><span class=line><span class=cl>  replicas: 3 
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: ocp
</span></span><span class=line><span class=cl>networking:
</span></span><span class=line><span class=cl>  clusterNetwork:
</span></span><span class=line><span class=cl>  - cidr: 10.128.0.0/14 
</span></span><span class=line><span class=cl>    hostPrefix: 23 
</span></span><span class=line><span class=cl>  networkType: OpenShiftSDN
</span></span><span class=line><span class=cl>  serviceNetwork: 
</span></span><span class=line><span class=cl>  - 172.30.0.0/16
</span></span><span class=line><span class=cl>platform:
</span></span><span class=line><span class=cl>  none: {} 
</span></span><span class=line><span class=cl>fips: false 
</span></span><span class=line><span class=cl>pullSecret: &#39;{&#34;auths&#34;:{&#34;cloud.openshift.com&#34;:{&#34;auth&#34;:&#34;b3BlbnNoaWZ0LXJlbGVhc2UtZGV2K29jbV9hY2Nlc3NfMzEwNjVjNmVmMTk5NDZmNWEwNmUzZmI4MTVmNzk2OTE6NEJRVk1FVk9CTDRZQVRBT0pONEhQVkIyUExFQTdKNDE3WExFU1IzVDk3NU1YUTJXWE9FSjBNTVk0MzFQQk9RUA==&#34;,&#34;email&#34;:&#34;ken.wang@infotech.com.tw&#34;},&#34;quay.io&#34;:{&#34;auth&#34;:&#34;b3BlbnNoaWZ0LXJlbGVhc2UtZGV2K29jbV9hY2Nlc3NfMzEwNjVjNmVmMTk5NDZmNWEwNmUzZmI4MTVmNzk2OTE6NEJRVk1FVk9CTDRZQVRBT0pONEhQVkIyUExFQTdKNDE3WExFU1IzVDk3NU1YUTJXWE9FSjBNTVk0MzFQQk9RUA==&#34;,&#34;email&#34;:&#34;ken.wang@infotech.com.tw&#34;},&#34;registry.connect.redhat.com&#34;:{&#34;auth&#34;:&#34;fHVoYy1wb29sLTc5MzgwY2YyLTUxNTEtNGRiNi04YjA3LTRiNzQ4NDcxNWE2NDpleUpoYkdjaU9pSlNVelV4TWlKOS5leUp6ZFdJaU9pSmxOak5rWVdWbU1tSXlaRFEwTVdKaVlUTXpObVUwTkdGbVl6WmtPVEUwWVNKOS5RMlp6Q1JaWWltVDIxM2dpYU9CRWtNWEVkYUtjbnc4WHN1bTY3VEVOdjEyRjBjQUgyNWNZMVdWTjZNUEY2R21CNjh3TmF4TnoxRHVpVnBtY0ZKM2JZTW0yNVVzZGJxeFc4cEd1dGszSzF5NlNUWk9VejlkU0V4UGg4aUxha05qSEQ4Tml6emNmM1lUQjRNUXdhYTVFSG1PMXVTUERUZFRBTXFYS3FFa2gwRXpHOUpKZTlUMnM4bVJXWkVIbndoZW84cktncVZuV1VCeGhqTldFNElfWG1JZnBPRl91akpFNHdXNzRJWjd5UmdoUGExQVVwS3BsY0NJQ2ZGdGtaS29WUTFwNTBzUzNabkxWYjd6ZHdXR21WcXVsNUFoZUNiSHNoNEtpSjFnYXRSbkwtMG92THZoNGdseUZqd0c0Z3lMMEdyS1ItbU5WMFZYc01mVzJDNXNVaXBzVmhKcmhmY01vQjRNSDRDbjZKcjJXS2plbEdqSVdHQzBUV1BBNlZQZDBmc0lyLTRCY2RBdUFmcm5SaWpGM3d0Mng3RFdXQ1RScFVPbUVMY3U5bDR6Wm5uZkVSejNMd01rNmhCWTFyYXV1TGhCWXJraFlzQURqWEl3bGxPTkwyc01GMUU2OVNIVG1vV0tvNU5fdHdoWE5fX1BtT1ozMzc5ZVNDVGdnTFNZd3hyR1VwS3FXRDFva3JWZlRIWmNlcTk4WHQ2QjFtZHIxcmxLV2RiRmhsRDQ3Q1pldEhrNW1xQUlianp1UzlONENJWllhd0lIZE5LWVotN2tRNFQyUFg4QWdadHFNdHdjY2c0bWx3ME40c09LbWVZN2Q2bGw0bXpXV201bVo0aktTeHdpYmJ3STEwOFcxWVFlSlQ4QW9WZFlkc09YWkdWc3ZxZVVZOU9qbzR2RQ==&#34;,&#34;email&#34;:&#34;ken.wang@infotech.com.tw&#34;},&#34;registry.redhat.io&#34;:{&#34;auth&#34;:&#34;fHVoYy1wb29sLTc5MzgwY2YyLTUxNTEtNGRiNi04YjA3LTRiNzQ4NDcxNWE2NDpleUpoYkdjaU9pSlNVelV4TWlKOS5leUp6ZFdJaU9pSmxOak5rWVdWbU1tSXlaRFEwTVdKaVlUTXpObVUwTkdGbVl6WmtPVEUwWVNKOS5RMlp6Q1JaWWltVDIxM2dpYU9CRWtNWEVkYUtjbnc4WHN1bTY3VEVOdjEyRjBjQUgyNWNZMVdWTjZNUEY2R21CNjh3TmF4TnoxRHVpVnBtY0ZKM2JZTW0yNVVzZGJxeFc4cEd1dGszSzF5NlNUWk9VejlkU0V4UGg4aUxha05qSEQ4Tml6emNmM1lUQjRNUXdhYTVFSG1PMXVTUERUZFRBTXFYS3FFa2gwRXpHOUpKZTlUMnM4bVJXWkVIbndoZW84cktncVZuV1VCeGhqTldFNElfWG1JZnBPRl91akpFNHdXNzRJWjd5UmdoUGExQVVwS3BsY0NJQ2ZGdGtaS29WUTFwNTBzUzNabkxWYjd6ZHdXR21WcXVsNUFoZUNiSHNoNEtpSjFnYXRSbkwtMG92THZoNGdseUZqd0c0Z3lMMEdyS1ItbU5WMFZYc01mVzJDNXNVaXBzVmhKcmhmY01vQjRNSDRDbjZKcjJXS2plbEdqSVdHQzBUV1BBNlZQZDBmc0lyLTRCY2RBdUFmcm5SaWpGM3d0Mng3RFdXQ1RScFVPbUVMY3U5bDR6Wm5uZkVSejNMd01rNmhCWTFyYXV1TGhCWXJraFlzQURqWEl3bGxPTkwyc01GMUU2OVNIVG1vV0tvNU5fdHdoWE5fX1BtT1ozMzc5ZVNDVGdnTFNZd3hyR1VwS3FXRDFva3JWZlRIWmNlcTk4WHQ2QjFtZHIxcmxLV2RiRmhsRDQ3Q1pldEhrNW1xQUlianp1UzlONENJWllhd0lIZE5LWVotN2tRNFQyUFg4QWdadHFNdHdjY2c0bWx3ME40c09LbWVZN2Q2bGw0bXpXV201bVo0aktTeHdpYmJ3STEwOFcxWVFlSlQ4QW9WZFlkc09YWkdWc3ZxZVVZOU9qbzR2RQ==&#34;,&#34;email&#34;:&#34;ken.wang@infotech.com.tw&#34;}}}&#39;
</span></span><span class=line><span class=cl>sshKey: &#39;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIN1Z2jXmGnPWGAVrtltN9A2q5D8QtJlRvhvdB2QXoZG devop@bastion.ocp.ken.lab&#39; 
</span></span><span class=line><span class=cl>capabilities:
</span></span><span class=line><span class=cl>  baselineCapabilitySet: vCurrent
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-------### 只裝Operator Hub ###---------
</span></span><span class=line><span class=cl>capabilities:
</span></span><span class=line><span class=cl>  baselineCapabilitySet: None
</span></span><span class=line><span class=cl>  additionalEnabledCapabilities:
</span></span><span class=line><span class=cl>  - marketplace
</span></span></code></pre></td></tr></table></div></div><h4 id=建立k8s-manifest--files>建立K8S manifest files</h4><p>在相同目錄下執行
重裝時記得將此目錄清除乾淨</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ocp]$ openshift-install create manifests --dir /home/devop/ocp/install/
</span></span><span class=line><span class=cl>INFO Consuming Install Config from target directory 
</span></span><span class=line><span class=cl>WARNING Making control-plane schedulable by setting MastersSchedulable to true for Scheduler cluster settings 
</span></span><span class=line><span class=cl>INFO Manifests created in: /home/devop/ocp/install/manifests and /home/devop/ocp/install/openshift
</span></span></code></pre></td></tr></table></div></div><h4 id=ｍastersschedulablefalse>ＭastersSchedulable:false</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ocp]$ cd manifests/
</span></span><span class=line><span class=cl>[devop@bastion manifests]$ cat cluster-scheduler-02-config.yml 
</span></span><span class=line><span class=cl>apiVersion: config.openshift.io/v1
</span></span><span class=line><span class=cl>kind: Scheduler
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  creationTimestamp: null
</span></span><span class=line><span class=cl>  name: cluster
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  mastersSchedulable: false
</span></span><span class=line><span class=cl>  policy:
</span></span><span class=line><span class=cl>    name: &#34;&#34;
</span></span><span class=line><span class=cl>status: {}
</span></span></code></pre></td></tr></table></div></div><h4 id=創建ignition-config-file>創建Ignition config file</h4><p>重裝時記得將此目錄清除乾淨</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ocp]$ openshift-install create ignition-configs --dir /home/devop/ocp/install/
</span></span><span class=line><span class=cl>INFO Consuming Worker Machines from target directory 
</span></span><span class=line><span class=cl>INFO Consuming Openshift Manifests from target directory 
</span></span><span class=line><span class=cl>INFO Consuming Common Manifests from target directory 
</span></span><span class=line><span class=cl>INFO Consuming OpenShift Install (Manifests) from target directory 
</span></span><span class=line><span class=cl>INFO Consuming Master Machines from target directory 
</span></span><span class=line><span class=cl>INFO Ignition-Configs created in: /home/devop/ocp/install and /home/devop/ocp/install/auth 
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ tree install/
</span></span><span class=line><span class=cl>install/
</span></span><span class=line><span class=cl>├── auth
</span></span><span class=line><span class=cl>│   ├── kubeadmin-password
</span></span><span class=line><span class=cl>│   └── kubeconfig
</span></span><span class=line><span class=cl>├── bootstrap.ign
</span></span><span class=line><span class=cl>├── master.ign
</span></span><span class=line><span class=cl>├── metadata.json
</span></span><span class=line><span class=cl>└── worker.ign
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>1 directory, 6 files
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>##確認 sha512sum
</span></span><span class=line><span class=cl>[root@bastion ocp]# sha512sum bootstrap.ign 
</span></span><span class=line><span class=cl>460f76f9bc8b1df7095326c6b581b60f1150e477ae416b065c7b18ae040dc530a3086857d649ae04f646ccf9cce16ea9a4c32c8fe48b3630413f8ebe3f924329  bootstrap.ign
</span></span></code></pre></td></tr></table></div></div><h3 id=安裝http-web-server>安裝Http Web Server</h3><ol><li><p>安裝httpd</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@bastion ~]# yum install httpd -y
</span></span></code></pre></td></tr></table></div></div></li><li><p>設定httpd 預設port 8989、修改SELinux</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># vim /etc/httpd/conf/httpd.conf </span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Listen</span> <span class=mi>8989</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=c1># firewall-cmd --add-port=8989/tcp --permanent </span>
</span></span><span class=line><span class=cl><span class=n>success</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=c1># firewall-cmd --reload </span>
</span></span><span class=line><span class=cl><span class=n>success</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=c1># semanage port -a -t http_port_t -p tcp 8989</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>將ignition檔案複製到 /var/www/html</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># cp /home/devop/ocp/*.ign /var/www/html/ocp/</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=o>~</span><span class=p>]</span><span class=c1># cp /var/www/html/ocp</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>root</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=c1># chmod 644 *.ign</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>啟動httpd並測試連線</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[root@bastion ocp]# systemctl enable httpd --now
</span></span><span class=line><span class=cl>[root@bastion ocp]# curl http://192.168.33.21:8989/ocp/bootstrap.ign
</span></span></code></pre></td></tr></table></div></div></li></ol><hr><h2 id=安裝bootstrap>安裝BootStrap</h2><ol><li><p>將虛擬機開機，並使用rhel core os 的iso檔開機，
若前面dhcp server、dns server設定成功，即會自動拿到FQDN、IP
<img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221011155843248.png loading=lazy alt=image-20221011155843248></p></li><li><p>在bootstrap執行安裝指令</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo coreos-installer install --ignition-url=http://192.168.33.21:8989/ocp/bootstrap.ign /dev/sda --insecure-ignition
</span></span><span class=line><span class=cl>(--insecure-ignition can replace using --ignition-hash=sha512-xxxxxxxxxxxxx)
</span></span></code></pre></td></tr></table></div></div></li><li><p>出現此畫面後 執行重新啟動 reboot
<img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221011165057146.png loading=lazy alt=image-20221011165057146></p></li><li><p>開機後確認已寫入硬碟
<img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221011165808592.png loading=lazy alt=image-20221011165808592></p></li><li><p>在bastion登入bootstrap</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=p>[</span><span class=n>devop</span><span class=o>@</span><span class=n>bastion</span><span class=w> </span><span class=o>~</span><span class=p>]</span><span class=err>$</span><span class=w> </span><span class=n>ssh</span><span class=w> </span><span class=n>core</span><span class=o>@</span><span class=n>bootstrap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>The</span><span class=w> </span><span class=n>authenticity</span><span class=w> </span><span class=n>of</span><span class=w> </span><span class=n>host</span><span class=w> </span><span class=s1>&#39;bootstrap (192.168.33.22)&#39;</span><span class=w> </span><span class=n>can</span><span class=s1>&#39;t be established.
</span></span></span><span class=line><span class=cl><span class=s1>ED25519 key fingerprint is SHA256:pnQoMRtW8f/3EjIQ7qNG4+NIB+ObrTd4E8aEbvRqMQw.
</span></span></span><span class=line><span class=cl><span class=s1>This key is not known by any other names
</span></span></span><span class=line><span class=cl><span class=s1>Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
</span></span></span><span class=line><span class=cl><span class=s1>Warning: Permanently added &#39;</span><span class=n>bootstrap</span><span class=s1>&#39; (ED25519) to the list of known hosts.
</span></span></span><span class=line><span class=cl><span class=s1>client_global_hostkeys_private_confirm: server gave bad signature for RSA key 0: error in libcrypto
</span></span></span><span class=line><span class=cl><span class=s1>Red Hat Enterprise Linux CoreOS 411.86.202208112011-0
</span></span></span><span class=line><span class=cl><span class=s1>  Part of OpenShift 4.11, RHCOS is a Kubernetes native operating system
</span></span></span><span class=line><span class=cl><span class=s1>  managed by the Machine Config Operator (`clusteroperator/machine-config`).
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>WARNING: Direct SSH access to machines is not recommended; instead,
</span></span></span><span class=line><span class=cl><span class=s1>make configuration changes via `machineconfig` objects:
</span></span></span><span class=line><span class=cl><span class=s1>  https://docs.openshift.com/container-platform/4.11/architecture/architecture-rhcos.html
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>---
</span></span></span><span class=line><span class=cl><span class=s1>This is the bootstrap node; it will be destroyed when the master is fully up.
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>The primary services are release-image.service followed by bootkube.service. To watch their status, run e.g.
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>  journalctl -b -f -u release-image.service -u bootkube.service
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>查看log，到出現machine api時才可接續安裝</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[core@bootstrap ~]$ journalctl -b -f -u release-image.service -u bootkube.service
</span></span><span class=line><span class=cl>Create &#34;99_openshift-cluster-api_worker-user-data-secret.yaml&#34; secrets.v1./worker-user-data -n openshift-machine-api
</span></span></code></pre></td></tr></table></div></div></li><li><p>此時才可繼續安裝 master01、master02、master03
<img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221011173412330.png loading=lazy alt=image-20221011173412330></p></li><li><p>出現此畫面即可關閉bootstrap<img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221011172057819.png loading=lazy alt=image-20221011172057819></p><p><img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221013110951260.png loading=lazy alt=image-20221013110951260></p></li></ol><h2 id=安裝-ｍaster-node>安裝 Ｍaster Node</h2><ol><li><p>將虛擬機開機，並使用rhel core os 的iso檔開機，
若前面dhcp server、dns server設定成功，即會自動拿到FQDN、IP</p></li><li><p>在master執行安裝指令，三台相同 (若設定ＭastersSchedulable:false，則worker需一起安裝）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo coreos-installer install --ignition-url=http://192.168.33.21:8989/ocp/master.ign /dev/sda --insecure-ignition
</span></span><span class=line><span class=cl>出現install complete 即可reboot
</span></span></code></pre></td></tr></table></div></div><p><img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221012012023876.png loading=lazy alt=image-20221012012023876></p></li><li><p>持續監控bootstrap的 Log</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[core@bootstrap ~]$ journalctl -b -f -u release-image.service -u bootkube.service
</span></span></code></pre></td></tr></table></div></div></li><li><p>Master Node裝完會自動重開機</p></li><li><p>在bastion 驗證節點</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ~]$ oc get nodes
</span></span><span class=line><span class=cl>NAME                  STATUS   ROLES    AGE     VERSION
</span></span><span class=line><span class=cl>master1.ocp.ken.lab   Ready    master   4m22s   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>master2.ocp.ken.lab   Ready    master   3m37s   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>master3.ocp.ken.lab   Ready    master   3m21s   v1.24.0+3882f8f
</span></span></code></pre></td></tr></table></div></div></li><li><p>查看bootstrap的 Log,確認安裝完成</p><p><img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221012013436842.png loading=lazy alt=image-20221012013436842></p><p><img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221012014537780.png loading=lazy alt=image-20221012014537780></p></li><li><p>在Bastion 執行oc 指令確認ocp cluster CSR</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ~]$ oc get nodes
</span></span><span class=line><span class=cl>NAME                  STATUS   ROLES    AGE   VERSION
</span></span><span class=line><span class=cl>master1.ocp.ken.lab   Ready    master   18m   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>master2.ocp.ken.lab   Ready    master   17m   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>master3.ocp.ken.lab   Ready    master   17m   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[devop@bastion ~]$ oc get csr
</span></span><span class=line><span class=cl>NAME                                             AGE   SIGNERNAME                                    REQUESTOR                                                                         REQUESTEDDURATION   CONDITION
</span></span><span class=line><span class=cl>csr-7sgfx                                        18m   kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper         &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>csr-lphdj                                        17m   kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper         &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>csr-ndft5                                        17m   kubernetes.io/kubelet-serving                 system:node:master3.ocp.ken.lab                                                   &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>csr-p42p5                                        17m   kubernetes.io/kubelet-serving                 system:node:master2.ocp.ken.lab                                                   &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>csr-vgmd9                                        17m   kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper         &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>csr-zpfw4                                        18m   kubernetes.io/kubelet-serving                 system:node:master1.ocp.ken.lab                                                   &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>system:openshift:openshift-authenticator-2zxkf   15m   kubernetes.io/kube-apiserver-client           system:serviceaccount:openshift-authentication-operator:authentication-operator   &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>system:openshift:openshift-monitoring-ln69x      15m   kubernetes.io/kube-apiserver-client           system:serviceaccount:openshift-monitoring:cluster-monitoring-operator            &lt;none&gt;              Approved,Issued
</span></span></code></pre></td></tr></table></div></div></li><li><p>確認cluster operator</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion install]$ oc get co -A
</span></span><span class=line><span class=cl>NAME                                       VERSION   AVAILABLE   PROGRESSING   DEGRADED   SINCE   MESSAGE
</span></span><span class=line><span class=cl>authentication                             4.11.7    False       False         False      76s     APIServicesAvailable: PreconditionNotReady...
</span></span><span class=line><span class=cl>cloud-controller-manager                   4.11.7    True        False         False      2m36s   
</span></span><span class=line><span class=cl>cloud-credential                                     True        False         False      13m     
</span></span><span class=line><span class=cl>cluster-autoscaler                                                                                
</span></span><span class=line><span class=cl>config-operator                            4.11.7    True        False         False      40s     
</span></span><span class=line><span class=cl>console                                                                                           
</span></span><span class=line><span class=cl>csi-snapshot-controller                    4.11.7    True        False         False      1s      
</span></span><span class=line><span class=cl>dns                                                                                               
</span></span><span class=line><span class=cl>etcd                                                                                              
</span></span><span class=line><span class=cl>image-registry                                                                                    
</span></span><span class=line><span class=cl>ingress                                                                                           
</span></span><span class=line><span class=cl>insights                                                                                          
</span></span><span class=line><span class=cl>kube-apiserver                                       Unknown     False         False      112s    
</span></span><span class=line><span class=cl>kube-controller-manager                              False       True          False      75s     StaticPodsAvailable: 0 nodes are active; 3 nodes are at revision 0; 0 nodes have achieved new revision 2
</span></span><span class=line><span class=cl>kube-scheduler                                       False       True          False      35s     StaticPodsAvailable: 0 nodes are active; 3 nodes are at revision 0; 0 nodes have achieved new revision 3
</span></span><span class=line><span class=cl>kube-storage-version-migrator              4.11.7    True        False         False      59s     
</span></span><span class=line><span class=cl>machine-api                                                                                       
</span></span><span class=line><span class=cl>machine-approver                                                                                  
</span></span><span class=line><span class=cl>machine-config                                                   True                             Working towards 4.11.7
</span></span><span class=line><span class=cl>marketplace                                                                                       
</span></span><span class=line><span class=cl>monitoring                                                                                        
</span></span><span class=line><span class=cl>network                                              False       True          False      2m53s   The network is starting up
</span></span><span class=line><span class=cl>node-tuning                                                                                       
</span></span><span class=line><span class=cl>openshift-apiserver                                                                               
</span></span><span class=line><span class=cl>openshift-controller-manager                         False       True          False      100s    Available: no daemon pods available on any node.
</span></span><span class=line><span class=cl>openshift-samples                                                                                 
</span></span><span class=line><span class=cl>operator-lifecycle-manager                                                                        
</span></span><span class=line><span class=cl>operator-lifecycle-manager-catalog                                                                
</span></span><span class=line><span class=cl>operator-lifecycle-manager-packageserver                                                          
</span></span><span class=line><span class=cl>service-ca                                 4.11.7    True        False         False      33s     
</span></span><span class=line><span class=cl>storage                                    4.11.7    True        False         False      49s   
</span></span></code></pre></td></tr></table></div></div></li><li><p>關閉bootstrap，安裝worker node</p></li></ol><h2 id=安裝-workerinfra-node>安裝 Worker＆Infra Node</h2><p><a class=link href=https://docs.openshift.com/container-platform/4.11/machine_management/user_infra/adding-bare-metal-compute-user-infra.html target=_blank rel=noopener>https://docs.openshift.com/container-platform/4.11/machine_management/user_infra/adding-bare-metal-compute-user-infra.html</a></p><ol><li><p>將虛擬機開機，並使用rhel core os 的iso檔開機，
若前面dhcp server、dns server設定成功，即會自動拿到FQDN、IP</p></li><li><p>執行安裝指令 (worker1、worker2、infra1、infra2、infra3)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>sudo coreos-installer install --ignition-url=http://192.168.33.21:8989/ocp/worker.ign /dev/sda --insecure-ignition
</span></span><span class=line><span class=cl>出現install complete 即可reboot
</span></span></code></pre></td></tr></table></div></div></li><li><p>在bastion 確認nodes、csr (會有很多需approve的 csr，後續加node後還會有)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ~]$ oc get nodes
</span></span><span class=line><span class=cl>NAME                  STATUS   ROLES    AGE   VERSION
</span></span><span class=line><span class=cl>master1.ocp.ken.lab   Ready    master   36m   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>master2.ocp.ken.lab   Ready    master   35m   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>master3.ocp.ken.lab   Ready    master   35m   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>----
</span></span><span class=line><span class=cl>[devop@bastion ~]$ oc get csr
</span></span><span class=line><span class=cl>NAME                                             AGE    SIGNERNAME                                    REQUESTOR                                                                         REQUESTEDDURATION   CONDITION
</span></span><span class=line><span class=cl>csr-7sgfx                                        37m    kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper         &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>csr-lphdj                                        37m    kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper         &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>csr-ndft5                                        36m    kubernetes.io/kubelet-serving                 system:node:master3.ocp.ken.lab                                                   &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>csr-nwplh                                        0s     kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper         &lt;none&gt;              Pending
</span></span><span class=line><span class=cl>csr-p42p5                                        36m    kubernetes.io/kubelet-serving                 system:node:master2.ocp.ken.lab                                                   &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>csr-pcsl2                                        115s   kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper         &lt;none&gt;              Pending
</span></span><span class=line><span class=cl>csr-vgmd9                                        36m    kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper         &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>csr-zpfw4                                        37m    kubernetes.io/kubelet-serving                 system:node:master1.ocp.ken.lab                                                   &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>system:openshift:openshift-authenticator-2zxkf   35m    kubernetes.io/kube-apiserver-client           system:serviceaccount:openshift-authentication-operator:authentication-operator   &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>system:openshift:openshift-monitoring-ln69x      34m    kubernetes.io/kube-apiserver-client           system:serviceaccount:openshift-monitoring:cluster-monitoring-operator            &lt;none&gt;              Approved,Issued
</span></span></code></pre></td></tr></table></div></div></li><li><p>Approve All CSR</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$oc adm certificate approve &lt;csr_name&gt;
</span></span><span class=line><span class=cl>----
</span></span><span class=line><span class=cl>$oc get csr -o go-template=&#39;{{range .items}}{{if not .status}}{{.metadata.name}}{{&#34;\n&#34;}}{{end}}{{end}}&#39; | xargs --no-run-if-empty oc adm certificate approve
</span></span><span class=line><span class=cl>----
</span></span><span class=line><span class=cl>[devop@bastion auth]$ oc get csr -A
</span></span><span class=line><span class=cl>NAME        AGE     SIGNERNAME                                    REQUESTOR                                                                   REQUESTEDDURATION   CONDITION
</span></span><span class=line><span class=cl>csr-2trmm   18m     kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper   &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>csr-9xhq4   16m     kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper   &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>csr-b4jns   2m45s   kubernetes.io/kubelet-serving                 system:node:infra1.ocp.ken.lab                                              &lt;none&gt;              Pending
</span></span><span class=line><span class=cl>csr-b55jd   3m57s   kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper   &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>csr-bdtnw   16m     kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper   &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>csr-bngbr   2m40s   kubernetes.io/kubelet-serving                 system:node:infra2.ocp.ken.lab                                              &lt;none&gt;              Pending
</span></span><span class=line><span class=cl>csr-kd66h   2m51s   kubernetes.io/kubelet-serving                 system:node:infra2.ocp.ken.lab                                              &lt;none&gt;              Pending
</span></span><span class=line><span class=cl>csr-lzk6w   2m46s   kubernetes.io/kubelet-serving                 system:node:worker1.ocp.ken.lab                                             &lt;none&gt;              Pending
</span></span><span class=line><span class=cl>csr-rtkr6   2m46s   kubernetes.io/kubelet-serving                 system:node:worker2.ocp.ken.lab                                             &lt;none&gt;              Pending
</span></span><span class=line><span class=cl>csr-swwhm   18m     kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper   &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>csr-v67v6   16m     kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper   &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>csr-vhlqb   3m56s   kubernetes.io/kube-apiserver-client-kubelet   system:serviceaccount:openshift-machine-config-operator:node-bootstrapper   &lt;none&gt;              Approved,Issued
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>[devop@bastion auth]$ oc get csr -o go-template=&#39;{{range .items}}{{if not .status}}{{.metadata.name}}{{&#34;\n&#34;}}{{end}}{{end}}&#39; | xargs --no-run-if-empty oc adm certificate approve
</span></span><span class=line><span class=cl>certificatesigningrequest.certificates.k8s.io/csr-2trmm approved
</span></span><span class=line><span class=cl>certificatesigningrequest.certificates.k8s.io/csr-9xhq4 approved
</span></span><span class=line><span class=cl>certificatesigningrequest.certificates.k8s.io/csr-b55jd approved
</span></span><span class=line><span class=cl>certificatesigningrequest.certificates.k8s.io/csr-bdtnw approved
</span></span><span class=line><span class=cl>certificatesigningrequest.certificates.k8s.io/csr-swwhm approved
</span></span><span class=line><span class=cl>certificatesigningrequest.certificates.k8s.io/csr-v67v6 approved
</span></span><span class=line><span class=cl>certificatesigningrequest.certificates.k8s.io/csr-vhlqb approved
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>[devop@bastion auth]$ oc get csr -o go-template=&#39;{{range .items}}{{if not .status}}{{.metadata.name}}{{&#34;\n&#34;}}{{end}}{{end}}&#39; | xargs --no-run-if-empty oc adm certificate approve
</span></span><span class=line><span class=cl>certificatesigningrequest.certificates.k8s.io/csr-b4jns approved
</span></span><span class=line><span class=cl>certificatesigningrequest.certificates.k8s.io/csr-bngbr approved
</span></span><span class=line><span class=cl>certificatesigningrequest.certificates.k8s.io/csr-cq46l approved
</span></span><span class=line><span class=cl>certificatesigningrequest.certificates.k8s.io/csr-kd66h approved
</span></span><span class=line><span class=cl>certificatesigningrequest.certificates.k8s.io/csr-lzk6w approved
</span></span><span class=line><span class=cl>certificatesigningrequest.certificates.k8s.io/csr-rtkr6 approved
</span></span><span class=line><span class=cl>certificatesigningrequest.certificates.k8s.io/csr-t6l2b approved
</span></span></code></pre></td></tr></table></div></div></li><li><p>再次確認node狀態</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion auth]$ oc get nodes
</span></span><span class=line><span class=cl>NAME                  STATUS                     ROLES    AGE     VERSION
</span></span><span class=line><span class=cl>infra1.ocp.ken.lab    Ready                      worker   2m32s   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>infra2.ocp.ken.lab    Ready,SchedulingDisabled   worker   2m38s   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>master1.ocp.ken.lab   NotReady                   master   78m     v1.24.0+3882f8f
</span></span><span class=line><span class=cl>master2.ocp.ken.lab   NotReady                   master   78m     v1.24.0+3882f8f
</span></span><span class=line><span class=cl>master3.ocp.ken.lab   NotReady                   master   78m     v1.24.0+3882f8f
</span></span><span class=line><span class=cl>worker1.ocp.ken.lab   Ready                      worker   2m33s   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>worker2.ocp.ken.lab   Ready                      worker   2m34s   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>[devop@bastion ~]$ oc get nodes
</span></span><span class=line><span class=cl>NAME                  STATUS   ROLES    AGE   VERSION
</span></span><span class=line><span class=cl>master1.ocp.ken.lab   Ready    master   39m   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>master2.ocp.ken.lab   Ready    master   39m   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>master3.ocp.ken.lab   Ready    master   38m   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>worker1.ocp.ken.lab   Ready    worker   95s   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>worker2.ocp.ken.lab   Ready    worker   90s   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>[devop@bastion ~]$ oc get po -A
</span></span><span class=line><span class=cl>...
</span></span></code></pre></td></tr></table></div></div></li></ol><h2 id=安裝後的設定>安裝後的設定</h2><h4 id=設定nfs>設定NFS</h4><p><a class=link href=https://access.redhat.com/solutions/4618011 target=_blank rel=noopener>https://access.redhat.com/solutions/4618011</a></p><p><a class=link href=https://access.redhat.com/solutions/5900501 target=_blank rel=noopener>https://access.redhat.com/solutions/5900501</a></p><p>on vmware vsphere</p><p><a class=link href=https://vergiehadiana.medium.com/guide-deploy-nfs-storage-for-dynamic-provisioning-and-image-registry-for-red-hat-openshift-b15e16f357b4 target=_blank rel=noopener>https://vergiehadiana.medium.com/guide-deploy-nfs-storage-for-dynamic-provisioning-and-image-registry-for-red-hat-openshift-b15e16f357b4</a></p><p><a class=link href=https://hackmd.io/@kd-ocp/S1EIu6V25 target=_blank rel=noopener>https://hackmd.io/@kd-ocp/S1EIu6V25</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>image:
</span></span><span class=line><span class=cl>k8s.gcr.io/sig-storage/nfs-subdir-external-provisioner:v4.0.2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>image:
</span></span><span class=line><span class=cl>groundhog2k/nfs-subdir-external-provisioner:v3.2.0
</span></span></code></pre></td></tr></table></div></div><h4 id=設定外部image-registry>設定外部Image Registry</h4><p><a class=link href=https://access.redhat.com/documentation/zh-cn/openshift_container_platform/4.6/html/images/images-configuration-file_image-configuration target=_blank rel=noopener>https://access.redhat.com/documentation/zh-cn/openshift_container_platform/4.6/html/images/images-configuration-file_image-configuration</a></p><h4 id=設定htpasswd-provider>設定Htpasswd Provider</h4><p><a class=link href=https://docs.openshift.com/container-platform/4.11/authentication/identity_providers/configuring-htpasswd-identity-provider.html target=_blank rel=noopener>https://docs.openshift.com/container-platform/4.11/authentication/identity_providers/configuring-htpasswd-identity-provider.html</a></p><ol><li><p>利用htpasswd 產生htpasswd檔案</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ocp]$ htpasswd -c -B -b users.htpasswd admin redhat
</span></span><span class=line><span class=cl>Adding password for user admin
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ htpasswd -B -b users.htpasswd ken xxxxxxxx
</span></span><span class=line><span class=cl>Adding password for user ken
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ htpasswd -B -b users.htpasswd view redhat
</span></span><span class=line><span class=cl>Adding password for user view
</span></span></code></pre></td></tr></table></div></div></li><li><p>產生secret 將 htpasswd 放入secret</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ocp]$ oc whoami
</span></span><span class=line><span class=cl>system:admin
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ oc create secret generic users-htpasswd --from-file htpasswd=users.htpasswd -n openshift-config
</span></span><span class=line><span class=cl>secret/users-htpasswd created
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ oc get secret -n openshift-config
</span></span><span class=line><span class=cl>NAME                                      TYPE                                  DATA   AGE
</span></span><span class=line><span class=cl>builder-dockercfg-r46z8                   kubernetes.io/dockercfg               1      8h
</span></span><span class=line><span class=cl>builder-token-cgvp8                       kubernetes.io/service-account-token   4      8h
</span></span><span class=line><span class=cl>default-dockercfg-8mhbj                   kubernetes.io/dockercfg               1      8h
</span></span><span class=line><span class=cl>default-token-nfc27                       kubernetes.io/service-account-token   4      8h
</span></span><span class=line><span class=cl>deployer-dockercfg-qdwcq                  kubernetes.io/dockercfg               1      8h
</span></span><span class=line><span class=cl>deployer-token-bfplj                      kubernetes.io/service-account-token   4      8h
</span></span><span class=line><span class=cl>etcd-client                               kubernetes.io/tls                     2      8h
</span></span><span class=line><span class=cl>etcd-metric-client                        kubernetes.io/tls                     2      8h
</span></span><span class=line><span class=cl>etcd-metric-signer                        kubernetes.io/tls                     2      8h
</span></span><span class=line><span class=cl>etcd-signer                               kubernetes.io/tls                     2      8h
</span></span><span class=line><span class=cl>initial-service-account-private-key       Opaque                                1      8h
</span></span><span class=line><span class=cl>pull-secret                               kubernetes.io/dockerconfigjson        1      8h
</span></span><span class=line><span class=cl>users-htpasswd                            Opaque                                1      10s
</span></span><span class=line><span class=cl>webhook-authentication-integrated-oauth   Opaque                                1      8h
</span></span></code></pre></td></tr></table></div></div></li><li><p>新增 htpasswd provider</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ocp]$ oc get oauth cluster -o yaml &gt; oauth.yaml
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ vim oauth.yaml 
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ cat oauth.yaml 
</span></span><span class=line><span class=cl>apiVersion: config.openshift.io/v1
</span></span><span class=line><span class=cl>kind: OAuth
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  annotations:
</span></span><span class=line><span class=cl>    include.release.openshift.io/ibm-cloud-managed: &#34;true&#34;
</span></span><span class=line><span class=cl>    include.release.openshift.io/self-managed-high-availability: &#34;true&#34;
</span></span><span class=line><span class=cl>    include.release.openshift.io/single-node-developer: &#34;true&#34;
</span></span><span class=line><span class=cl>    release.openshift.io/create-only: &#34;true&#34;
</span></span><span class=line><span class=cl>  creationTimestamp: &#34;2022-10-11T17:14:37Z&#34;
</span></span><span class=line><span class=cl>  generation: 1
</span></span><span class=line><span class=cl>  name: cluster
</span></span><span class=line><span class=cl>  ownerReferences:
</span></span><span class=line><span class=cl>  - apiVersion: config.openshift.io/v1
</span></span><span class=line><span class=cl>    kind: ClusterVersion
</span></span><span class=line><span class=cl>    name: version
</span></span><span class=line><span class=cl>    uid: d1c0dbf6-000f-4b1e-aa27-1bd8a667afac
</span></span><span class=line><span class=cl>  resourceVersion: &#34;1533&#34;
</span></span><span class=line><span class=cl>  uid: 3e95cfe7-7c02-47eb-8b4e-7f0d61766461
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  identityProviders:
</span></span><span class=line><span class=cl>  - name: htpasswd_provider 
</span></span><span class=line><span class=cl>    mappingMethod: claim 
</span></span><span class=line><span class=cl>    type: HTPasswd
</span></span><span class=line><span class=cl>    htpasswd:
</span></span><span class=line><span class=cl>      fileData:
</span></span><span class=line><span class=cl>        name: users-htpasswd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ oc apply -f oauth.yaml -n openshift-config
</span></span><span class=line><span class=cl>Warning: resource oauths/cluster is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by oc apply. oc apply should only be used on resources created declaratively by either oc create --save-config or oc apply. The missing annotation will be patched automatically.
</span></span><span class=line><span class=cl>oauth.config.openshift.io/cluster configured
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ watch oc get po -n openshift-authentication
</span></span></code></pre></td></tr></table></div></div><p><img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221012094929634.png loading=lazy alt=image-20221012094929634></p></li><li><p>調整角色權限</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>## 將cluster-admin role 加給 admin、ken
</span></span><span class=line><span class=cl>[devop@bastion ~]$ oc adm policy add-cluster-role-to-user cluster-admin admin
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/cluster-admin added: &#34;admin&#34;
</span></span><span class=line><span class=cl>[devop@bastion ~]$ oc adm policy add-cluster-role-to-user cluster-admin ken
</span></span><span class=line><span class=cl>Warning: User &#39;ken&#39; not found
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/cluster-admin added: &#34;ken&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>## 將cluster-view role 加給 view
</span></span><span class=line><span class=cl>[devop@bastion ~]$ oc get clusterroles | grep view
</span></span><span class=line><span class=cl>view                                                            2022-10-11T17:13:19Z
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>[devop@bastion ~]$ oc adm policy add-cluster-role-to-user view view
</span></span><span class=line><span class=cl>Warning: User &#39;view&#39; not found
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/view added: &#34;view&#34;
</span></span></code></pre></td></tr></table></div></div></li><li><p>將預設可建立project的權限刪除，只給admin、ken</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>## 取得 self-provisioner的role
</span></span><span class=line><span class=cl>[devop@bastion ~]$ oc get clusterrolebindings | grep self-provisioner
</span></span><span class=line><span class=cl>self-provisioners                                                           ClusterRole/self-provisioner   8h
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>## 取得 self-provisioners role binding的group
</span></span><span class=line><span class=cl>[devop@bastion ~]$ oc describe clusterrolebindings self-provisioners
</span></span><span class=line><span class=cl>Name:         self-provisioners
</span></span><span class=line><span class=cl>Labels:       &lt;none&gt;
</span></span><span class=line><span class=cl>Annotations:  rbac.authorization.kubernetes.io/autoupdate: true
</span></span><span class=line><span class=cl>Role:
</span></span><span class=line><span class=cl>  Kind:  ClusterRole
</span></span><span class=line><span class=cl>  Name:  self-provisioner
</span></span><span class=line><span class=cl>Subjects:
</span></span><span class=line><span class=cl>  Kind   Name                        Namespace
</span></span><span class=line><span class=cl>  ----   ----                        ---------
</span></span><span class=line><span class=cl>  Group  system:authenticated:oauth  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>##移除 self-provisioner的rolebinding
</span></span><span class=line><span class=cl>[devop@bastion ~]$ oc adm policy remove-cluster-role-from-group self-provisioner system:authenticated:oauth
</span></span><span class=line><span class=cl>Warning: Your changes may get lost whenever a master is restarted, unless you prevent reconciliation of this rolebinding using the following command: oc annotate clusterrolebinding.rbac self-provisioners &#39;rbac.authorization.kubernetes.io/autoupdate=false&#39; --overwrite
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/self-provisioner removed: &#34;system:authenticated:oauth&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>##新增可以建立project的group
</span></span><span class=line><span class=cl>[devop@bastion ~]$ oc adm groups new new-project-group admin ken
</span></span><span class=line><span class=cl>group.user.openshift.io/new-project-group created
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>##將new-project-group再bind上self-provisioner
</span></span><span class=line><span class=cl>[devop@bastion ~]$ oc adm policy add-cluster-role-to-group self-provisioner new-project-group
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/self-provisioner added: &#34;new-project-group&#34;
</span></span></code></pre></td></tr></table></div></div></li><li><p>取得console url</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=p>[</span><span class=n>devop</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=o>$</span> <span class=n>oc</span> <span class=n>get</span> <span class=n>route</span> <span class=o>-</span><span class=n>n</span> <span class=n>openshift</span><span class=o>-</span><span class=n>console</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>        <span class=n>HOST</span><span class=o>/</span><span class=n>PORT</span>                                      <span class=n>PATH</span>   <span class=n>SERVICES</span>    <span class=n>PORT</span>    <span class=n>TERMINATION</span>          <span class=n>WILDCARD</span>
</span></span><span class=line><span class=cl><span class=n>console</span>     <span class=n>console</span><span class=o>-</span><span class=n>openshift</span><span class=o>-</span><span class=n>console</span><span class=o>.</span><span class=n>apps</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span>            <span class=n>console</span>     <span class=n>https</span>   <span class=n>reencrypt</span><span class=o>/</span><span class=n>Redirect</span>   <span class=n>None</span>
</span></span><span class=line><span class=cl><span class=n>downloads</span>   <span class=n>downloads</span><span class=o>-</span><span class=n>openshift</span><span class=o>-</span><span class=n>console</span><span class=o>.</span><span class=n>apps</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span>          <span class=n>downloads</span>   <span class=n>http</span>    <span class=n>edge</span><span class=o>/</span><span class=n>Redirect</span>        <span class=n>None</span>
</span></span><span class=line><span class=cl><span class=c1>### 刪除 kubeadmin</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>devop</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=o>$</span> <span class=n>oc</span> <span class=n>delete</span> <span class=n>secret</span> <span class=n>kubeadmin</span> <span class=o>-</span><span class=n>n</span> <span class=n>kube</span><span class=o>-</span><span class=n>system</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>連線至console <a class=link href=https://console-openshift-console.apps.ocp.ken.lab target=_blank rel=noopener>https://console-openshift-console.apps.ocp.ken.lab</a> 並測試登入</p><p>admin / redhat (cluster-admin)、view / redhat (view only)
<img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221012095225994.png loading=lazy alt=image-20221012095225994></p><p><img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221012095300179.png loading=lazy alt=image-20221012095300179>
<img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221012095339064.png loading=lazy alt=image-20221012095339064></p></li></ol><h4 id=註冊openshift-cluster>註冊openshift cluster</h4><ol><li><p>從console 點到 Administration > Cluster Settings > Manage subscription settings
<img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221012101701215.png loading=lazy alt=image-20221012101701215></p></li><li><p>點選Edit subscription settings</p><p><img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221012101731793.png loading=lazy alt=image-20221012101731793></p></li><li><p>選擇 Self-Support 即可
<img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221012101910450.png loading=lazy alt=image-20221012101910450></p></li><li><p>約 3~5 分鐘即可更新License</p><p><img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221012102253203.png loading=lazy alt=image-20221012102253203>12</p></li></ol><h4 id=設定oc-cli-ca>設定OC CLI CA</h4><p>在openshift-authentication project內取得CA並將CA複製到bastion內</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ocp]$ oc project openshift-authentication
</span></span><span class=line><span class=cl>Now using project &#34;openshift-authentication&#34; on server &#34;https://api.ocp.ken.lab:6443&#34;.
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ oc get po
</span></span><span class=line><span class=cl>NAME                               READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>oauth-openshift-7885f5bd5b-4m5sh   1/1     Running   0          46m
</span></span><span class=line><span class=cl>oauth-openshift-7885f5bd5b-q6vbk   1/1     Running   0          46m
</span></span><span class=line><span class=cl>oauth-openshift-7885f5bd5b-vh4pz   1/1     Running   0          47m
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ oc rsh oauth-openshift-7885f5bd5b-4m5sh cat /run/secrets/kubernetes.io/serviceaccount/ca.crt &gt; ca.crt
</span></span><span class=line><span class=cl>＃＃切換root
</span></span><span class=line><span class=cl>[root@bastion ocp]# cp /home/devop/ocp/ca.crt /etc/pki/ca-trust/source/anchors/
</span></span><span class=line><span class=cl>[root@bastion ocp]# update-ca-trust extract
</span></span><span class=line><span class=cl>## 切換為devop測試登入
</span></span><span class=line><span class=cl>[devop@bastion ~]$ oc login -u admin -p redhat https://api.ocp.ken.lab:6443
</span></span><span class=line><span class=cl>Login successful.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>You have access to 66 projects, the list has been suppressed. You can list all projects with &#39;oc projects&#39;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Using project &#34;openshift-authentication&#34;.
</span></span></code></pre></td></tr></table></div></div><h4 id=拆分infra-node>拆分Infra Node</h4><p><a class=link href=https://docs.openshift.com/container-platform/4.11/post_installation_configuration/cluster-tasks.html#post-install-cluster-tasks target=_blank rel=noopener>https://docs.openshift.com/container-platform/4.11/post_installation_configuration/cluster-tasks.html#post-install-cluster-tasks</a></p><p><a class=link href=https://access.redhat.com/solutions/4601131 target=_blank rel=noopener>https://access.redhat.com/solutions/4601131</a></p><ol><li><p>針對infra node 建立label</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ocp]$ oc label node infra1.ocp.ken.lab node-role.kubernetes.io/infra=&#34;&#34;
</span></span><span class=line><span class=cl>node/infra1.ocp.ken.lab labeled
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ oc label node infra2.ocp.ken.lab node-role.kubernetes.io/infra=&#34;&#34;
</span></span><span class=line><span class=cl>node/infra2.ocp.ken.lab labeled
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ oc label node infra3.ocp.ken.lab node-role.kubernetes.io/infra=&#34;&#34;
</span></span><span class=line><span class=cl>node/infra3.ocp.ken.lab labeled
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ oc get nodes
</span></span><span class=line><span class=cl>NAME                  STATUS   ROLES          AGE     VERSION
</span></span><span class=line><span class=cl>infra1.ocp.ken.lab    Ready    infra,worker   4h1m    v1.24.0+3882f8f
</span></span><span class=line><span class=cl>infra2.ocp.ken.lab    Ready    infra,worker   4h1m    v1.24.0+3882f8f
</span></span><span class=line><span class=cl>infra3.ocp.ken.lab    Ready    infra,worker   3h19m   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>master1.ocp.ken.lab   Ready    master         4h43m   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>master2.ocp.ken.lab   Ready    master         4h42m   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>master3.ocp.ken.lab   Ready    master         4h41m   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>worker1.ocp.ken.lab   Ready    worker         4h17m   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>worker2.ocp.ken.lab   Ready    worker         4h17m   v1.24.0+3882f8f
</span></span></code></pre></td></tr></table></div></div></li><li><p>建立machine config pool &#187; infra.mcp.yaml 並apply到 cluster</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ocp]$ vim infra.mcp.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>apiVersion: machineconfiguration.openshift.io/v1
</span></span><span class=line><span class=cl>kind: MachineConfigPool
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: infra
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  machineConfigSelector:
</span></span><span class=line><span class=cl>    matchExpressions:
</span></span><span class=line><span class=cl>      - {key: machineconfiguration.openshift.io/role, operator: In, values: [worker,infra]} 
</span></span><span class=line><span class=cl>  nodeSelector:
</span></span><span class=line><span class=cl>    matchLabels:
</span></span><span class=line><span class=cl>      node-role.kubernetes.io/infra: &#34;&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ oc apply -f infra.mcp.yaml 
</span></span><span class=line><span class=cl>machineconfigpool.machineconfiguration.openshift.io/infra created
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ oc get  machineconfig
</span></span><span class=line><span class=cl>NAME                                               GENERATEDBYCONTROLLER                      IGNITIONVERSION   AGE
</span></span><span class=line><span class=cl>00-master                                          b7aa1d499f15ce7d211d30a823acf83f47aabbe3   3.2.0             5h12m
</span></span><span class=line><span class=cl>00-worker                                          b7aa1d499f15ce7d211d30a823acf83f47aabbe3   3.2.0             5h12m
</span></span><span class=line><span class=cl>01-master-container-runtime                        b7aa1d499f15ce7d211d30a823acf83f47aabbe3   3.2.0             5h12m
</span></span><span class=line><span class=cl>01-master-kubelet                                  b7aa1d499f15ce7d211d30a823acf83f47aabbe3   3.2.0             5h12m
</span></span><span class=line><span class=cl>01-worker-container-runtime                        b7aa1d499f15ce7d211d30a823acf83f47aabbe3   3.2.0             5h12m
</span></span><span class=line><span class=cl>01-worker-kubelet                                  b7aa1d499f15ce7d211d30a823acf83f47aabbe3   3.2.0             5h12m
</span></span><span class=line><span class=cl>99-master-generated-registries                     b7aa1d499f15ce7d211d30a823acf83f47aabbe3   3.2.0             5h12m
</span></span><span class=line><span class=cl>99-master-ssh                                                                                 3.2.0             5h29m
</span></span><span class=line><span class=cl>99-worker-generated-registries                     b7aa1d499f15ce7d211d30a823acf83f47aabbe3   3.2.0             5h12m
</span></span><span class=line><span class=cl>99-worker-ssh                                                                                 3.2.0             5h29m
</span></span><span class=line><span class=cl>rendered-infra-407eaba9df9f726f52f84b938fce9025    b7aa1d499f15ce7d211d30a823acf83f47aabbe3   3.2.0             3s
</span></span><span class=line><span class=cl>rendered-master-720c11fac56674c6fc876ab6161295aa   b7aa1d499f15ce7d211d30a823acf83f47aabbe3   3.2.0             5h12m
</span></span><span class=line><span class=cl>rendered-worker-407eaba9df9f726f52f84b938fce9025   b7aa1d499f15ce7d211d30a823acf83f47aabbe3   3.2.0             5h12m
</span></span></code></pre></td></tr></table></div></div></li><li><p>建立 machine config &#187; infra.mc.yaml 並apply到cluster</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ocp]$ vim infra.mc.yaml
</span></span><span class=line><span class=cl>apiVersion: machineconfiguration.openshift.io/v1
</span></span><span class=line><span class=cl>kind: MachineConfig
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: 51-infra
</span></span><span class=line><span class=cl>  labels:
</span></span><span class=line><span class=cl>    machineconfiguration.openshift.io/role: infra 
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  config:
</span></span><span class=line><span class=cl>    ignition:
</span></span><span class=line><span class=cl>      version: 3.2.0
</span></span><span class=line><span class=cl>    storage:
</span></span><span class=line><span class=cl>      files:
</span></span><span class=line><span class=cl>      - path: /etc/infratest
</span></span><span class=line><span class=cl>        mode: 0644
</span></span><span class=line><span class=cl>        contents:
</span></span><span class=line><span class=cl>          source: data:,infra
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ oc create -f infra.mc.yaml
</span></span><span class=line><span class=cl>machineconfig.machineconfiguration.openshift.io/51-infra created
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ oc get mcp
</span></span><span class=line><span class=cl>NAME     CONFIG                                             UPDATED   UPDATING   DEGRADED   MACHINECOUNT   READYMACHINECOUNT   UPDATEDMACHINECOUNT   DEGRADEDMACHINECOUNT   AGE
</span></span><span class=line><span class=cl>infra    rendered-infra-407eaba9df9f726f52f84b938fce9025    False     True       False      3              0                   0                     0                      3m17s
</span></span><span class=line><span class=cl>master   rendered-master-720c11fac56674c6fc876ab6161295aa   True      False      False      3              3                   3                     0                      5h25m
</span></span><span class=line><span class=cl>worker   rendered-worker-407eaba9df9f726f52f84b938fce9025   True      False      False      2              2                   2                     0                      5h25m
</span></span></code></pre></td></tr></table></div></div></li><li><p>Add a Taint To Infra Node ，使Infra Node不會被app部署到
#此動作可搬完operator後再做</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>oc adm taint nodes node1 node-role.kubernetes.io/infra:NoSchedule
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ oc adm taint nodes infra3.ocp.ken.lab node-role.kubernetes.io/infra:NoSchedule
</span></span><span class=line><span class=cl>node/infra3.ocp.ken.lab tainted
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ oc adm taint nodes infra2.ocp.ken.lab node-role.kubernetes.io/infra:NoSchedule
</span></span><span class=line><span class=cl>node/infra2.ocp.ken.lab tainted
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ oc adm taint nodes infra1.ocp.ken.lab node-role.kubernetes.io/infra:NoSchedule
</span></span><span class=line><span class=cl>node/infra1.ocp.ken.lab tainted
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ oc describe nodes infra1
</span></span><span class=line><span class=cl>Name:               infra1.ocp.ken.lab
</span></span><span class=line><span class=cl>Roles:              infra,worker
</span></span><span class=line><span class=cl>Labels:             beta.kubernetes.io/arch=amd64
</span></span><span class=line><span class=cl>                    beta.kubernetes.io/os=linux
</span></span><span class=line><span class=cl>                    kubernetes.io/arch=amd64
</span></span><span class=line><span class=cl>                    kubernetes.io/hostname=infra1.ocp.ken.lab
</span></span><span class=line><span class=cl>                    kubernetes.io/os=linux
</span></span><span class=line><span class=cl>                    node-role.kubernetes.io/infra=
</span></span><span class=line><span class=cl>                    node-role.kubernetes.io/worker=
</span></span><span class=line><span class=cl>                    node.openshift.io/os_id=rhcos
</span></span><span class=line><span class=cl>Annotations:        machineconfiguration.openshift.io/controlPlaneTopology: HighlyAvailable
</span></span><span class=line><span class=cl>                    machineconfiguration.openshift.io/currentConfig: rendered-infra-c36859c83539d92df71208a425c004df
</span></span><span class=line><span class=cl>                    machineconfiguration.openshift.io/desiredConfig: rendered-infra-c36859c83539d92df71208a425c004df
</span></span><span class=line><span class=cl>                    machineconfiguration.openshift.io/desiredDrain: uncordon-rendered-infra-c36859c83539d92df71208a425c004df
</span></span><span class=line><span class=cl>                    machineconfiguration.openshift.io/lastAppliedDrain: uncordon-rendered-infra-c36859c83539d92df71208a425c004df
</span></span><span class=line><span class=cl>                    machineconfiguration.openshift.io/reason: 
</span></span><span class=line><span class=cl>                    machineconfiguration.openshift.io/state: Done
</span></span><span class=line><span class=cl>                    volumes.kubernetes.io/controller-managed-attach-detach: true
</span></span><span class=line><span class=cl>CreationTimestamp:  Thu, 13 Oct 2022 11:26:50 +0800
</span></span><span class=line><span class=cl>Taints:             node-role.kubernetes.io/infra:NoSchedule
</span></span><span class=line><span class=cl>Unschedulable:      false
</span></span><span class=line><span class=cl>Lease:
</span></span><span class=line><span class=cl>  HolderIdentity:  infra1.ocp.ken.lab
</span></span><span class=line><span class=cl>  AcquireTime:     &lt;unset&gt;
</span></span><span class=line><span class=cl>  RenewTime:       Thu, 13 Oct 2022 16:23:54 +0800
</span></span></code></pre></td></tr></table></div></div></li><li><p>刪除infra node的 worker label</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ocp]$ oc edit nodes infra1.ocp.ken.lab
</span></span><span class=line><span class=cl>node/infra1.ocp.ken.lab edited
</span></span><span class=line><span class=cl> labels:
</span></span><span class=line><span class=cl>    beta.kubernetes.io/arch: amd64
</span></span><span class=line><span class=cl>    beta.kubernetes.io/os: linux
</span></span><span class=line><span class=cl>    kubernetes.io/arch: amd64
</span></span><span class=line><span class=cl>    kubernetes.io/hostname: infra2.ocp.ken.lab
</span></span><span class=line><span class=cl>    kubernetes.io/os: linux
</span></span><span class=line><span class=cl>    node-role.kubernetes.io/infra: &#34;&#34;
</span></span><span class=line><span class=cl>    node-role.kubernetes.io/worker: &#34;&#34;  &gt;&gt;&gt;&gt; 刪除此行
</span></span><span class=line><span class=cl>    node.openshift.io/os_id: rhcos
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ oc get nodes
</span></span><span class=line><span class=cl>NAME                  STATUS   ROLES    AGE   VERSION
</span></span><span class=line><span class=cl>infra1.ocp.ken.lab    Ready    infra    22h   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>infra2.ocp.ken.lab    Ready    infra    22h   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>infra3.ocp.ken.lab    Ready    infra    22h   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>master1.ocp.ken.lab   Ready    master   23h   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>master2.ocp.ken.lab   Ready    master   23h   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>master3.ocp.ken.lab   Ready    master   23h   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>worker1.ocp.ken.lab   Ready    worker   22h   v1.24.0+3882f8f
</span></span><span class=line><span class=cl>worker2.ocp.ken.lab   Ready    worker   22h   v1.24.0+3882f8f
</span></span></code></pre></td></tr></table></div></div></li></ol><h4 id=operator移動到infra-node>Operator移動到Infra Node</h4><h5 id=router>Router</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>方法一</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>devop</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=o>$</span> <span class=n>oc</span> <span class=n>get</span> <span class=n>ingresscontroller</span> <span class=n>default</span> <span class=o>-</span><span class=n>n</span> <span class=n>openshift</span><span class=o>-</span><span class=n>ingress</span><span class=o>-</span><span class=n>operator</span> <span class=o>-</span><span class=n>o</span> <span class=n>yaml</span> <span class=o>&gt;</span> <span class=n>router</span><span class=o>.</span><span class=n>yaml</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>devop</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=o>$</span> <span class=n>vim</span> <span class=n>router</span><span class=o>.</span><span class=n>yaml</span> 
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>devop</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=o>$</span> <span class=n>cat</span> <span class=n>router</span><span class=o>.</span><span class=n>yaml</span> 
</span></span><span class=line><span class=cl><span class=n>apiVersion</span><span class=p>:</span> <span class=n>operator</span><span class=o>.</span><span class=n>openshift</span><span class=o>.</span><span class=n>io</span><span class=o>/</span><span class=n>v1</span>
</span></span><span class=line><span class=cl><span class=n>kind</span><span class=p>:</span> <span class=n>IngressController</span>
</span></span><span class=line><span class=cl><span class=n>metadata</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=n>creationTimestamp</span><span class=p>:</span> <span class=s2>&#34;2022-10-13T02:54:05Z&#34;</span>
</span></span><span class=line><span class=cl>  <span class=n>finalizers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span> <span class=n>ingresscontroller</span><span class=o>.</span><span class=n>operator</span><span class=o>.</span><span class=n>openshift</span><span class=o>.</span><span class=n>io</span><span class=o>/</span><span class=n>finalizer</span><span class=o>-</span><span class=n>ingresscontroller</span>
</span></span><span class=line><span class=cl>  <span class=n>generation</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=n>name</span><span class=p>:</span> <span class=n>default</span>
</span></span><span class=line><span class=cl>  <span class=n>namespace</span><span class=p>:</span> <span class=n>openshift</span><span class=o>-</span><span class=n>ingress</span><span class=o>-</span><span class=n>operator</span>
</span></span><span class=line><span class=cl>  <span class=n>resourceVersion</span><span class=p>:</span> <span class=s2>&#34;26400&#34;</span>
</span></span><span class=line><span class=cl>  <span class=n>uid</span><span class=p>:</span> <span class=mi>1</span><span class=n>d5c3f18</span><span class=o>-</span><span class=mi>0</span><span class=n>f53</span><span class=o>-</span><span class=mi>4140</span><span class=o>-</span><span class=n>be74</span><span class=o>-</span><span class=mi>35</span><span class=n>df5edf4c8b</span>
</span></span><span class=line><span class=cl><span class=n>spec</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=n>clientTLS</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>clientCA</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=n>name</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>clientCertificatePolicy</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=n>httpCompression</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=n>httpEmptyRequestsPolicy</span><span class=p>:</span> <span class=n>Respond</span>
</span></span><span class=line><span class=cl>  <span class=n>httpErrorCodePages</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=n>replicas</span><span class=p>:</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>  <span class=n>tuningOptions</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=n>unsupportedConfigOverrides</span><span class=p>:</span> <span class=n>null</span>
</span></span><span class=line><span class=cl>  <span class=n>nodePlacement</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>nodeSelector</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=n>matchLabels</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>node</span><span class=o>-</span><span class=n>role</span><span class=o>.</span><span class=n>kubernetes</span><span class=o>.</span><span class=n>io</span><span class=o>/</span><span class=n>infra</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>status</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=n>availableReplicas</span><span class=p>:</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>  <span class=n>conditions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span> <span class=n>lastTransitionTime</span><span class=p>:</span> <span class=s2>&#34;2022-10-13T02:54:13Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>reason</span><span class=p>:</span> <span class=n>Valid</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=s2>&#34;True&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>type</span><span class=p>:</span> <span class=n>Admitted</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span> <span class=n>lastTransitionTime</span><span class=p>:</span> <span class=s2>&#34;2022-10-13T03:12:03Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=s2>&#34;True&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>type</span><span class=p>:</span> <span class=n>PodsScheduled</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span> <span class=n>lastTransitionTime</span><span class=p>:</span> <span class=s2>&#34;2022-10-13T03:11:54Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span><span class=p>:</span> <span class=n>The</span> <span class=n>deployment</span> <span class=n>has</span> <span class=n>Available</span> <span class=n>status</span> <span class=n>condition</span> <span class=n>set</span> <span class=n>to</span> <span class=n>True</span>
</span></span><span class=line><span class=cl>    <span class=n>reason</span><span class=p>:</span> <span class=n>DeploymentAvailable</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=s2>&#34;True&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>type</span><span class=p>:</span> <span class=n>DeploymentAvailable</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span> <span class=n>lastTransitionTime</span><span class=p>:</span> <span class=s2>&#34;2022-10-13T03:11:54Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span><span class=p>:</span> <span class=n>Minimum</span> <span class=n>replicas</span> <span class=n>requirement</span> <span class=n>is</span> <span class=n>met</span>
</span></span><span class=line><span class=cl>    <span class=n>reason</span><span class=p>:</span> <span class=n>DeploymentMinimumReplicasMet</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=s2>&#34;True&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>type</span><span class=p>:</span> <span class=n>DeploymentReplicasMinAvailable</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span> <span class=n>lastTransitionTime</span><span class=p>:</span> <span class=s2>&#34;2022-10-13T03:12:36Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span><span class=p>:</span> <span class=n>All</span> <span class=n>replicas</span> <span class=n>are</span> <span class=n>available</span>
</span></span><span class=line><span class=cl>    <span class=n>reason</span><span class=p>:</span> <span class=n>DeploymentReplicasAvailable</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=s2>&#34;True&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>type</span><span class=p>:</span> <span class=n>DeploymentReplicasAllAvailable</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span> <span class=n>lastTransitionTime</span><span class=p>:</span> <span class=s2>&#34;2022-10-13T02:54:13Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span><span class=p>:</span> <span class=n>The</span> <span class=n>configured</span> <span class=n>endpoint</span> <span class=n>publishing</span> <span class=n>strategy</span> <span class=n>does</span> <span class=ow>not</span> <span class=n>include</span> <span class=n>a</span> <span class=n>managed</span>
</span></span><span class=line><span class=cl>      <span class=nb>load</span> <span class=n>balancer</span>
</span></span><span class=line><span class=cl>    <span class=n>reason</span><span class=p>:</span> <span class=n>EndpointPublishingStrategyExcludesManagedLoadBalancer</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=s2>&#34;False&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>type</span><span class=p>:</span> <span class=n>LoadBalancerManaged</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span> <span class=n>lastTransitionTime</span><span class=p>:</span> <span class=s2>&#34;2022-10-13T02:54:13Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span><span class=p>:</span> <span class=n>No</span> <span class=n>DNS</span> <span class=n>zones</span> <span class=n>are</span> <span class=n>defined</span> <span class=ow>in</span> <span class=n>the</span> <span class=n>cluster</span> <span class=n>dns</span> <span class=n>config</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=n>reason</span><span class=p>:</span> <span class=n>NoDNSZones</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=s2>&#34;False&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>type</span><span class=p>:</span> <span class=n>DNSManaged</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span> <span class=n>lastTransitionTime</span><span class=p>:</span> <span class=s2>&#34;2022-10-13T03:11:54Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=s2>&#34;True&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>type</span><span class=p>:</span> <span class=n>Available</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span> <span class=n>lastTransitionTime</span><span class=p>:</span> <span class=s2>&#34;2022-10-13T02:54:13Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=s2>&#34;False&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>type</span><span class=p>:</span> <span class=n>Progressing</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span> <span class=n>lastTransitionTime</span><span class=p>:</span> <span class=s2>&#34;2022-10-13T03:12:03Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=s2>&#34;False&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>type</span><span class=p>:</span> <span class=n>Degraded</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span> <span class=n>lastTransitionTime</span><span class=p>:</span> <span class=s2>&#34;2022-10-13T02:54:13Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span><span class=p>:</span> <span class=n>IngressController</span> <span class=n>is</span> <span class=n>upgradeable</span><span class=o>.</span>
</span></span><span class=line><span class=cl>    <span class=n>reason</span><span class=p>:</span> <span class=n>Upgradeable</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=s2>&#34;True&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>type</span><span class=p>:</span> <span class=n>Upgradeable</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span> <span class=n>lastTransitionTime</span><span class=p>:</span> <span class=s2>&#34;2022-10-13T03:12:02Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span><span class=p>:</span> <span class=n>Canary</span> <span class=n>route</span> <span class=n>checks</span> <span class=k>for</span> <span class=n>the</span> <span class=n>default</span> <span class=n>ingress</span> <span class=n>controller</span> <span class=n>are</span> <span class=n>successful</span>
</span></span><span class=line><span class=cl>    <span class=n>reason</span><span class=p>:</span> <span class=n>CanaryChecksSucceeding</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=s2>&#34;True&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>type</span><span class=p>:</span> <span class=n>CanaryChecksSucceeding</span>
</span></span><span class=line><span class=cl>  <span class=n>domain</span><span class=p>:</span> <span class=n>apps</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span>
</span></span><span class=line><span class=cl>  <span class=n>endpointPublishingStrategy</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>hostNetwork</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=n>httpPort</span><span class=p>:</span> <span class=mi>80</span>
</span></span><span class=line><span class=cl>      <span class=n>httpsPort</span><span class=p>:</span> <span class=mi>443</span>
</span></span><span class=line><span class=cl>      <span class=n>protocol</span><span class=p>:</span> <span class=n>TCP</span>
</span></span><span class=line><span class=cl>      <span class=n>statsPort</span><span class=p>:</span> <span class=mi>1936</span>
</span></span><span class=line><span class=cl>    <span class=n>type</span><span class=p>:</span> <span class=n>HostNetwork</span>
</span></span><span class=line><span class=cl>  <span class=n>observedGeneration</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=n>selector</span><span class=p>:</span> <span class=n>ingresscontroller</span><span class=o>.</span><span class=n>operator</span><span class=o>.</span><span class=n>openshift</span><span class=o>.</span><span class=n>io</span><span class=o>/</span><span class=n>deployment</span><span class=o>-</span><span class=n>ingresscontroller</span><span class=o>=</span><span class=n>default</span>
</span></span><span class=line><span class=cl>  <span class=n>tlsProfile</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>ciphers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=o>-</span> <span class=n>ECDHE</span><span class=o>-</span><span class=n>ECDSA</span><span class=o>-</span><span class=n>AES128</span><span class=o>-</span><span class=n>GCM</span><span class=o>-</span><span class=n>SHA256</span>
</span></span><span class=line><span class=cl>    <span class=o>-</span> <span class=n>ECDHE</span><span class=o>-</span><span class=n>RSA</span><span class=o>-</span><span class=n>AES128</span><span class=o>-</span><span class=n>GCM</span><span class=o>-</span><span class=n>SHA256</span>
</span></span><span class=line><span class=cl>    <span class=o>-</span> <span class=n>ECDHE</span><span class=o>-</span><span class=n>ECDSA</span><span class=o>-</span><span class=n>AES256</span><span class=o>-</span><span class=n>GCM</span><span class=o>-</span><span class=n>SHA384</span>
</span></span><span class=line><span class=cl>    <span class=o>-</span> <span class=n>ECDHE</span><span class=o>-</span><span class=n>RSA</span><span class=o>-</span><span class=n>AES256</span><span class=o>-</span><span class=n>GCM</span><span class=o>-</span><span class=n>SHA384</span>
</span></span><span class=line><span class=cl>    <span class=o>-</span> <span class=n>ECDHE</span><span class=o>-</span><span class=n>ECDSA</span><span class=o>-</span><span class=n>CHACHA20</span><span class=o>-</span><span class=n>POLY1305</span>
</span></span><span class=line><span class=cl>    <span class=o>-</span> <span class=n>ECDHE</span><span class=o>-</span><span class=n>RSA</span><span class=o>-</span><span class=n>CHACHA20</span><span class=o>-</span><span class=n>POLY1305</span>
</span></span><span class=line><span class=cl>    <span class=o>-</span> <span class=n>DHE</span><span class=o>-</span><span class=n>RSA</span><span class=o>-</span><span class=n>AES128</span><span class=o>-</span><span class=n>GCM</span><span class=o>-</span><span class=n>SHA256</span>
</span></span><span class=line><span class=cl>    <span class=o>-</span> <span class=n>DHE</span><span class=o>-</span><span class=n>RSA</span><span class=o>-</span><span class=n>AES256</span><span class=o>-</span><span class=n>GCM</span><span class=o>-</span><span class=n>SHA384</span>
</span></span><span class=line><span class=cl>    <span class=o>-</span> <span class=n>TLS_AES_128_GCM_SHA256</span>
</span></span><span class=line><span class=cl>    <span class=o>-</span> <span class=n>TLS_AES_256_GCM_SHA384</span>
</span></span><span class=line><span class=cl>    <span class=o>-</span> <span class=n>TLS_CHACHA20_POLY1305_SHA256</span>
</span></span><span class=line><span class=cl>    <span class=n>minTLSVersion</span><span class=p>:</span> <span class=n>VersionTLS12</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>devop</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=o>$</span> <span class=n>oc</span> <span class=n>apply</span> <span class=o>-</span><span class=n>f</span> <span class=n>router</span><span class=o>.</span><span class=n>yaml</span> <span class=o>-</span><span class=n>n</span> <span class=n>openshift</span><span class=o>-</span><span class=n>ingress</span><span class=o>-</span><span class=n>operator</span>
</span></span><span class=line><span class=cl><span class=n>Warning</span><span class=p>:</span> <span class=n>resource</span> <span class=n>ingresscontrollers</span><span class=o>/</span><span class=n>default</span> <span class=n>is</span> <span class=n>missing</span> <span class=n>the</span> <span class=n>kubectl</span><span class=o>.</span><span class=n>kubernetes</span><span class=o>.</span><span class=n>io</span><span class=o>/</span><span class=n>last</span><span class=o>-</span><span class=n>applied</span><span class=o>-</span><span class=n>configuration</span> <span class=n>annotation</span> <span class=n>which</span> <span class=n>is</span> <span class=n>required</span> <span class=n>by</span> <span class=n>oc</span> <span class=n>apply</span><span class=o>.</span> <span class=n>oc</span> <span class=n>apply</span> <span class=n>should</span> <span class=n>only</span> <span class=n>be</span> <span class=n>used</span> <span class=n>on</span> <span class=n>resources</span> <span class=n>created</span> <span class=n>declaratively</span> <span class=n>by</span> <span class=n>either</span> <span class=n>oc</span> <span class=n>create</span> <span class=o>--</span><span class=n>save</span><span class=o>-</span><span class=n>config</span> <span class=ow>or</span> <span class=n>oc</span> <span class=n>apply</span><span class=o>.</span> <span class=n>The</span> <span class=n>missing</span> <span class=n>annotation</span> <span class=n>will</span> <span class=n>be</span> <span class=n>patched</span> <span class=n>automatically</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>ingresscontroller</span><span class=o>.</span><span class=n>operator</span><span class=o>.</span><span class=n>openshift</span><span class=o>.</span><span class=n>io</span><span class=o>/</span><span class=n>default</span> <span class=n>configured</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>方法二</span> <span class=err>（官方建議）</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>devop</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=o>$</span> <span class=n>oc</span> <span class=n>edit</span> <span class=n>ingresscontroller</span> <span class=o>-</span><span class=n>n</span> <span class=n>openshift</span><span class=o>-</span><span class=n>ingress</span><span class=o>-</span><span class=n>operator</span>
</span></span><span class=line><span class=cl><span class=c1>####加入下方 matchLabels</span>
</span></span><span class=line><span class=cl>  <span class=n>spec</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>nodePlacement</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=n>nodeSelector</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>matchLabels</span><span class=p>:</span>
</span></span><span class=line><span class=cl>          <span class=n>node</span><span class=o>-</span><span class=n>role</span><span class=o>.</span><span class=n>kubernetes</span><span class=o>.</span><span class=n>io</span><span class=o>/</span><span class=n>infra</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>#### 確認ingress-operator已分配到Infra Node          </span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>devop</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=o>$</span> <span class=n>oc</span> <span class=n>get</span> <span class=n>pod</span> <span class=o>-</span><span class=n>n</span> <span class=n>openshift</span><span class=o>-</span><span class=n>ingress</span> <span class=o>-</span><span class=n>o</span> <span class=n>wide</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>                              <span class=n>READY</span>   <span class=n>STATUS</span>        <span class=n>RESTARTS</span>   <span class=n>AGE</span>     <span class=ne>IP</span>              <span class=n>NODE</span>                  <span class=n>NOMINATED</span> <span class=n>NODE</span>   <span class=n>READINESS</span> <span class=n>GATES</span>
</span></span><span class=line><span class=cl><span class=n>router</span><span class=o>-</span><span class=n>default</span><span class=o>-</span><span class=mi>5</span><span class=n>c67b4db8b</span><span class=o>-</span><span class=mi>75</span><span class=n>pjr</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=n>Running</span>       <span class=mi>0</span>          <span class=mi>5</span><span class=n>h44m</span>   <span class=mf>192.168</span><span class=o>.</span><span class=mf>33.26</span>   <span class=n>worker1</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span>   <span class=o>&lt;</span><span class=n>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=n>none</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>router</span><span class=o>-</span><span class=n>default</span><span class=o>-</span><span class=mi>5</span><span class=n>c67b4db8b</span><span class=o>-</span><span class=n>glwcq</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=n>Terminating</span>   <span class=mi>0</span>          <span class=mi>5</span><span class=n>h44m</span>   <span class=mf>192.168</span><span class=o>.</span><span class=mf>33.27</span>   <span class=n>worker2</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span>   <span class=o>&lt;</span><span class=n>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=n>none</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>router</span><span class=o>-</span><span class=n>default</span><span class=o>-</span><span class=mi>7</span><span class=n>c4cc569cc</span><span class=o>-</span><span class=mi>85</span><span class=n>sbm</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=n>Pending</span>       <span class=mi>0</span>          <span class=mi>28</span><span class=n>s</span>     <span class=o>&lt;</span><span class=n>none</span><span class=o>&gt;</span>          <span class=o>&lt;</span><span class=n>none</span><span class=o>&gt;</span>                <span class=o>&lt;</span><span class=n>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=n>none</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>devop</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=o>$</span> <span class=n>oc</span> <span class=n>get</span> <span class=n>pod</span> <span class=o>-</span><span class=n>n</span> <span class=n>openshift</span><span class=o>-</span><span class=n>ingress</span> <span class=o>-</span><span class=n>o</span> <span class=n>wide</span>
</span></span><span class=line><span class=cl><span class=n>NAME</span>                              <span class=n>READY</span>   <span class=n>STATUS</span>    <span class=n>RESTARTS</span>   <span class=n>AGE</span>   <span class=ne>IP</span>              <span class=n>NODE</span>                 <span class=n>NOMINATED</span> <span class=n>NODE</span>   <span class=n>READINESS</span> <span class=n>GATES</span>
</span></span><span class=line><span class=cl><span class=n>router</span><span class=o>-</span><span class=n>default</span><span class=o>-</span><span class=mi>7</span><span class=n>c4cc569cc</span><span class=o>-</span><span class=mi>86</span><span class=n>ggk</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=n>Running</span>   <span class=mi>0</span>          <span class=mi>18</span><span class=n>m</span>   <span class=mf>192.168</span><span class=o>.</span><span class=mf>33.32</span>   <span class=n>infra2</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span>   <span class=o>&lt;</span><span class=n>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=n>none</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>router</span><span class=o>-</span><span class=n>default</span><span class=o>-</span><span class=mi>7</span><span class=n>c4cc569cc</span><span class=o>-</span><span class=mi>97</span><span class=n>mlv</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=n>Running</span>   <span class=mi>0</span>          <span class=mi>49</span><span class=n>m</span>   <span class=mf>192.168</span><span class=o>.</span><span class=mf>33.31</span>   <span class=n>infra1</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span>   <span class=o>&lt;</span><span class=n>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=n>none</span><span class=o>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h5 id=registry>Registry</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ocp]$ oc get configs.imageregistry.operator.openshift.io/cluster -o yaml
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ oc edit configs.imageregistry.operator.openshift.io/cluster
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  logLevel: Normal
</span></span><span class=line><span class=cl>  managementState: Removed
</span></span><span class=line><span class=cl>  observedConfig: null
</span></span><span class=line><span class=cl>  operatorLogLevel: Normal
</span></span><span class=line><span class=cl>  proxy: {}
</span></span><span class=line><span class=cl>  replicas: 1
</span></span><span class=line><span class=cl>  requests:
</span></span><span class=line><span class=cl>    read:
</span></span><span class=line><span class=cl>      maxWaitInQueue: 0s
</span></span><span class=line><span class=cl>    write:
</span></span><span class=line><span class=cl>      maxWaitInQueue: 0s
</span></span><span class=line><span class=cl>  rolloutStrategy: RollingUpdate
</span></span><span class=line><span class=cl>  storage: {}
</span></span><span class=line><span class=cl>  unsupportedConfigOverrides: null
</span></span><span class=line><span class=cl>  nodeSelector:
</span></span><span class=line><span class=cl>    node-role.kubernetes.io/infra: &#34;&#34;
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ oc get pods -o wide -n openshift-image-registry
</span></span><span class=line><span class=cl>NAME                                               READY   STATUS      RESTARTS   AGE    IP              NODE                  NOMINATED NODE   READINESS GATES
</span></span><span class=line><span class=cl>cluster-image-registry-operator-598c5664bd-qz8cs   1/1     Running     0          23h    10.128.0.34     master1.ocp.ken.lab   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>image-pruner-27761760-jh4fz                        0/1     Completed   0          101m   10.131.2.8      infra3.ocp.ken.lab    &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>node-ca-cdt8j                                      1/1     Running     0          22h    192.168.33.23   master1.ocp.ken.lab   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>node-ca-dpzzb                                      1/1     Running     1          22h    192.168.33.32   infra2.ocp.ken.lab    &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>node-ca-hfv8c                                      1/1     Running     1          21h    192.168.33.33   infra3.ocp.ken.lab    &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>node-ca-hjptk                                      1/1     Running     1          22h    192.168.33.31   infra1.ocp.ken.lab    &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>node-ca-k2qhs                                      1/1     Running     0          22h    192.168.33.24   master2.ocp.ken.lab   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>node-ca-lgkg8                                      1/1     Running     0          22h    192.168.33.27   worker2.ocp.ken.lab   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>node-ca-wqpn8                                      1/1     Running     0          22h    192.168.33.25   master3.ocp.ken.lab   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>node-ca-xt8dg                                      1/1     Running     0          22h    192.168.33.26   worker1.ocp.ken.lab   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></td></tr></table></div></div><h5 id=monitoring>Monitoring</h5><p>Include: Prometheus, Thanos Querier, and Alertmanager
先建立ConfigMap cluster-monitor-config.yaml</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=p>[</span><span class=n>devop</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=o>$</span> <span class=n>oc</span> <span class=n>get</span> <span class=n>pod</span> <span class=o>-</span><span class=n>n</span> <span class=n>openshift</span><span class=o>-</span><span class=n>monitoring</span> <span class=o>-</span><span class=n>o</span> <span class=n>wide</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>devop</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=o>$</span> <span class=n>vim</span> <span class=n>cluster</span><span class=o>-</span><span class=n>monitoring</span><span class=o>-</span><span class=n>config</span><span class=o>.</span><span class=n>yaml</span>
</span></span><span class=line><span class=cl><span class=n>apiVersion</span><span class=p>:</span> <span class=n>v1</span>
</span></span><span class=line><span class=cl><span class=n>kind</span><span class=p>:</span> <span class=n>ConfigMap</span>
</span></span><span class=line><span class=cl><span class=n>metadata</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=n>name</span><span class=p>:</span> <span class=n>cluster</span><span class=o>-</span><span class=n>monitoring</span><span class=o>-</span><span class=n>config</span>
</span></span><span class=line><span class=cl>  <span class=n>namespace</span><span class=p>:</span> <span class=n>openshift</span><span class=o>-</span><span class=n>monitoring</span>
</span></span><span class=line><span class=cl><span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=n>config</span><span class=o>.</span><span class=n>yaml</span><span class=p>:</span> <span class=o>|+</span>
</span></span><span class=line><span class=cl>    <span class=n>alertmanagerMain</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=n>nodeSelector</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>node</span><span class=o>-</span><span class=n>role</span><span class=o>.</span><span class=n>kubernetes</span><span class=o>.</span><span class=n>io</span><span class=o>/</span><span class=n>infra</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>prometheusK8s</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=n>nodeSelector</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>node</span><span class=o>-</span><span class=n>role</span><span class=o>.</span><span class=n>kubernetes</span><span class=o>.</span><span class=n>io</span><span class=o>/</span><span class=n>infra</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>prometheusOperator</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=n>nodeSelector</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>node</span><span class=o>-</span><span class=n>role</span><span class=o>.</span><span class=n>kubernetes</span><span class=o>.</span><span class=n>io</span><span class=o>/</span><span class=n>infra</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>k8sPrometheusAdapter</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=n>nodeSelector</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>node</span><span class=o>-</span><span class=n>role</span><span class=o>.</span><span class=n>kubernetes</span><span class=o>.</span><span class=n>io</span><span class=o>/</span><span class=n>infra</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>kubeStateMetrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=n>nodeSelector</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>node</span><span class=o>-</span><span class=n>role</span><span class=o>.</span><span class=n>kubernetes</span><span class=o>.</span><span class=n>io</span><span class=o>/</span><span class=n>infra</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>telemeterClient</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=n>nodeSelector</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>node</span><span class=o>-</span><span class=n>role</span><span class=o>.</span><span class=n>kubernetes</span><span class=o>.</span><span class=n>io</span><span class=o>/</span><span class=n>infra</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>openshiftStateMetrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=n>nodeSelector</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>node</span><span class=o>-</span><span class=n>role</span><span class=o>.</span><span class=n>kubernetes</span><span class=o>.</span><span class=n>io</span><span class=o>/</span><span class=n>infra</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>thanosQuerier</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=n>nodeSelector</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>node</span><span class=o>-</span><span class=n>role</span><span class=o>.</span><span class=n>kubernetes</span><span class=o>.</span><span class=n>io</span><span class=o>/</span><span class=n>infra</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl> <span class=o>---</span> <span class=err>建立此</span><span class=n>ConfigMap</span>
</span></span><span class=line><span class=cl> <span class=p>[</span><span class=n>devop</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=o>$</span> <span class=n>oc</span> <span class=n>create</span> <span class=o>-</span><span class=n>f</span> <span class=n>cluster</span><span class=o>-</span><span class=n>monitoring</span><span class=o>-</span><span class=n>config</span><span class=o>.</span><span class=n>yaml</span> 
</span></span><span class=line><span class=cl><span class=n>configmap</span><span class=o>/</span><span class=n>cluster</span><span class=o>-</span><span class=n>monitoring</span><span class=o>-</span><span class=n>config</span> <span class=n>created</span>
</span></span><span class=line><span class=cl><span class=o>---</span> <span class=err>查看</span><span class=n>pod</span> <span class=err>是否都移轉至</span><span class=n>infra</span> <span class=n>node</span><span class=err>，若未移轉則</span><span class=n>delete該pod</span><span class=err>，使其重新部署</span>
</span></span><span class=line><span class=cl><span class=n>node</span><span class=o>-</span><span class=n>exporter</span><span class=err>、</span><span class=n>cluster</span><span class=o>-</span><span class=n>monitoring</span><span class=o>-</span><span class=n>operator不用刪除</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>devop</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=o>$</span> <span class=n>watch</span> <span class=n>oc</span> <span class=n>get</span> <span class=n>pod</span> <span class=o>-</span><span class=n>n</span> <span class=n>openshift</span><span class=o>-</span><span class=n>monitoring</span> <span class=o>-</span><span class=n>o</span> <span class=n>wide</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>devop</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=o>$</span> <span class=n>oc</span> <span class=n>get</span> <span class=n>pod</span> <span class=o>-</span><span class=n>n</span> <span class=n>openshift</span><span class=o>-</span><span class=n>monitoring</span> <span class=o>-</span><span class=n>o</span> <span class=n>wide</span> <span class=o>|</span><span class=n>grep</span> <span class=n>worker</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>devop</span><span class=err>@</span><span class=n>bastion</span> <span class=n>ocp</span><span class=p>]</span><span class=o>$</span> <span class=n>oc</span> <span class=n>get</span> <span class=n>pod</span> <span class=o>-</span><span class=n>n</span> <span class=n>openshift</span><span class=o>-</span><span class=n>monitoring</span> <span class=o>-</span><span class=n>o</span> <span class=n>wide</span> <span class=o>|</span><span class=n>grep</span> <span class=n>master</span>
</span></span><span class=line><span class=cl><span class=n>cluster</span><span class=o>-</span><span class=n>monitoring</span><span class=o>-</span><span class=n>operator</span><span class=o>-</span><span class=mi>574</span><span class=n>c5f5b7b</span><span class=o>-</span><span class=n>sg6nh</span>            <span class=mi>2</span><span class=o>/</span><span class=mi>2</span>     <span class=n>Running</span>   <span class=mi>0</span>          <span class=mi>23</span><span class=n>h</span>     <span class=mf>10.128</span><span class=o>.</span><span class=mf>0.33</span>     <span class=n>master1</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span>   <span class=o>&lt;</span><span class=n>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=n>none</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>node</span><span class=o>-</span><span class=n>exporter</span><span class=o>-</span><span class=n>hr22c</span>                                     <span class=mi>2</span><span class=o>/</span><span class=mi>2</span>     <span class=n>Running</span>   <span class=mi>0</span>          <span class=mi>22</span><span class=n>h</span>     <span class=mf>192.168</span><span class=o>.</span><span class=mf>33.23</span>   <span class=n>master1</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span>   <span class=o>&lt;</span><span class=n>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=n>none</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>node</span><span class=o>-</span><span class=n>exporter</span><span class=o>-</span><span class=n>jnqkc</span>                                     <span class=mi>2</span><span class=o>/</span><span class=mi>2</span>     <span class=n>Running</span>   <span class=mi>0</span>          <span class=mi>22</span><span class=n>h</span>     <span class=mf>192.168</span><span class=o>.</span><span class=mf>33.25</span>   <span class=n>master3</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span>   <span class=o>&lt;</span><span class=n>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=n>none</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>node</span><span class=o>-</span><span class=n>exporter</span><span class=o>-</span><span class=n>lzk6n</span>                                     <span class=mi>2</span><span class=o>/</span><span class=mi>2</span>     <span class=n>Running</span>   <span class=mi>0</span>          <span class=mi>22</span><span class=n>h</span>     <span class=mf>192.168</span><span class=o>.</span><span class=mf>33.24</span>   <span class=n>master2</span><span class=o>.</span><span class=n>ocp</span><span class=o>.</span><span class=n>ken</span><span class=o>.</span><span class=n>lab</span>   <span class=o>&lt;</span><span class=n>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=n>none</span><span class=o>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=問題排除>問題排除</h2><h3 id=調整>調整</h3><h5 id=operatorhub-blank>OperatorHub Blank</h5><h6 id=畫面空白>畫面空白</h6><p><img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221012115352528.png loading=lazy alt=image-20221012115352528></p><h6 id=在install-configyaml>在install-config.yaml</h6><p>裡面就要加入 marketplace的參數，sample是用來起template、image stream的operator
<img src=https://kenkenny.synology.me:5543/images/2023/09/image-20221012133723224.png loading=lazy alt=image-20221012133723224></p><h6 id=install-configyaml>install-config.yaml</h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[devop@bastion ocp]$ vim install-config.yaml 
</span></span><span class=line><span class=cl>[devop@bastion ocp]$ cat install-config.yaml 
</span></span><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>baseDomain: ken.lab 
</span></span><span class=line><span class=cl>compute: 
</span></span><span class=line><span class=cl>- hyperthreading: Enabled 
</span></span><span class=line><span class=cl>  name: worker
</span></span><span class=line><span class=cl>  replicas: 2 
</span></span><span class=line><span class=cl>controlPlane: 
</span></span><span class=line><span class=cl>  hyperthreading: Enabled 
</span></span><span class=line><span class=cl>  name: master
</span></span><span class=line><span class=cl>  replicas: 3 
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: ocp
</span></span><span class=line><span class=cl>networking:
</span></span><span class=line><span class=cl>  clusterNetwork:
</span></span><span class=line><span class=cl>  - cidr: 10.128.0.0/14 
</span></span><span class=line><span class=cl>    hostPrefix: 23 
</span></span><span class=line><span class=cl>  networkType: OpenShiftSDN
</span></span><span class=line><span class=cl>  serviceNetwork: 
</span></span><span class=line><span class=cl>  - 172.30.0.0/16
</span></span><span class=line><span class=cl>platform:
</span></span><span class=line><span class=cl>  none: {} 
</span></span><span class=line><span class=cl>fips: false 
</span></span><span class=line><span class=cl>pullSecret: &#39;{&#34;auths&#34;:{&#34;cloud.openshift.com&#34;:{&#34;auth&#34;:&#34;b3BlbnNoaWZ0LXJlbGVhc2UtZGV2K29jbV9hY2Nlc3NfMzEwNjVjNmVmMTk5NDZmNWEwNmUzZmI4MTVmNzk2OTE6NEJRVk1FVk9CTDRZQVRBT0pONEhQVkIyUExFQTdKNDE3WExFU1IzVDk3NU1YUTJXWE9FSjBNTVk0MzFQQk9RUA==&#34;,&#34;email&#34;:&#34;ken.wang@infotech.com.tw&#34;},&#34;quay.io&#34;:{&#34;auth&#34;:&#34;b3BlbnNoaWZ0LXJlbGVhc2UtZGV2K29jbV9hY2Nlc3NfMzEwNjVjNmVmMTk5NDZmNWEwNmUzZmI4MTVmNzk2OTE6NEJRVk1FVk9CTDRZQVRBT0pONEhQVkIyUExFQTdKNDE3WExFU1IzVDk3NU1YUTJXWE9FSjBNTVk0MzFQQk9RUA==&#34;,&#34;email&#34;:&#34;ken.wang@infotech.com.tw&#34;},&#34;registry.connect.redhat.com&#34;:{&#34;auth&#34;:&#34;fHVoYy1wb29sLTc5MzgwY2YyLTUxNTEtNGRiNi04YjA3LTRiNzQ4NDcxNWE2NDpleUpoYkdjaU9pSlNVelV4TWlKOS5leUp6ZFdJaU9pSmxOak5rWVdWbU1tSXlaRFEwTVdKaVlUTXpObVUwTkdGbVl6WmtPVEUwWVNKOS5RMlp6Q1JaWWltVDIxM2dpYU9CRWtNWEVkYUtjbnc4WHN1bTY3VEVOdjEyRjBjQUgyNWNZMVdWTjZNUEY2R21CNjh3TmF4TnoxRHVpVnBtY0ZKM2JZTW0yNVVzZGJxeFc4cEd1dGszSzF5NlNUWk9VejlkU0V4UGg4aUxha05qSEQ4Tml6emNmM1lUQjRNUXdhYTVFSG1PMXVTUERUZFRBTXFYS3FFa2gwRXpHOUpKZTlUMnM4bVJXWkVIbndoZW84cktncVZuV1VCeGhqTldFNElfWG1JZnBPRl91akpFNHdXNzRJWjd5UmdoUGExQVVwS3BsY0NJQ2ZGdGtaS29WUTFwNTBzUzNabkxWYjd6ZHdXR21WcXVsNUFoZUNiSHNoNEtpSjFnYXRSbkwtMG92THZoNGdseUZqd0c0Z3lMMEdyS1ItbU5WMFZYc01mVzJDNXNVaXBzVmhKcmhmY01vQjRNSDRDbjZKcjJXS2plbEdqSVdHQzBUV1BBNlZQZDBmc0lyLTRCY2RBdUFmcm5SaWpGM3d0Mng3RFdXQ1RScFVPbUVMY3U5bDR6Wm5uZkVSejNMd01rNmhCWTFyYXV1TGhCWXJraFlzQURqWEl3bGxPTkwyc01GMUU2OVNIVG1vV0tvNU5fdHdoWE5fX1BtT1ozMzc5ZVNDVGdnTFNZd3hyR1VwS3FXRDFva3JWZlRIWmNlcTk4WHQ2QjFtZHIxcmxLV2RiRmhsRDQ3Q1pldEhrNW1xQUlianp1UzlONENJWllhd0lIZE5LWVotN2tRNFQyUFg4QWdadHFNdHdjY2c0bWx3ME40c09LbWVZN2Q2bGw0bXpXV201bVo0aktTeHdpYmJ3STEwOFcxWVFlSlQ4QW9WZFlkc09YWkdWc3ZxZVVZOU9qbzR2RQ==&#34;,&#34;email&#34;:&#34;ken.wang@infotech.com.tw&#34;},&#34;registry.redhat.io&#34;:{&#34;auth&#34;:&#34;fHVoYy1wb29sLTc5MzgwY2YyLTUxNTEtNGRiNi04YjA3LTRiNzQ4NDcxNWE2NDpleUpoYkdjaU9pSlNVelV4TWlKOS5leUp6ZFdJaU9pSmxOak5rWVdWbU1tSXlaRFEwTVdKaVlUTXpObVUwTkdGbVl6WmtPVEUwWVNKOS5RMlp6Q1JaWWltVDIxM2dpYU9CRWtNWEVkYUtjbnc4WHN1bTY3VEVOdjEyRjBjQUgyNWNZMVdWTjZNUEY2R21CNjh3TmF4TnoxRHVpVnBtY0ZKM2JZTW0yNVVzZGJxeFc4cEd1dGszSzF5NlNUWk9VejlkU0V4UGg4aUxha05qSEQ4Tml6emNmM1lUQjRNUXdhYTVFSG1PMXVTUERUZFRBTXFYS3FFa2gwRXpHOUpKZTlUMnM4bVJXWkVIbndoZW84cktncVZuV1VCeGhqTldFNElfWG1JZnBPRl91akpFNHdXNzRJWjd5UmdoUGExQVVwS3BsY0NJQ2ZGdGtaS29WUTFwNTBzUzNabkxWYjd6ZHdXR21WcXVsNUFoZUNiSHNoNEtpSjFnYXRSbkwtMG92THZoNGdseUZqd0c0Z3lMMEdyS1ItbU5WMFZYc01mVzJDNXNVaXBzVmhKcmhmY01vQjRNSDRDbjZKcjJXS2plbEdqSVdHQzBUV1BBNlZQZDBmc0lyLTRCY2RBdUFmcm5SaWpGM3d0Mng3RFdXQ1RScFVPbUVMY3U5bDR6Wm5uZkVSejNMd01rNmhCWTFyYXV1TGhCWXJraFlzQURqWEl3bGxPTkwyc01GMUU2OVNIVG1vV0tvNU5fdHdoWE5fX1BtT1ozMzc5ZVNDVGdnTFNZd3hyR1VwS3FXRDFva3JWZlRIWmNlcTk4WHQ2QjFtZHIxcmxLV2RiRmhsRDQ3Q1pldEhrNW1xQUlianp1UzlONENJWllhd0lIZE5LWVotN2tRNFQyUFg4QWdadHFNdHdjY2c0bWx3ME40c09LbWVZN2Q2bGw0bXpXV201bVo0aktTeHdpYmJ3STEwOFcxWVFlSlQ4QW9WZFlkc09YWkdWc3ZxZVVZOU9qbzR2RQ==&#34;,&#34;email&#34;:&#34;ken.wang@infotech.com.tw&#34;}}}&#39; 
</span></span><span class=line><span class=cl>sshKey: &#39;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIN1Z2jXmGnPWGAVrtltN9A2q5D8QtJlRvhvdB2QXoZG devop@bastion.ocp.ken.lab&#39; 
</span></span><span class=line><span class=cl>capabilities:
</span></span><span class=line><span class=cl>  baselineCapabilitySet: None
</span></span><span class=line><span class=cl>  additionalEnabledCapabilities:
</span></span><span class=line><span class=cl>  - marketplace
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-tags><a href=/tags/openshift/>Openshift</a>
<a href=/tags/redhat/>Redhat</a>
<a href=/tags/kubernetes/>Kubernetes</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相關文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/ocp-4.11.9_on_vsphereupi/><div class=article-details><h2 class=article-title>OCP-4.11.9_on_vSphere(UPI)</h2></div></a></article><article><a href=/p/hello-world/><div class=article-details><h2 class=article-title>Hello World</h2></div></a></article><article><a href=/p/ocp-4.16.3_on_nutanixipi/><div class=article-details><h2 class=article-title>OCP-4.16.3_on_Nutanix(IPI)</h2></div></a></article><article><a href=/p/nutanix_ndk-v1.0.0_on_ocp-4.13/><div class=article-details><h2 class=article-title>Nutanix_NDK-v1.0.0_On_OCP-4.13</h2></div></a></article><article><a href=/p/ocp-4.12.45_on_nutanixipi/><div class=article-details><h2 class=article-title>OCP-4.12.45_on_Nutanix(IPI)</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//wangken0129.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2023 -
2025 Ken's blog</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 建立<br>主題 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 設計</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>